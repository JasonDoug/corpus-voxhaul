"use strict";var we=Object.create;var D=Object.defineProperty;var ve=Object.getOwnPropertyDescriptor;var Ee=Object.getOwnPropertyNames;var Te=Object.getPrototypeOf,Ae=Object.prototype.hasOwnProperty;var $=(e,t)=>()=>(e&&(t=e(e=0)),t);var H=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),B=(e,t)=>{for(var r in t)D(e,r,{get:t[r],enumerable:!0})},z=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ee(t))!Ae.call(e,o)&&o!==r&&D(e,o,{get:()=>t[o],enumerable:!(n=ve(t,o))||n.enumerable});return e};var F=(e,t,r)=>(r=e!=null?we(Te(e)):{},z(t||!e||!e.__esModule?D(r,"default",{value:e,enumerable:!0}):r,e)),R=e=>z(D({},"__esModule",{value:!0}),e);var Se,K,a,E=$(()=>{"use strict";Se=[/password/i,/secret/i,/token/i,/apikey/i,/api[_-]?key/i,/authorization/i,/auth/i,/credential/i,/private[_-]?key/i,/access[_-]?key/i],K=class e{correlationId;serviceName;functionName;minLogLevel;constructor(){let t=process.env.LOG_LEVEL?.toUpperCase();this.minLogLevel=t||"INFO"}setCorrelationId(t){this.correlationId=t}getCorrelationId(){return this.correlationId}setServiceName(t){this.serviceName=t}setFunctionName(t){this.functionName=t}redactSensitiveData(t){if(t==null||typeof t=="string")return t;if(Array.isArray(t))return t.map(r=>this.redactSensitiveData(r));if(typeof t=="object"){let r={};for(let[n,o]of Object.entries(t))Se.some(i=>i.test(n))?r[n]="[REDACTED]":typeof o=="object"&&o!==null?r[n]=this.redactSensitiveData(o):r[n]=o;return r}return t}shouldLog(t){let r=["ERROR","WARN","INFO","DEBUG"],n=r.indexOf(t),o=r.indexOf(this.minLogLevel);return n<=o}log(t,r,n){if(!this.shouldLog(t))return;let o={level:t,message:r,timestamp:new Date().toISOString(),correlationId:this.correlationId,service:this.serviceName,function:this.functionName,metadata:n?this.redactSensitiveData(n):void 0};console.log(JSON.stringify(o))}error(t,r){this.log("ERROR",t,r)}warn(t,r){this.log("WARN",t,r)}info(t,r){this.log("INFO",t,r)}debug(t,r){this.log("DEBUG",t,r)}child(t){let r=new e;return r.setCorrelationId(t),r.setServiceName(this.serviceName||""),r.setFunctionName(this.functionName||""),r}},a=new K});var Z=H((wt,De)=>{De.exports={name:"dotenv",version:"16.6.1",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=text --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},homepage:"https://github.com/motdotla/dotenv#readme",funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var oe=H((vt,w)=>{var V=require("fs"),_=require("path"),Re=require("os"),Ce=require("crypto"),_e=Z(),U=_e.version,Ie=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Le(e){let t={},r=e.toString();r=r.replace(/\r\n?/mg,`
`);let n;for(;(n=Ie.exec(r))!=null;){let o=n[1],s=n[2]||"";s=s.trim();let i=s[0];s=s.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),i==='"'&&(s=s.replace(/\\n/g,`
`),s=s.replace(/\\r/g,"\r")),t[o]=s}return t}function $e(e){e=e||{};let t=ne(e);e.path=t;let r=m.configDotenv(e);if(!r.parsed){let i=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw i.code="MISSING_DATA",i}let n=re(e).split(","),o=n.length,s;for(let i=0;i<o;i++)try{let u=n[i].trim(),l=Fe(r,u);s=m.decrypt(l.ciphertext,l.key);break}catch(u){if(i+1>=o)throw u}return m.parse(s)}function Be(e){console.log(`[dotenv@${U}][WARN] ${e}`)}function x(e){console.log(`[dotenv@${U}][DEBUG] ${e}`)}function te(e){console.log(`[dotenv@${U}] ${e}`)}function re(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function Fe(e,t){let r;try{r=new URL(t)}catch(u){if(u.code==="ERR_INVALID_URL"){let l=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw l.code="INVALID_DOTENV_KEY",l}throw u}let n=r.password;if(!n){let u=new Error("INVALID_DOTENV_KEY: Missing key part");throw u.code="INVALID_DOTENV_KEY",u}let o=r.searchParams.get("environment");if(!o){let u=new Error("INVALID_DOTENV_KEY: Missing environment part");throw u.code="INVALID_DOTENV_KEY",u}let s=`DOTENV_VAULT_${o.toUpperCase()}`,i=e.parsed[s];if(!i){let u=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${s} in your .env.vault file.`);throw u.code="NOT_FOUND_DOTENV_ENVIRONMENT",u}return{ciphertext:i,key:n}}function ne(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let r of e.path)V.existsSync(r)&&(t=r.endsWith(".vault")?r:`${r}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=_.resolve(process.cwd(),".env.vault");return V.existsSync(t)?t:null}function ee(e){return e[0]==="~"?_.join(Re.homedir(),e.slice(1)):e}function Ke(e){let t=!!(e&&e.debug),r=e&&"quiet"in e?e.quiet:!0;(t||!r)&&te("Loading env from encrypted .env.vault");let n=m._parseVault(e),o=process.env;return e&&e.processEnv!=null&&(o=e.processEnv),m.populate(o,n,e),{parsed:n}}function Me(e){let t=_.resolve(process.cwd(),".env"),r="utf8",n=!!(e&&e.debug),o=e&&"quiet"in e?e.quiet:!0;e&&e.encoding?r=e.encoding:n&&x("No encoding is specified. UTF-8 is used by default");let s=[t];if(e&&e.path)if(!Array.isArray(e.path))s=[ee(e.path)];else{s=[];for(let p of e.path)s.push(ee(p))}let i,u={};for(let p of s)try{let d=m.parse(V.readFileSync(p,{encoding:r}));m.populate(u,d,e)}catch(d){n&&x(`Failed to load ${p} ${d.message}`),i=d}let l=process.env;if(e&&e.processEnv!=null&&(l=e.processEnv),m.populate(l,u,e),n||!o){let p=Object.keys(u).length,d=[];for(let b of s)try{let h=_.relative(process.cwd(),b);d.push(h)}catch(h){n&&x(`Failed to load ${b} ${h.message}`),i=h}te(`injecting env (${p}) from ${d.join(",")}`)}return i?{parsed:u,error:i}:{parsed:u}}function Je(e){if(re(e).length===0)return m.configDotenv(e);let t=ne(e);return t?m._configVault(e):(Be(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),m.configDotenv(e))}function Ve(e,t){let r=Buffer.from(t.slice(-64),"hex"),n=Buffer.from(e,"base64"),o=n.subarray(0,12),s=n.subarray(-16);n=n.subarray(12,-16);try{let i=Ce.createDecipheriv("aes-256-gcm",r,o);return i.setAuthTag(s),`${i.update(n)}${i.final()}`}catch(i){let u=i instanceof RangeError,l=i.message==="Invalid key length",p=i.message==="Unsupported state or unable to authenticate data";if(u||l){let d=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw d.code="INVALID_DOTENV_KEY",d}else if(p){let d=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw d.code="DECRYPTION_FAILED",d}else throw i}}function Ue(e,t,r={}){let n=!!(r&&r.debug),o=!!(r&&r.override);if(typeof t!="object"){let s=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw s.code="OBJECT_REQUIRED",s}for(let s of Object.keys(t))Object.prototype.hasOwnProperty.call(e,s)?(o===!0&&(e[s]=t[s]),n&&x(o===!0?`"${s}" is already defined and WAS overwritten`:`"${s}" is already defined and was NOT overwritten`)):e[s]=t[s]}var m={configDotenv:Me,_configVault:Ke,_parseVault:$e,config:Je,decrypt:Ve,parse:Le,populate:Ue};w.exports.configDotenv=m.configDotenv;w.exports._configVault=m._configVault;w.exports._parseVault=m._parseVault;w.exports.config=m.config;w.exports.decrypt=m.decrypt;w.exports.parse=m.parse;w.exports.populate=m.populate;w.exports=m});var se={};B(se,{config:()=>c});var ie,c,S=$(()=>{"use strict";ie=F(oe());ie.default.config();c={nodeEnv:process.env.NODE_ENV||"development",port:parseInt(process.env.PORT||"3000",10),localMode:process.env.LOCAL_MODE==="true",isLocal:process.env.NODE_ENV!=="production",awsRegion:process.env.AWS_REGION||"us-east-1",eventBusName:process.env.EVENT_BUS_NAME||"pdf-lecture-service-events",aws:{region:process.env.AWS_REGION||"us-east-1",accessKeyId:process.env.AWS_ACCESS_KEY_ID,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY},localstack:{endpoint:process.env.LOCALSTACK_ENDPOINT||"http://localhost:4566",useLocalStack:process.env.USE_LOCALSTACK==="true"},s3:{bucketName:process.env.S3_BUCKET_NAME||"pdf-lecture-service",pdfPrefix:process.env.S3_PDF_PREFIX||"pdfs",audioPrefix:process.env.S3_AUDIO_PREFIX||"audio",cachePrefix:process.env.S3_CACHE_PREFIX||"cache"},dynamodb:{jobsTable:process.env.DYNAMODB_TABLE_JOBS||"pdf-lecture-jobs",agentsTable:process.env.DYNAMODB_TABLE_AGENTS||"pdf-lecture-agents",contentTable:process.env.DYNAMODB_TABLE_CONTENT||"pdf-lecture-content"},processing:{maxPdfSizeMB:parseInt(process.env.MAX_PDF_SIZE_MB||"100",10),analysisTimeoutMs:parseInt(process.env.ANALYSIS_TIMEOUT_MS||"300000",10),audioSynthesisTimeoutMs:parseInt(process.env.AUDIO_SYNTHESIS_TIMEOUT_MS||"600000",10)},featureFlags:{enableRealSegmentation:process.env.ENABLE_REAL_SEGMENTATION==="true",enableRealScriptGeneration:process.env.ENABLE_REAL_SCRIPT_GENERATION==="true",enableImageExtraction:process.env.ENABLE_IMAGE_EXTRACTION==="true",enableVisionFirstPipeline:process.env.ENABLE_VISION_FIRST_PIPELINE==="true"},vision:{model:process.env.VISION_MODEL||"google/gemini-2.0-flash-exp:free",temperature:parseFloat(process.env.VISION_LLM_TEMPERATURE||"0.3"),maxTokens:parseInt(process.env.VISION_LLM_MAX_TOKENS||"4000",10)}}});var Y={};B(Y,{createAgent:()=>He,createContent:()=>Qe,createJob:()=>Ye,createTablesIfNotExist:()=>tt,deleteAgent:()=>Xe,deleteContent:()=>et,deleteJob:()=>qe,getAgent:()=>pe,getContent:()=>ge,getJob:()=>P,listAgents:()=>j,listJobs:()=>Ge,updateAgent:()=>ze,updateContent:()=>Ze,updateJob:()=>I});function f(e,t){throw a.error(`DynamoDB ${t} failed`,{error:e.message}),new Error(`Database operation failed: ${t}`)}function ue(e){return{...e,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}}function le(e){return{...e,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),stages:e.stages.map(t=>({...t,startedAt:t.startedAt?new Date(t.startedAt):void 0,completedAt:t.completedAt?new Date(t.completedAt):void 0}))}}async function Ye(e){try{let t=ue(e);return await g.put({TableName:c.dynamodb.jobsTable,Item:t}).promise(),a.info("Job created",{jobId:e.jobId}),e}catch(t){f(t,"createJob")}}async function P(e){try{let t=await g.get({TableName:c.dynamodb.jobsTable,Key:{jobId:e}}).promise();return t.Item?le(t.Item):null}catch(t){f(t,"getJob")}}async function I(e,t){try{let r=await P(e);if(!r)throw new Error(`Job not found: ${e}`);let n={...r,...t,jobId:e,updatedAt:new Date},o=ue(n);return await g.put({TableName:c.dynamodb.jobsTable,Item:o}).promise(),a.info("Job updated",{jobId:e}),n}catch(r){if(r instanceof Error&&r.message.includes("not found"))throw r;f(r,"updateJob")}}async function qe(e){try{await g.delete({TableName:c.dynamodb.jobsTable,Key:{jobId:e}}).promise(),a.info("Job deleted",{jobId:e})}catch(t){f(t,"deleteJob")}}async function Ge(){try{return((await g.scan({TableName:c.dynamodb.jobsTable}).promise()).Items||[]).map(t=>le(t))}catch(e){f(e,"listJobs")}}function de(e){return{...e,createdAt:e.createdAt.toISOString()}}function me(e){return{...e,personality:{...e.personality,tone:e.personality.tone},createdAt:new Date(e.createdAt)}}async function He(e){try{if((await j()).some(n=>n.name===e.name&&n.id!==e.id))throw new Error(`Agent with name "${e.name}" already exists`);let r=de(e);return await g.put({TableName:c.dynamodb.agentsTable,Item:r}).promise(),a.info("Agent created",{agentId:e.id,name:e.name}),e}catch(t){if(t instanceof Error&&t.message.includes("already exists"))throw t;f(t,"createAgent")}}async function pe(e){try{let t=await g.get({TableName:c.dynamodb.agentsTable,Key:{id:e}}).promise();return t.Item?me(t.Item):null}catch(t){f(t,"getAgent")}}async function ze(e,t){try{let r=await pe(e);if(!r)throw new Error(`Agent not found: ${e}`);if(t.name&&t.name!==r.name&&(await j()).some(i=>i.name===t.name&&i.id!==e))throw new Error(`Agent with name "${t.name}" already exists`);let n={...r,...t,id:e,personality:t.personality?{...r.personality,...t.personality}:r.personality,voice:t.voice?{...r.voice,...t.voice}:r.voice},o=de(n);return await g.put({TableName:c.dynamodb.agentsTable,Item:o}).promise(),a.info("Agent updated",{agentId:e}),n}catch(r){if(r instanceof Error&&(r.message.includes("already exists")||r.message.includes("not found")))throw r;f(r,"updateAgent")}}async function Xe(e){try{await g.delete({TableName:c.dynamodb.agentsTable,Key:{id:e}}).promise(),a.info("Agent deleted",{agentId:e})}catch(t){f(t,"deleteAgent")}}async function j(){try{return((await g.scan({TableName:c.dynamodb.agentsTable}).promise()).Items||[]).map(t=>me(t))}catch(e){f(e,"listAgents")}}async function Qe(e){try{let t={jobId:e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await g.put({TableName:c.dynamodb.contentTable,Item:t}).promise(),a.info("Content record created",{jobId:e}),t}catch(t){f(t,"createContent")}}async function ge(e){try{let t=await g.get({TableName:c.dynamodb.contentTable,Key:{jobId:e}}).promise();return t.Item?t.Item:null}catch(t){f(t,"getContent")}}async function Ze(e,t){try{let r=await ge(e);if(!r)throw new Error(`Content not found for job: ${e}`);let n={...r,...t,jobId:e,updatedAt:new Date().toISOString()};return await g.put({TableName:c.dynamodb.contentTable,Item:n}).promise(),a.info("Content updated",{jobId:e}),n}catch(r){if(r instanceof Error&&r.message.includes("not found"))throw r;f(r,"updateContent")}}async function et(e){try{await g.delete({TableName:c.dynamodb.contentTable,Key:{jobId:e}}).promise(),a.info("Content deleted",{jobId:e})}catch(t){f(t,"deleteContent")}}async function tt(){if(!c.localstack.useLocalStack){a.info("Skipping table creation in production mode");return}let e=new W.default.DynamoDB(k),t=[{TableName:c.dynamodb.jobsTable,KeySchema:[{AttributeName:"jobId",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:"jobId",AttributeType:"S"}]},{TableName:c.dynamodb.agentsTable,KeySchema:[{AttributeName:"id",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:"id",AttributeType:"S"}]},{TableName:c.dynamodb.contentTable,KeySchema:[{AttributeName:"jobId",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:"jobId",AttributeType:"S"}]}];for(let r of t)try{await e.describeTable({TableName:r.TableName}).promise(),a.info(`Table ${r.TableName} already exists`)}catch(n){if(n.code==="ResourceNotFoundException")try{await e.createTable({...r,BillingMode:"PAY_PER_REQUEST"}).promise(),a.info(`Table ${r.TableName} created`)}catch(o){a.error(`Failed to create table ${r.TableName}`,{error:o})}}}var W,k,g,L=$(()=>{"use strict";W=F(require("aws-sdk"));S();E();k={region:c.aws.region};c.localstack.useLocalStack&&(k.endpoint=c.localstack.endpoint,k.accessKeyId="test",k.secretAccessKey="test");g=new W.default.DynamoDB.DocumentClient(k)});var dt={};B(dt,{audioHandler:()=>lt});module.exports=R(dt);E();E();var C=class extends Error{constructor(r,n,o=500,s=!1,i){super(r);this.code=n;this.statusCode=o;this.retryable=s;this.details=i;this.name="AppError",Error.captureStackTrace(this,this.constructor)}toResponse(r){return{error:this.message,code:this.code,jobId:r,details:this.details,retryable:this.retryable}}};var v=class extends C{constructor(t,r,n){super(t,"EXTERNAL_SERVICE_ERROR",502,!0,{service:r,...n}),this.name="ExternalServiceError"}},T=class extends C{constructor(t,r){super(t,"RESOURCE_ERROR",503,!0,r),this.name="ResourceError"}};var Ne={maxAttempts:3,initialDelayMs:1e3,maxDelayMs:1e4,backoffMultiplier:2,retryableErrors:["ECONNRESET","ETIMEDOUT","ENOTFOUND","ECONNREFUSED"]};function xe(e){return new Promise(t=>setTimeout(t,e))}function ke(e,t){if(!e)return!1;if(typeof e.retryable=="boolean")return e.retryable;if(e.name&&t.includes(e.name)||e.code&&t.includes(e.code))return!0;let r=e.message?.toLowerCase()||"";return r.includes("timeout")||r.includes("connection")||r.includes("network")||r.includes("temporary")||r.includes("rate limit")||r.includes("429")||r.includes("too many requests")}async function X(e,t={}){let r={...Ne,...t},n,o=r.initialDelayMs;for(let s=1;s<=r.maxAttempts;s++)try{let i=await e();return s>1&&a.info("Operation succeeded after retry",{attempt:s}),i}catch(i){n=i;let u=ke(i,r.retryableErrors),l=s===r.maxAttempts;if(a.warn("Operation failed",{attempt:s,maxAttempts:r.maxAttempts,isRetryable:u,error:i instanceof Error?i.message:String(i)}),!u||l)throw i;a.info("Retrying operation",{attempt:s,delayMs:o}),await xe(o),o=Math.min(o*r.backoffMultiplier,r.maxDelayMs)}throw n}var Pe={failureThreshold:5,successThreshold:2,timeout:3e4,resetTimeoutMs:6e4},J=class{constructor(t,r={}){this.serviceName=t;this.options={...Pe,...r}}state="CLOSED";failureCount=0;successCount=0;nextAttemptTime=0;options;async execute(t){if(this.state==="OPEN"){if(Date.now()<this.nextAttemptTime)throw a.warn("Circuit breaker is OPEN, rejecting request",{service:this.serviceName,nextAttemptTime:new Date(this.nextAttemptTime).toISOString()}),new v(`Service ${this.serviceName} is currently unavailable (circuit breaker OPEN)`,this.serviceName);this.state="HALF_OPEN",this.successCount=0,a.info("Circuit breaker entering HALF_OPEN state",{service:this.serviceName})}try{let r=await this.executeWithTimeout(t);return this.onSuccess(),r}catch(r){throw this.onFailure(),r}}async executeWithTimeout(t){return Promise.race([t(),new Promise((r,n)=>setTimeout(()=>n(new T("Operation timeout",{timeout:this.options.timeout})),this.options.timeout))])}onSuccess(){this.failureCount=0,this.state==="HALF_OPEN"&&(this.successCount++,this.successCount>=this.options.successThreshold&&(this.state="CLOSED",this.successCount=0,a.info("Circuit breaker closed",{service:this.serviceName})))}onFailure(){this.failureCount++,this.successCount=0,this.state==="HALF_OPEN"?(this.state="OPEN",this.nextAttemptTime=Date.now()+this.options.resetTimeoutMs,a.warn("Circuit breaker opened from HALF_OPEN",{service:this.serviceName,nextAttemptTime:new Date(this.nextAttemptTime).toISOString()})):this.failureCount>=this.options.failureThreshold&&(this.state="OPEN",this.nextAttemptTime=Date.now()+this.options.resetTimeoutMs,a.warn("Circuit breaker opened",{service:this.serviceName,failureCount:this.failureCount,nextAttemptTime:new Date(this.nextAttemptTime).toISOString()}))}getState(){return this.state}reset(){this.state="CLOSED",this.failureCount=0,this.successCount=0,this.nextAttemptTime=0,a.info("Circuit breaker manually reset",{service:this.serviceName})}},M=new Map;function Oe(e,t){return M.has(e)||M.set(e,new J(e,t)),M.get(e)}async function Q(e,t,r,n){let o=Oe(e,n);return X(()=>o.execute(t),r)}var ae=F(require("aws-sdk"));S();E();var N={region:c.aws.region,s3ForcePathStyle:!0,httpOptions:{timeout:3e4,connectTimeout:5e3},maxRetries:0};c.localstack.useLocalStack?(N.endpoint=c.localstack.endpoint,N.accessKeyId="test",N.secretAccessKey="test"):c.aws.accessKeyId&&c.aws.secretAccessKey&&(N.accessKeyId=c.aws.accessKeyId,N.secretAccessKey=c.aws.secretAccessKey);var We=new ae.default.S3(N);function je(e,t){throw a.error(`S3 ${t} failed`,{error:e.message,code:e.code}),e.code==="RequestTimeout"||e.code==="TimeoutError"?new T(`Storage operation timed out: ${t}`,{error:e.message}):e.code==="NoSuchBucket"||e.code==="NoSuchKey"?new T(`Storage resource not found: ${t}`,{error:e.message}):new v(`Storage operation failed: ${t}`,"s3",{error:e.message})}async function ce(e,t){try{let r=`${c.s3.audioPrefix}/${e}/lecture.mp3`;return await We.putObject({Bucket:c.s3.bucketName,Key:r,Body:t,ContentType:"audio/mpeg",Metadata:{jobId:e}}).promise(),a.info("Audio uploaded",{jobId:e,key:r}),c.localstack.useLocalStack?`${c.localstack.endpoint}/${c.s3.bucketName}/${r}`:`https://${c.s3.bucketName}.s3.${c.aws.region}.amazonaws.com/${r}`}catch(r){je(r,"uploadAudio")}}var q=class{async synthesize(t,r){a.info("Mock TTS synthesis",{textLength:t.length,voiceId:r.voiceId,speed:r.speed,pitch:r.pitch}),await new Promise(d=>setTimeout(d,100));let n=Buffer.from([255,251,144,0,...Array(1e3).fill(0)]),o=t.split(/\s+/).filter(d=>d.length>0),s=[],u=60/(155*r.speed),l=0;for(let d of o){let b=u;s.push({word:d.replace(/[.,!?;:]$/,""),startTime:l,endTime:l+b,scriptBlockId:"unknown"}),l+=b}return{audioBuffer:n,duration:l,wordTimings:s}}},G=class{polly;engine;constructor(){let t=require("aws-sdk"),{config:r}=(S(),R(se)),n={region:r.aws.region};r.aws.accessKeyId&&r.aws.secretAccessKey&&(n.accessKeyId=r.aws.accessKeyId,n.secretAccessKey=r.aws.secretAccessKey),this.polly=new t.Polly(n),this.engine=process.env.POLLY_ENGINE||"neural",a.info("AWS Polly TTS Provider initialized",{region:r.aws.region,engine:this.engine})}async synthesize(t,r){return a.info("AWS Polly TTS synthesis",{textLength:t.length,voiceId:r.voiceId,engine:this.engine}),Q("aws-polly",async()=>{try{let n={Text:t,OutputFormat:"mp3",VoiceId:r.voiceId,Engine:this.engine};this.engine==="generative"?a.info("Using generative engine (word timings will be estimated)"):this.engine==="long-form"?n.SpeechMarkTypes=["word"]:n.SpeechMarkTypes=["word"];let s=(await this.polly.synthesizeSpeech(n).promise()).AudioStream,i=[],u=0;if(this.engine!=="generative")try{let l={...n,OutputFormat:"json"},b=(await this.polly.synthesizeSpeech(l).promise()).AudioStream.toString("utf-8").split(`
`).filter(h=>h.trim());for(let h of b)try{let y=JSON.parse(h);y.type==="word"&&i.push({word:y.value,startTime:y.time/1e3,endTime:(y.time+(y.duration||0))/1e3,scriptBlockId:"unknown"})}catch{a.warn("Failed to parse timing mark",{line:h})}u=i.length>0?i[i.length-1].endTime:0}catch(l){a.warn("Failed to get word timings, will estimate",{error:l})}return i.length===0&&(a.info("Estimating word timings based on voice speed"),i=this.estimateWordTimings(t,r.speed),u=i.length>0?i[i.length-1].endTime:0),{audioBuffer:s,duration:u,wordTimings:i}}catch(n){throw a.error("AWS Polly synthesis failed",{error:n}),new v(`TTS synthesis failed: ${n instanceof Error?n.message:String(n)}`,"aws-polly",{error:n})}},{maxAttempts:3,initialDelayMs:1e3},{failureThreshold:5,timeout:6e4})}estimateWordTimings(t,r){let n=t.split(/\s+/).filter(l=>l.length>0),o=[],i=60/(155*r),u=0;for(let l of n){let p=i;o.push({word:l.replace(/[.,!?;:]$/,""),startTime:u,endTime:u+p,scriptBlockId:"unknown"}),u+=p}return o}};function rt(){switch((process.env.TTS_PROVIDER||"mock").toLowerCase()){case"polly":case"aws":return new G;case"mock":default:return new q}}function nt(e){return{voiceId:e.voice.voiceId,speed:e.voice.speed,pitch:e.voice.pitch}}function ot(e,t){let r=e.wordTimings,n=[];for(let s of t.segments)for(let i of s.scriptBlocks){let u=i.text.split(/\s+/).filter(l=>l.length>0);for(let l of u)n.push({word:l.replace(/[.,!?;:]$/,""),blockId:i.id})}let o=[];for(let s=0;s<r.length&&s<n.length;s++)o.push({...r[s],scriptBlockId:n[s].blockId});if(r.length>n.length&&n.length>0){let s=n[n.length-1].blockId;for(let i=n.length;i<r.length;i++)o.push({...r[i],scriptBlockId:s})}return o}function it(e){if(e.length===0)return!0;for(let t=1;t<e.length;t++){let r=e[t-1],n=e[t];if(n.startTime<r.endTime)return a.warn("Timing monotonicity violation detected",{index:t,prevWord:r.word,prevEnd:r.endTime,currWord:n.word,currStart:n.startTime}),!1;if(n.endTime<n.startTime)return a.warn("Invalid word timing detected",{index:t,word:n.word,startTime:n.startTime,endTime:n.endTime}),!1}return!0}function st(e){if(e.length===0)return e;let t=[e[0]];for(let r=1;r<e.length;r++){let n=t[r-1],o={...e[r]};o.startTime<n.endTime&&(o.startTime=n.endTime),o.endTime<o.startTime&&(o.endTime=o.startTime+.1),t.push(o)}return t}function at(e){let t=[];for(let r of e.segments)for(let n of r.scriptBlocks)t.push(n.text);return t.join(" ").replace(/\s+/g," ").trim()}async function fe(e){try{a.info("Starting audio synthesis",{jobId:e});let{getContent:t,updateContent:r,getAgent:n,getJob:o,updateJob:s}=(L(),R(Y)),i=await t(e);if(!i||!i.script)throw new Error(`No lecture script found for job: ${e}`);let u=i.script,l=await o(e);if(!l)throw new Error(`Job not found: ${e}`);let p=null;l.agentId&&(p=await n(l.agentId)),p||(a.warn("No agent specified, using default agent"),p={id:"default",name:"Default Lecturer",description:"A clear and straightforward science communicator",personality:{instructions:"Explain concepts clearly and accessibly",tone:"casual"},voice:{voiceId:"Joanna",speed:1,pitch:0},createdAt:new Date});let d=at(u);if(d.length===0)throw new Error("Script text is empty");a.info("Script concatenated",{jobId:e,textLength:d.length,wordCount:d.split(/\s+/).length});let b=rt(),h=nt(p),y=await b.synthesize(d,h);a.info("TTS synthesis completed",{jobId:e,duration:y.duration,wordCount:y.wordTimings.length});let A=ot(y,u);it(A)||(a.warn("Timing monotonicity validation failed, fixing timings",{jobId:e}),A=st(A));let O=await ce(e,y.audioBuffer);a.info("Audio uploaded to S3",{jobId:e,audioUrl:O});let be={audioUrl:O,duration:y.duration,wordTimings:A};return await r(e,{audioUrl:O,wordTimings:A}),await s(e,{status:"completed"}),a.info("Audio synthesis completed",{jobId:e,audioUrl:O,duration:y.duration,wordTimingCount:A.length}),be}catch(t){a.error("Audio synthesis failed",{jobId:e,error:t});try{let{updateJob:r}=(L(),R(Y));await r(e,{status:"failed",error:t instanceof Error?t.message:"Audio synthesis failed"})}catch(r){a.error("Failed to update job status",{jobId:e,error:r})}throw t}}L();var ye=require("aws-sdk");S();E();var ct=new ye.EventBridge({endpoint:c.isLocal?"http://localhost:4566":void 0,region:c.awsRegion});async function ut(e,t){let r=c.eventBusName||"pdf-lecture-service-events";try{a.info("Publishing pipeline event",{detailType:e,jobId:t.jobId});let n={Entries:[{Source:"pdf-lecture-service",DetailType:e,Detail:JSON.stringify(t),EventBusName:r}]},o=await ct.putEvents(n).promise();if(o.FailedEntryCount&&o.FailedEntryCount>0){let s=o.Entries?.filter(i=>i.ErrorCode).map(i=>({code:i.ErrorCode,message:i.ErrorMessage}));throw new Error(`Failed to publish event: ${JSON.stringify(s)}`)}a.info("Pipeline event published successfully",{detailType:e,jobId:t.jobId})}catch(n){throw a.error("Failed to publish pipeline event",{error:n,detailType:e,jobId:t.jobId}),n}}async function he(e){await ut("JobCompleted",{jobId:e})}E();S();async function lt(e){try{a.info("Audio synthesizer function invoked");let t=e.jobId;if(!t)throw new Error("jobId is required");let r=await P(t);if(!r)throw new Error(`Job not found: ${t}`);await I(t,{status:"synthesizing_audio",stages:r.stages.map(o=>o.stage==="audio_synthesis"?{...o,status:"in_progress",startedAt:new Date}:o)}),a.info("Starting audio synthesis",{jobId:t});let n=await fe(t);return a.info("Audio synthesis completed successfully",{jobId:t}),c.nodeEnv==="production"&&(await he(t),a.info("Job completion event published",{jobId:t})),{statusCode:200,body:JSON.stringify({jobId:t,status:"completed",message:"Audio synthesis completed",audioOutput:{audioUrl:n.audioUrl,duration:n.duration,wordTimingCount:n.wordTimings.length}})}}catch(t){a.error("Audio synthesizer handler error",{error:t});let r={error:t instanceof Error?t.message:"Unknown error",code:"AUDIO_SYNTHESIS_FAILED",retryable:!0};if(e.jobId)try{let n=await P(e.jobId);n&&await I(e.jobId,{status:"failed",error:r.error,stages:n.stages.map(o=>o.stage==="audio_synthesis"?{...o,status:"failed",error:r.error}:o)})}catch(n){a.error("Failed to update job status",{error:n})}return{statusCode:500,body:JSON.stringify(r)}}}0&&(module.exports={audioHandler});
//# sourceMappingURL=audio.js.map
