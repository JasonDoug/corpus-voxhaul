"use strict";var Ct=Object.create;var J=Object.defineProperty;var Dt=Object.getOwnPropertyDescriptor;var kt=Object.getOwnPropertyNames;var Ot=Object.getPrototypeOf,_t=Object.prototype.hasOwnProperty;var d=(e,t)=>()=>(e&&(t=e(e=0)),t);var Ie=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Y=(e,t)=>{for(var r in t)J(e,r,{get:t[r],enumerable:!0})},Le=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of kt(t))!_t.call(e,i)&&i!==r&&J(e,i,{get:()=>t[i],enumerable:!(n=Dt(t,i))||n.enumerable});return e};var ne=(e,t,r)=>(r=e!=null?Ct(Ot(e)):{},Le(t||!e||!e.__esModule?J(r,"default",{value:e,enumerable:!0}):r,e)),W=e=>Le(J({},"__esModule",{value:!0}),e);var Pt,oe,c,T=d(()=>{"use strict";Pt=[/password/i,/secret/i,/token/i,/apikey/i,/api[_-]?key/i,/authorization/i,/auth/i,/credential/i,/private[_-]?key/i,/access[_-]?key/i],oe=class e{correlationId;serviceName;functionName;minLogLevel;constructor(){let t=process.env.LOG_LEVEL?.toUpperCase();this.minLogLevel=t||"INFO"}setCorrelationId(t){this.correlationId=t}getCorrelationId(){return this.correlationId}setServiceName(t){this.serviceName=t}setFunctionName(t){this.functionName=t}redactSensitiveData(t){if(t==null||typeof t=="string")return t;if(Array.isArray(t))return t.map(r=>this.redactSensitiveData(r));if(typeof t=="object"){let r={};for(let[n,i]of Object.entries(t))Pt.some(s=>s.test(n))?r[n]="[REDACTED]":typeof i=="object"&&i!==null?r[n]=this.redactSensitiveData(i):r[n]=i;return r}return t}shouldLog(t){let r=["ERROR","WARN","INFO","DEBUG"],n=r.indexOf(t),i=r.indexOf(this.minLogLevel);return n<=i}log(t,r,n){if(!this.shouldLog(t))return;let i={level:t,message:r,timestamp:new Date().toISOString(),correlationId:this.correlationId,service:this.serviceName,function:this.functionName,metadata:n?this.redactSensitiveData(n):void 0};console.log(JSON.stringify(i))}error(t,r){this.log("ERROR",t,r)}warn(t,r){this.log("WARN",t,r)}info(t,r){this.log("INFO",t,r)}debug(t,r){this.log("DEBUG",t,r)}child(t){let r=new e;return r.setCorrelationId(t),r.setServiceName(this.serviceName||""),r.setFunctionName(this.functionName||""),r}},c=new oe});var Re=Ie((Xr,Mt)=>{Mt.exports={name:"dotenv",version:"16.6.1",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=text --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},homepage:"https://github.com/motdotla/dotenv#readme",funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var Oe=Ie((Qr,S)=>{var ie=require("fs"),G=require("path"),Ut=require("os"),$t=require("crypto"),Ft=Re(),se=Ft.version,jt=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Vt(e){let t={},r=e.toString();r=r.replace(/\r\n?/mg,`
`);let n;for(;(n=jt.exec(r))!=null;){let i=n[1],o=n[2]||"";o=o.trim();let s=o[0];o=o.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),s==='"'&&(o=o.replace(/\\n/g,`
`),o=o.replace(/\\r/g,"\r")),t[i]=o}return t}function Kt(e){e=e||{};let t=ke(e);e.path=t;let r=g.configDotenv(e);if(!r.parsed){let s=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw s.code="MISSING_DATA",s}let n=De(e).split(","),i=n.length,o;for(let s=0;s<i;s++)try{let a=n[s].trim(),u=Jt(r,a);o=g.decrypt(u.ciphertext,u.key);break}catch(a){if(s+1>=i)throw a}return g.parse(o)}function Bt(e){console.log(`[dotenv@${se}][WARN] ${e}`)}function P(e){console.log(`[dotenv@${se}][DEBUG] ${e}`)}function Ce(e){console.log(`[dotenv@${se}] ${e}`)}function De(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function Jt(e,t){let r;try{r=new URL(t)}catch(a){if(a.code==="ERR_INVALID_URL"){let u=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw u.code="INVALID_DOTENV_KEY",u}throw a}let n=r.password;if(!n){let a=new Error("INVALID_DOTENV_KEY: Missing key part");throw a.code="INVALID_DOTENV_KEY",a}let i=r.searchParams.get("environment");if(!i){let a=new Error("INVALID_DOTENV_KEY: Missing environment part");throw a.code="INVALID_DOTENV_KEY",a}let o=`DOTENV_VAULT_${i.toUpperCase()}`,s=e.parsed[o];if(!s){let a=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${o} in your .env.vault file.`);throw a.code="NOT_FOUND_DOTENV_ENVIRONMENT",a}return{ciphertext:s,key:n}}function ke(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let r of e.path)ie.existsSync(r)&&(t=r.endsWith(".vault")?r:`${r}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=G.resolve(process.cwd(),".env.vault");return ie.existsSync(t)?t:null}function Ne(e){return e[0]==="~"?G.join(Ut.homedir(),e.slice(1)):e}function Yt(e){let t=!!(e&&e.debug),r=e&&"quiet"in e?e.quiet:!0;(t||!r)&&Ce("Loading env from encrypted .env.vault");let n=g._parseVault(e),i=process.env;return e&&e.processEnv!=null&&(i=e.processEnv),g.populate(i,n,e),{parsed:n}}function Wt(e){let t=G.resolve(process.cwd(),".env"),r="utf8",n=!!(e&&e.debug),i=e&&"quiet"in e?e.quiet:!0;e&&e.encoding?r=e.encoding:n&&P("No encoding is specified. UTF-8 is used by default");let o=[t];if(e&&e.path)if(!Array.isArray(e.path))o=[Ne(e.path)];else{o=[];for(let m of e.path)o.push(Ne(m))}let s,a={};for(let m of o)try{let p=g.parse(ie.readFileSync(m,{encoding:r}));g.populate(a,p,e)}catch(p){n&&P(`Failed to load ${m} ${p.message}`),s=p}let u=process.env;if(e&&e.processEnv!=null&&(u=e.processEnv),g.populate(u,a,e),n||!i){let m=Object.keys(a).length,p=[];for(let x of o)try{let y=G.relative(process.cwd(),x);p.push(y)}catch(y){n&&P(`Failed to load ${x} ${y.message}`),s=y}Ce(`injecting env (${m}) from ${p.join(",")}`)}return s?{parsed:a,error:s}:{parsed:a}}function Gt(e){if(De(e).length===0)return g.configDotenv(e);let t=ke(e);return t?g._configVault(e):(Bt(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),g.configDotenv(e))}function qt(e,t){let r=Buffer.from(t.slice(-64),"hex"),n=Buffer.from(e,"base64"),i=n.subarray(0,12),o=n.subarray(-16);n=n.subarray(12,-16);try{let s=$t.createDecipheriv("aes-256-gcm",r,i);return s.setAuthTag(o),`${s.update(n)}${s.final()}`}catch(s){let a=s instanceof RangeError,u=s.message==="Invalid key length",m=s.message==="Unsupported state or unable to authenticate data";if(a||u){let p=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw p.code="INVALID_DOTENV_KEY",p}else if(m){let p=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw p.code="DECRYPTION_FAILED",p}else throw s}}function Ht(e,t,r={}){let n=!!(r&&r.debug),i=!!(r&&r.override);if(typeof t!="object"){let o=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw o.code="OBJECT_REQUIRED",o}for(let o of Object.keys(t))Object.prototype.hasOwnProperty.call(e,o)?(i===!0&&(e[o]=t[o]),n&&P(i===!0?`"${o}" is already defined and WAS overwritten`:`"${o}" is already defined and was NOT overwritten`)):e[o]=t[o]}var g={configDotenv:Wt,_configVault:Yt,_parseVault:Kt,config:Gt,decrypt:qt,parse:Vt,populate:Ht};S.exports.configDotenv=g.configDotenv;S.exports._configVault=g._configVault;S.exports._parseVault=g._parseVault;S.exports.config=g.config;S.exports.decrypt=g.decrypt;S.exports.parse=g.parse;S.exports.populate=g.populate;S.exports=g});var _e,l,_=d(()=>{"use strict";_e=ne(Oe());_e.default.config();l={nodeEnv:process.env.NODE_ENV||"development",port:parseInt(process.env.PORT||"3000",10),localMode:process.env.LOCAL_MODE==="true",isLocal:process.env.NODE_ENV!=="production",awsRegion:process.env.AWS_REGION||"us-east-1",eventBusName:process.env.EVENT_BUS_NAME||"pdf-lecture-service-events",aws:{region:process.env.AWS_REGION||"us-east-1",accessKeyId:process.env.AWS_ACCESS_KEY_ID,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY},localstack:{endpoint:process.env.LOCALSTACK_ENDPOINT||"http://localhost:4566",useLocalStack:process.env.USE_LOCALSTACK==="true"},s3:{bucketName:process.env.S3_BUCKET_NAME||"pdf-lecture-service",pdfPrefix:process.env.S3_PDF_PREFIX||"pdfs",audioPrefix:process.env.S3_AUDIO_PREFIX||"audio",cachePrefix:process.env.S3_CACHE_PREFIX||"cache"},dynamodb:{jobsTable:process.env.DYNAMODB_JOBS_TABLE||"pdf-lecture-jobs",agentsTable:process.env.DYNAMODB_AGENTS_TABLE||"pdf-lecture-agents",contentTable:process.env.DYNAMODB_CONTENT_TABLE||"pdf-lecture-content"},processing:{maxPdfSizeMB:parseInt(process.env.MAX_PDF_SIZE_MB||"100",10),analysisTimeoutMs:parseInt(process.env.ANALYSIS_TIMEOUT_MS||"300000",10),audioSynthesisTimeoutMs:parseInt(process.env.AUDIO_SYNTHESIS_TIMEOUT_MS||"600000",10)},featureFlags:{enableRealSegmentation:process.env.ENABLE_REAL_SEGMENTATION==="true",enableRealScriptGeneration:process.env.ENABLE_REAL_SCRIPT_GENERATION==="true",enableImageExtraction:process.env.ENABLE_IMAGE_EXTRACTION==="true",enableVisionFirstPipeline:process.env.ENABLE_VISION_FIRST_PIPELINE==="true"},vision:{model:process.env.VISION_MODEL||"google/gemini-2.0-flash-exp:free",temperature:parseFloat(process.env.VISION_LLM_TEMPERATURE||"0.3"),maxTokens:parseInt(process.env.VISION_LLM_MAX_TOKENS||"4000",10)}}});var Me={};Y(Me,{createAlarm:()=>q,createStandardAlarmsForFunction:()=>tr,publishMetric:()=>Zt,publishMetrics:()=>er});async function Zt(e){if(l.isLocal&&!l.localstack.useLocalStack){c.debug("Skipping CloudWatch metric in local mode",{metric:e});return}try{let t=e.dimensions?Object.entries(e.dimensions).map(([r,n])=>({Name:r,Value:n})):[];await ce.putMetricData({Namespace:"PDFLectureService",MetricData:[{MetricName:e.name,Value:e.value,Unit:e.unit,Timestamp:e.timestamp||new Date,Dimensions:t}]}).promise(),c.debug("Metric published to CloudWatch",{metric:e})}catch(t){c.error("Failed to publish metric to CloudWatch",{metric:e,error:t instanceof Error?t.message:String(t)})}}async function er(e){if(l.isLocal&&!l.localstack.useLocalStack){c.debug("Skipping CloudWatch metrics in local mode",{count:e.length});return}try{let t=e.map(n=>{let i=n.dimensions?Object.entries(n.dimensions).map(([o,s])=>({Name:o,Value:s})):[];return{MetricName:n.name,Value:n.value,Unit:n.unit,Timestamp:n.timestamp||new Date,Dimensions:i}}),r=20;for(let n=0;n<t.length;n+=r){let i=t.slice(n,n+r);await ce.putMetricData({Namespace:"PDFLectureService",MetricData:i}).promise()}c.debug("Metrics published to CloudWatch",{count:e.length})}catch(t){c.error("Failed to publish metrics to CloudWatch",{count:e.length,error:t instanceof Error?t.message:String(t)})}}async function q(e){try{let t=e.dimensions?Object.entries(e.dimensions).map(([r,n])=>({Name:r,Value:n})):[];await ce.putMetricAlarm({AlarmName:e.alarmName,MetricName:e.metricName,Namespace:"PDFLectureService",Statistic:e.statistic,Period:e.period,EvaluationPeriods:e.evaluationPeriods,Threshold:e.threshold,ComparisonOperator:e.comparisonOperator,Dimensions:t,TreatMissingData:"notBreaching"}).promise(),c.info("CloudWatch alarm created",{alarmName:e.alarmName})}catch(t){c.error("Failed to create CloudWatch alarm",{alarmName:e.alarmName,error:t instanceof Error?t.message:String(t)})}}async function tr(e,t){await q({alarmName:`${e}-ErrorRate`,metricName:"Errors",threshold:5,comparisonOperator:"GreaterThanThreshold",evaluationPeriods:1,period:300,statistic:"Sum",dimensions:{FunctionName:e}}),await q({alarmName:`${e}-Timeout`,metricName:"Duration",threshold:t*.9,comparisonOperator:"GreaterThanThreshold",evaluationPeriods:1,period:300,statistic:"Maximum",dimensions:{FunctionName:e}}),await q({alarmName:`${e}-Throttles`,metricName:"Throttles",threshold:1,comparisonOperator:"GreaterThanThreshold",evaluationPeriods:1,period:300,statistic:"Sum",dimensions:{FunctionName:e}})}var Pe,ce,Ue=d(()=>{"use strict";Pe=ne(require("aws-sdk"));_();T();ce=new Pe.CloudWatch({region:l.aws.region,...l.localstack.useLocalStack&&{endpoint:l.localstack.endpoint}})});var je,Ve=d(()=>{je="ffffffff-ffff-ffff-ffff-ffffffffffff"});var Ke,Be=d(()=>{Ke="00000000-0000-0000-0000-000000000000"});var Je,Ye=d(()=>{Je=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i});function or(e){return typeof e=="string"&&Je.test(e)}var N,U=d(()=>{Ye();N=or});function ir(e){if(!N(e))throw TypeError("Invalid UUID");let t;return Uint8Array.of((t=parseInt(e.slice(0,8),16))>>>24,t>>>16&255,t>>>8&255,t&255,(t=parseInt(e.slice(9,13),16))>>>8,t&255,(t=parseInt(e.slice(14,18),16))>>>8,t&255,(t=parseInt(e.slice(19,23),16))>>>8,t&255,(t=parseInt(e.slice(24,36),16))/1099511627776&255,t/4294967296&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255)}var A,$=d(()=>{U();A=ir});function h(e,t=0){return(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase()}function sr(e,t=0){let r=h(e,t);if(!N(r))throw TypeError("Stringified UUID is invalid");return r}var f,We,I=d(()=>{U();f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));We=sr});function L(){return H>z.length-16&&((0,Ge.randomFillSync)(z),H=0),z.slice(H,H+=16)}var Ge,z,H,X=d(()=>{Ge=require("crypto"),z=new Uint8Array(256),H=z.length});function ar(e,t,r){let n,i=e?._v6??!1;if(e){let o=Object.keys(e);o.length===1&&o[0]==="_v6"&&(e=void 0)}if(e)n=qe(e.random??e.rng?.()??L(),e.msecs,e.nsecs,e.clockseq,e.node,t,r);else{let o=Date.now(),s=L();cr(F,o,s),n=qe(s,F.msecs,F.nsecs,i?void 0:F.clockseq,i?void 0:F.node,t,r)}return t??h(n)}function cr(e,t,r){return e.msecs??=-1/0,e.nsecs??=0,t===e.msecs?(e.nsecs++,e.nsecs>=1e4&&(e.node=void 0,e.nsecs=0)):t>e.msecs?e.nsecs=0:t<e.msecs&&(e.node=void 0),e.node||(e.node=r.slice(10,16),e.node[0]|=1,e.clockseq=(r[8]<<8|r[9])&16383),e.msecs=t,e}function qe(e,t,r,n,i,o,s=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(!o)o=new Uint8Array(16),s=0;else if(s<0||s+16>o.length)throw new RangeError(`UUID byte range ${s}:${s+15} is out of buffer bounds`);t??=Date.now(),r??=0,n??=(e[8]<<8|e[9])&16383,i??=e.slice(10,16),t+=122192928e5;let a=((t&268435455)*1e4+r)%4294967296;o[s++]=a>>>24&255,o[s++]=a>>>16&255,o[s++]=a>>>8&255,o[s++]=a&255;let u=t/4294967296*1e4&268435455;o[s++]=u>>>8&255,o[s++]=u&255,o[s++]=u>>>24&15|16,o[s++]=u>>>16&255,o[s++]=n>>>8|128,o[s++]=n&255;for(let m=0;m<6;++m)o[s++]=i[m];return o}var F,Q,fe=d(()=>{X();I();F={};Q=ar});function j(e){let t=typeof e=="string"?A(e):e,r=ur(t);return typeof e=="string"?h(r):r}function ur(e){return Uint8Array.of((e[6]&15)<<4|e[7]>>4&15,(e[7]&15)<<4|(e[4]&240)>>4,(e[4]&15)<<4|(e[5]&240)>>4,(e[5]&15)<<4|(e[0]&240)>>4,(e[0]&15)<<4|(e[1]&240)>>4,(e[1]&15)<<4|(e[2]&240)>>4,96|e[2]&15,e[3],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}var he=d(()=>{$();I()});function lr(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),(0,He.createHash)("md5").update(e).digest()}var He,ze,Xe=d(()=>{He=require("crypto");ze=lr});function pr(e){e=unescape(encodeURIComponent(e));let t=new Uint8Array(e.length);for(let r=0;r<e.length;++r)t[r]=e.charCodeAt(r);return t}function V(e,t,r,n,i,o){let s=typeof r=="string"?pr(r):r,a=typeof n=="string"?A(n):n;if(typeof n=="string"&&(n=A(n)),n?.length!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let u=new Uint8Array(16+s.length);if(u.set(a),u.set(s,a.length),u=t(u),u[6]=u[6]&15|e,u[8]=u[8]&63|128,i){o=o||0;for(let m=0;m<16;++m)i[o+m]=u[m];return i}return h(u)}var Z,ee,ye=d(()=>{$();I();Z="6ba7b810-9dad-11d1-80b4-00c04fd430c8",ee="6ba7b811-9dad-11d1-80b4-00c04fd430c8"});function ve(e,t,r,n){return V(48,ze,e,t,r,n)}var Qe,Ze=d(()=>{Xe();ye();ve.DNS=Z;ve.URL=ee;Qe=ve});var et,be,tt=d(()=>{et=require("crypto"),be={randomUUID:et.randomUUID}});function mr(e,t,r){e=e||{};let n=e.random??e.rng?.()??L();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,t){if(r=r||0,r<0||r+16>t.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let i=0;i<16;++i)t[r+i]=n[i];return t}return h(n)}function dr(e,t,r){return be.randomUUID&&!t&&!e?be.randomUUID():mr(e,t,r)}var rt,nt=d(()=>{tt();X();I();rt=dr});function gr(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),(0,ot.createHash)("sha1").update(e).digest()}var ot,it,st=d(()=>{ot=require("crypto");it=gr});function Ee(e,t,r,n){return V(80,it,e,t,r,n)}var at,ct=d(()=>{st();ye();Ee.DNS=Z;Ee.URL=ee;at=Ee});function fr(e,t,r){e??={},r??=0;let n=Q({...e,_v6:!0},new Uint8Array(16));if(n=j(n),t){for(let i=0;i<16;i++)t[r+i]=n[i];return t}return h(n)}var ut,lt=d(()=>{I();fe();he();ut=fr});function we(e){let t=typeof e=="string"?A(e):e,r=hr(t);return typeof e=="string"?h(r):r}function hr(e){return Uint8Array.of((e[3]&15)<<4|e[4]>>4&15,(e[4]&15)<<4|(e[5]&240)>>4,(e[5]&15)<<4|e[6]&15,e[7],(e[1]&15)<<4|(e[2]&240)>>4,(e[2]&15)<<4|(e[3]&240)>>4,16|(e[0]&240)>>4,(e[0]&15)<<4|(e[1]&240)>>4,e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}var pt=d(()=>{$();I()});function yr(e,t,r){let n;if(e)n=mt(e.random??e.rng?.()??L(),e.msecs,e.seq,t,r);else{let i=Date.now(),o=L();vr(Te,i,o),n=mt(o,Te.msecs,Te.seq,t,r)}return t??h(n)}function vr(e,t,r){return e.msecs??=-1/0,e.seq??=0,t>e.msecs?(e.seq=r[6]<<23|r[7]<<16|r[8]<<8|r[9],e.msecs=t):(e.seq=e.seq+1|0,e.seq===0&&e.msecs++),e}function mt(e,t,r,n,i=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(!n)n=new Uint8Array(16),i=0;else if(i<0||i+16>n.length)throw new RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);return t??=Date.now(),r??=e[6]*127<<24|e[7]<<16|e[8]<<8|e[9],n[i++]=t/1099511627776&255,n[i++]=t/4294967296&255,n[i++]=t/16777216&255,n[i++]=t/65536&255,n[i++]=t/256&255,n[i++]=t&255,n[i++]=112|r>>>28&15,n[i++]=r>>>20&255,n[i++]=128|r>>>14&63,n[i++]=r>>>6&255,n[i++]=r<<2&255|e[10]&3,n[i++]=e[11],n[i++]=e[12],n[i++]=e[13],n[i++]=e[14],n[i++]=e[15],n}var Te,dt,gt=d(()=>{X();I();Te={};dt=yr});function br(e){if(!N(e))throw TypeError("Invalid UUID");return parseInt(e.slice(14,15),16)}var ft,ht=d(()=>{U();ft=br});var yt={};Y(yt,{MAX:()=>je,NIL:()=>Ke,parse:()=>A,stringify:()=>We,v1:()=>Q,v1ToV6:()=>j,v3:()=>Qe,v4:()=>rt,v5:()=>at,v6:()=>ut,v6ToV1:()=>we,v7:()=>dt,validate:()=>N,version:()=>ft});var vt=d(()=>{Ve();Be();$();I();fe();he();Ze();nt();ct();lt();pt();gt();U();ht()});var Ae={};Y(Ae,{createAgent:()=>xr,createContent:()=>Ir,createJob:()=>Er,createTablesIfNotExist:()=>Nr,deleteAgent:()=>Ar,deleteContent:()=>Rr,deleteJob:()=>wr,getAgent:()=>xt,getContent:()=>St,getJob:()=>K,listAgents:()=>Se,listJobs:()=>Tr,updateAgent:()=>Sr,updateContent:()=>Lr,updateJob:()=>B});function E(e,t){throw c.error(`DynamoDB ${t} failed`,{error:e.message}),new Error(`Database operation failed: ${t}`)}function bt(e){return{...e,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}}function Et(e){return{...e,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),stages:e.stages.map(t=>({...t,startedAt:t.startedAt?new Date(t.startedAt):void 0,completedAt:t.completedAt?new Date(t.completedAt):void 0}))}}async function Er(e){try{let t=bt(e);return await b.put({TableName:l.dynamodb.jobsTable,Item:t}).promise(),c.info("Job created",{jobId:e.jobId}),e}catch(t){E(t,"createJob")}}async function K(e){try{let t=await b.get({TableName:l.dynamodb.jobsTable,Key:{jobId:e}}).promise();return t.Item?Et(t.Item):null}catch(t){E(t,"getJob")}}async function B(e,t){try{let r=await K(e);if(!r)throw new Error(`Job not found: ${e}`);let n={...r,...t,jobId:e,updatedAt:new Date},i=bt(n);return await b.put({TableName:l.dynamodb.jobsTable,Item:i}).promise(),c.info("Job updated",{jobId:e}),n}catch(r){if(r instanceof Error&&r.message.includes("not found"))throw r;E(r,"updateJob")}}async function wr(e){try{await b.delete({TableName:l.dynamodb.jobsTable,Key:{jobId:e}}).promise(),c.info("Job deleted",{jobId:e})}catch(t){E(t,"deleteJob")}}async function Tr(){try{return((await b.scan({TableName:l.dynamodb.jobsTable}).promise()).Items||[]).map(t=>Et(t))}catch(e){E(e,"listJobs")}}function wt(e){return{...e,createdAt:e.createdAt.toISOString()}}function Tt(e){return{...e,personality:{...e.personality,tone:e.personality.tone},createdAt:new Date(e.createdAt)}}async function xr(e){try{if((await Se()).some(n=>n.name===e.name&&n.id!==e.id))throw new Error(`Agent with name "${e.name}" already exists`);let r=wt(e);return await b.put({TableName:l.dynamodb.agentsTable,Item:r}).promise(),c.info("Agent created",{agentId:e.id,name:e.name}),e}catch(t){if(t instanceof Error&&t.message.includes("already exists"))throw t;E(t,"createAgent")}}async function xt(e){try{let t=await b.get({TableName:l.dynamodb.agentsTable,Key:{id:e}}).promise();return t.Item?Tt(t.Item):null}catch(t){E(t,"getAgent")}}async function Sr(e,t){try{let r=await xt(e);if(!r)throw new Error(`Agent not found: ${e}`);if(t.name&&t.name!==r.name&&(await Se()).some(s=>s.name===t.name&&s.id!==e))throw new Error(`Agent with name "${t.name}" already exists`);let n={...r,...t,id:e,personality:t.personality?{...r.personality,...t.personality}:r.personality,voice:t.voice?{...r.voice,...t.voice}:r.voice},i=wt(n);return await b.put({TableName:l.dynamodb.agentsTable,Item:i}).promise(),c.info("Agent updated",{agentId:e}),n}catch(r){if(r instanceof Error&&(r.message.includes("already exists")||r.message.includes("not found")))throw r;E(r,"updateAgent")}}async function Ar(e){try{await b.delete({TableName:l.dynamodb.agentsTable,Key:{id:e}}).promise(),c.info("Agent deleted",{agentId:e})}catch(t){E(t,"deleteAgent")}}async function Se(){try{return((await b.scan({TableName:l.dynamodb.agentsTable}).promise()).Items||[]).map(t=>Tt(t))}catch(e){E(e,"listAgents")}}async function Ir(e){try{let t={jobId:e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await b.put({TableName:l.dynamodb.contentTable,Item:t}).promise(),c.info("Content record created",{jobId:e}),t}catch(t){E(t,"createContent")}}async function St(e){try{let t=await b.get({TableName:l.dynamodb.contentTable,Key:{jobId:e}}).promise();return t.Item?t.Item:null}catch(t){E(t,"getContent")}}async function Lr(e,t){try{let r=await St(e);if(!r)throw new Error(`Content not found for job: ${e}`);let n={...r,...t,jobId:e,updatedAt:new Date().toISOString()};return await b.put({TableName:l.dynamodb.contentTable,Item:n}).promise(),c.info("Content updated",{jobId:e}),n}catch(r){if(r instanceof Error&&r.message.includes("not found"))throw r;E(r,"updateContent")}}async function Rr(e){try{await b.delete({TableName:l.dynamodb.contentTable,Key:{jobId:e}}).promise(),c.info("Content deleted",{jobId:e})}catch(t){E(t,"deleteContent")}}async function Nr(){if(!l.localstack.useLocalStack){c.info("Skipping table creation in production mode");return}let e=new xe.default.DynamoDB(k),t=[{TableName:l.dynamodb.jobsTable,KeySchema:[{AttributeName:"jobId",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:"jobId",AttributeType:"S"}]},{TableName:l.dynamodb.agentsTable,KeySchema:[{AttributeName:"id",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:"id",AttributeType:"S"}]},{TableName:l.dynamodb.contentTable,KeySchema:[{AttributeName:"jobId",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:"jobId",AttributeType:"S"}]}];for(let r of t)try{await e.describeTable({TableName:r.TableName}).promise(),c.info(`Table ${r.TableName} already exists`)}catch(n){if(n.code==="ResourceNotFoundException")try{await e.createTable({...r,BillingMode:"PAY_PER_REQUEST"}).promise(),c.info(`Table ${r.TableName} created`)}catch(i){c.error(`Failed to create table ${r.TableName}`,{error:i})}}}var xe,k,b,te=d(()=>{"use strict";xe=ne(require("aws-sdk"));_();T();k={region:l.aws.region};l.localstack.useLocalStack?(k.endpoint=l.localstack.endpoint,k.accessKeyId="test",k.secretAccessKey="test"):l.aws.accessKeyId&&l.aws.secretAccessKey&&(k.accessKeyId=l.aws.accessKeyId,k.secretAccessKey=l.aws.secretAccessKey);b=new xe.default.DynamoDB.DocumentClient(k)});var qr={};Y(qr,{scriptHandler:()=>Gr});module.exports=W(qr);T();_();T();T();var zt={maxAttempts:3,initialDelayMs:1e3,maxDelayMs:1e4,backoffMultiplier:2,retryableErrors:["ECONNRESET","ETIMEDOUT","ENOTFOUND","ECONNREFUSED"]};function Xt(e){return new Promise(t=>setTimeout(t,e))}function Qt(e,t){if(!e)return!1;if(typeof e.retryable=="boolean")return e.retryable;if(e.name&&t.includes(e.name)||e.code&&t.includes(e.code))return!0;let r=e.message?.toLowerCase()||"";return r.includes("timeout")||r.includes("connection")||r.includes("network")||r.includes("temporary")||r.includes("rate limit")||r.includes("429")||r.includes("too many requests")}async function ae(e,t={}){let r={...zt,...t},n,i=r.initialDelayMs;for(let o=1;o<=r.maxAttempts;o++)try{let s=await e();return o>1&&c.info("Operation succeeded after retry",{attempt:o}),s}catch(s){n=s;let a=Qt(s,r.retryableErrors),u=o===r.maxAttempts;if(c.warn("Operation failed",{attempt:o,maxAttempts:r.maxAttempts,isRetryable:a,error:s instanceof Error?s.message:String(s)}),!a||u)throw s;c.info("Retrying operation",{attempt:o,delayMs:i}),await Xt(i),i=Math.min(i*r.backoffMultiplier,r.maxDelayMs)}throw n}T();T();var ue=class{metrics=[];activeTimers=new Map;recordCount(t,r=1,n){this.recordMetric(t,r,"Count",n)}recordDuration(t,r,n){this.recordMetric(t,r,"Milliseconds",n)}recordSize(t,r,n){this.recordMetric(t,r,"Bytes",n)}recordRate(t,r,n){this.recordMetric(t,r,"Percent",n)}startTimer(t,r){let n=`${t}-${Date.now()}-${Math.random()}`;return this.activeTimers.set(n,{name:t,startTime:Date.now(),dimensions:r}),n}stopTimer(t){let r=this.activeTimers.get(t);if(!r)return c.warn("Attempted to stop non-existent timer",{timerId:t}),null;let n=Date.now()-r.startTime;return this.recordDuration(r.name,n,r.dimensions),this.activeTimers.delete(t),n}recordMetric(t,r,n,i){let o={name:t,value:r,unit:n,timestamp:new Date,dimensions:i};this.metrics.push(o),c.info("Metric recorded",{metric:{name:o.name,value:o.value,unit:o.unit,dimensions:o.dimensions}}),process.env.NODE_ENV==="production"&&this.publishToCloudWatch(o)}async publishToCloudWatch(t){let{publishMetric:r}=await Promise.resolve().then(()=>(Ue(),Me));await r({name:t.name,value:t.value,unit:t.unit,dimensions:t.dimensions,timestamp:t.timestamp})}getMetrics(){return[...this.metrics]}clearMetrics(){this.metrics=[]}},R=new ue;var $e={"gpt-4-turbo-preview":{input:10,output:30},"gpt-4-vision-preview":{input:10,output:30},"gpt-3.5-turbo":{input:.5,output:1.5},"claude-3-opus-20240229":{input:15,output:75},"claude-3-sonnet-20240229":{input:3,output:15},"claude-3-haiku-20240307":{input:.25,output:1.25},"openai/gpt-4-turbo-preview":{input:10,output:30},"openai/gpt-4-vision-preview":{input:10,output:30},"openai/gpt-3.5-turbo":{input:.5,output:1.5},"anthropic/claude-3-opus":{input:15,output:75},"anthropic/claude-3-sonnet":{input:3,output:15},"anthropic/claude-3-5-sonnet":{input:3,output:15},"anthropic/claude-3-haiku":{input:.25,output:1.25},"google/gemini-2.0-flash-exp:free":{input:0,output:0},"google/gemini-pro-vision":{input:0,output:0},"x-ai/grok-4.1-fast:free":{input:0,output:0},"meta-llama/llama-3.3-70b-instruct:free":{input:0,output:0},"meta-llama/llama-3.1-405b-instruct:free":{input:0,output:0},"qwen/qwen-2.5-72b-instruct:free":{input:0,output:0},"mistralai/mistral-7b-instruct:free":{input:0,output:0},default:{input:5,output:15}};function rr(e,t,r){let n=$e[e]||$e.default,i=t/1e6*n.input,o=r/1e6*n.output;return i+o}function w(e){let t={operation:e.operation,model:e.model,provider:e.provider,success:e.success.toString()};e.success?R.recordCount("LLMCallSuccess",1,t):R.recordCount("LLMCallFailure",1,{...t,errorType:e.errorType||"Unknown"}),R.recordDuration("LLMCallDuration",e.durationMs,t),R.recordCount("LLMPromptTokens",e.promptTokens,t),R.recordCount("LLMCompletionTokens",e.completionTokens,t),R.recordCount("LLMTotalTokens",e.totalTokens,t);let r=rr(e.model,e.promptTokens,e.completionTokens);R.recordCount("LLMCallCostCents",Math.round(r*100),t),c.info("LLM call metrics recorded",{...e,estimatedCost:r,costFormatted:`$${r.toFixed(4)}`})}var le=class extends Error{retryable=!0;retryAfter;constructor(t,r){super(t),this.name="RateLimitError",this.retryAfter=r}},pe=class{apiKey;baseUrl="https://openrouter.ai/api/v1";appName="PDF Lecture Service";lastRequestTime=0;minRequestInterval;constructor(t){this.apiKey=t,this.minRequestInterval=parseInt(process.env.OPENROUTER_MIN_REQUEST_INTERVAL_MS||"500",10)}async rateLimit(){let r=Date.now()-this.lastRequestTime;if(r<this.minRequestInterval){let n=this.minRequestInterval-r;c.debug("Rate limiting OpenRouter request",{waitTime:n}),await new Promise(i=>setTimeout(i,n))}this.lastRequestTime=Date.now()}parseErrorResponse(t,r){try{let n=JSON.parse(r);if(t===429||n.error?.code===429){let i=n.error?.message||"Rate limit exceeded",o=n.error?.metadata?.headers?.["X-RateLimit-Reset"];return c.warn("OpenRouter rate limit hit",{message:i,retryAfter:o,remaining:n.error?.metadata?.headers?.["X-RateLimit-Remaining"]}),new le(i,o)}return new Error(`OpenRouter API error: ${t} - ${n.error?.message||r}`)}catch{return new Error(`OpenRouter API error: ${t} - ${r}`)}}async chat(t){let r=t.model||"openai/gpt-4-turbo-preview",n=Date.now();c.info("OpenRouter chat request",{model:r,messageCount:t.messages.length});try{await this.rateLimit();let i=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","HTTP-Referer":"https://github.com/pdf-lecture-service","X-Title":this.appName},body:JSON.stringify({model:r,messages:t.messages,temperature:t.temperature??.7,max_tokens:t.maxTokens??4096,stream:t.stream??!1})});if(!i.ok){let m=await i.text();throw c.error("OpenRouter API error",{status:i.status,error:m}),this.parseErrorResponse(i.status,m)}let o=await i.json(),s=Date.now()-n,a={limit:i.headers.get("X-RateLimit-Limit"),remaining:i.headers.get("X-RateLimit-Remaining"),reset:i.headers.get("X-RateLimit-Reset")};a.remaining&&c.debug("OpenRouter rate limit status",a);let u={content:o.choices[0].message.content,model:o.model,usage:{promptTokens:o.usage?.prompt_tokens||0,completionTokens:o.usage?.completion_tokens||0,totalTokens:o.usage?.total_tokens||0}};return w({operation:"chat",model:o.model,provider:"openrouter",promptTokens:u.usage.promptTokens,completionTokens:u.usage.completionTokens,totalTokens:u.usage.totalTokens,durationMs:s,success:!0}),u}catch(i){let o=Date.now()-n;throw w({operation:"chat",model:r,provider:"openrouter",promptTokens:0,completionTokens:0,totalTokens:0,durationMs:o,success:!1,errorType:i instanceof Error?i.message:"Unknown error"}),i}}async vision(t){let r=t.model||"openai/gpt-4-vision-preview",n=Date.now();c.info("OpenRouter vision request",{model:r});try{await this.rateLimit();let i=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","HTTP-Referer":"https://github.com/pdf-lecture-service","X-Title":this.appName},body:JSON.stringify({model:r,messages:[{role:"user",content:[{type:"text",text:t.prompt},{type:"image_url",image_url:{url:t.imageUrl}}]}],max_tokens:1024})});if(!i.ok){let u=await i.text();throw c.error("OpenRouter vision API error",{status:i.status,error:u}),this.parseErrorResponse(i.status,u)}let o=await i.json(),s=Date.now()-n,a={limit:i.headers.get("X-RateLimit-Limit"),remaining:i.headers.get("X-RateLimit-Remaining"),reset:i.headers.get("X-RateLimit-Reset")};return a.remaining&&c.debug("OpenRouter rate limit status",a),w({operation:"vision",model:o.model,provider:"openrouter",promptTokens:o.usage?.prompt_tokens||0,completionTokens:o.usage?.completion_tokens||0,totalTokens:o.usage?.total_tokens||0,durationMs:s,success:!0}),o.choices[0].message.content}catch(i){let o=Date.now()-n;throw w({operation:"vision",model:r,provider:"openrouter",promptTokens:0,completionTokens:0,totalTokens:0,durationMs:o,success:!1,errorType:i instanceof Error?i.message:"Unknown error"}),i}}},me=class{apiKey;baseUrl="https://api.openai.com/v1";constructor(t){this.apiKey=t}async chat(t){let r=t.model||"gpt-4-turbo-preview",n=Date.now();c.info("OpenAI chat request",{model:r,messageCount:t.messages.length});try{let i=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:t.messages,temperature:t.temperature??.7,max_tokens:t.maxTokens??4096})});if(!i.ok){let u=await i.text();throw c.error("OpenAI API error",{status:i.status,error:u}),new Error(`OpenAI API error: ${i.status} - ${u}`)}let o=await i.json(),s=Date.now()-n,a={content:o.choices[0].message.content,model:o.model,usage:{promptTokens:o.usage.prompt_tokens,completionTokens:o.usage.completion_tokens,totalTokens:o.usage.total_tokens}};return w({operation:"chat",model:o.model,provider:"openai",promptTokens:a.usage.promptTokens,completionTokens:a.usage.completionTokens,totalTokens:a.usage.totalTokens,durationMs:s,success:!0}),a}catch(i){let o=Date.now()-n;throw w({operation:"chat",model:r,provider:"openai",promptTokens:0,completionTokens:0,totalTokens:0,durationMs:o,success:!1,errorType:i instanceof Error?i.message:"Unknown error"}),i}}async vision(t){let r=t.model||"gpt-4-vision-preview";c.info("OpenAI vision request",{model:r});let n=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:[{role:"user",content:[{type:"text",text:t.prompt},{type:"image_url",image_url:{url:t.imageUrl}}]}],max_tokens:1024})});if(!n.ok){let o=await n.text();throw c.error("OpenAI vision API error",{status:n.status,error:o}),new Error(`OpenAI vision API error: ${n.status} - ${o}`)}return(await n.json()).choices[0].message.content}},de=class{apiKey;baseUrl="https://api.anthropic.com/v1";constructor(t){this.apiKey=t}async chat(t){let r=t.model||"claude-3-opus-20240229",n=Date.now();c.info("Anthropic chat request",{model:r,messageCount:t.messages.length});try{let i=t.messages.find(p=>p.role==="system"),o=t.messages.filter(p=>p.role!=="system").map(p=>({role:p.role==="assistant"?"assistant":"user",content:p.content})),s=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"x-api-key":this.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify({model:r,messages:o,system:i?.content,temperature:t.temperature??.7,max_tokens:t.maxTokens??4096})});if(!s.ok){let p=await s.text();throw c.error("Anthropic API error",{status:s.status,error:p}),new Error(`Anthropic API error: ${s.status} - ${p}`)}let a=await s.json(),u=Date.now()-n,m={content:a.content[0].text,model:a.model,usage:{promptTokens:a.usage.input_tokens,completionTokens:a.usage.output_tokens,totalTokens:a.usage.input_tokens+a.usage.output_tokens}};return w({operation:"chat",model:a.model,provider:"anthropic",promptTokens:m.usage.promptTokens,completionTokens:m.usage.completionTokens,totalTokens:m.usage.totalTokens,durationMs:u,success:!0}),m}catch(i){let o=Date.now()-n;throw w({operation:"chat",model:r,provider:"anthropic",promptTokens:0,completionTokens:0,totalTokens:0,durationMs:o,success:!1,errorType:i instanceof Error?i.message:"Unknown error"}),i}}async vision(t){let r=t.model||"claude-3-opus-20240229";c.info("Anthropic vision request",{model:r});let n=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"x-api-key":this.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify({model:r,messages:[{role:"user",content:[{type:"image",source:{type:"url",url:t.imageUrl}},{type:"text",text:t.prompt}]}],max_tokens:1024})});if(!n.ok){let o=await n.text();throw c.error("Anthropic vision API error",{status:n.status,error:o}),new Error(`Anthropic vision API error: ${n.status} - ${o}`)}return(await n.json()).content[0].text}},ge=class{provider;client;constructor(t){this.provider=t||this.detectProvider(),this.client=this.createClient(),c.info("LLM Service initialized",{provider:this.provider})}detectProvider(){return process.env.OPENROUTER_API_KEY?"openrouter":process.env.OPENAI_API_KEY?"openai":process.env.ANTHROPIC_API_KEY?"anthropic":"openrouter"}createClient(){switch(this.provider){case"openrouter":let t=process.env.OPENROUTER_API_KEY||process.env.OPENAI_API_KEY;if(!t)throw new Error("OPENROUTER_API_KEY or OPENAI_API_KEY not set");return new pe(t);case"openai":let r=process.env.OPENAI_API_KEY;if(!r)throw new Error("OPENAI_API_KEY not set");return new me(r);case"anthropic":let n=process.env.ANTHROPIC_API_KEY;if(!n)throw new Error("ANTHROPIC_API_KEY not set");return new de(n);default:throw new Error(`Unknown provider: ${this.provider}`)}}async chat(t){let r=parseInt(process.env.LLM_MAX_RETRY_ATTEMPTS||"5",10),n=parseInt(process.env.LLM_INITIAL_RETRY_DELAY_MS||"2000",10),i=parseInt(process.env.LLM_MAX_RETRY_DELAY_MS||"30000",10);return ae(async()=>this.client.chat(t),{maxAttempts:r,initialDelayMs:n,maxDelayMs:i,backoffMultiplier:2,retryableErrors:["ECONNRESET","ETIMEDOUT","ENOTFOUND","ECONNREFUSED","RateLimitError"]})}async vision(t){let r=parseInt(process.env.LLM_VISION_MAX_RETRY_ATTEMPTS||"5",10),n=parseInt(process.env.LLM_VISION_INITIAL_RETRY_DELAY_MS||"3000",10),i=parseInt(process.env.LLM_VISION_MAX_RETRY_DELAY_MS||"60000",10);return ae(async()=>this.client.vision(t),{maxAttempts:r,initialDelayMs:n,maxDelayMs:i,backoffMultiplier:2,retryableErrors:["ECONNRESET","ETIMEDOUT","ENOTFOUND","ECONNREFUSED","RateLimitError"]})}getProvider(){return this.provider}},M=new ge,nr={analysis:{openrouter:"openai/gpt-4-turbo-preview",openai:"gpt-4-turbo-preview",anthropic:"claude-3-opus-20240229"},vision:{openrouter:"openai/gpt-4-vision-preview",openai:"gpt-4-vision-preview",anthropic:"claude-3-opus-20240229"},segmentation:{openrouter:"anthropic/claude-3-opus",openai:"gpt-4-turbo-preview",anthropic:"claude-3-opus-20240229"},script:{openrouter:"openai/gpt-4-turbo-preview",openai:"gpt-4-turbo-preview",anthropic:"claude-3-opus-20240229"},fast:{openrouter:"openai/gpt-3.5-turbo",openai:"gpt-3.5-turbo",anthropic:"claude-3-haiku-20240307"}};function Fe(e,t){let r={analysis:process.env.LLM_MODEL_ANALYSIS||"",vision:process.env.LLM_MODEL_VISION||"",segmentation:process.env.LLM_MODEL_SEGMENTATION||"",script:process.env.LLM_MODEL_SCRIPT||"",fast:process.env.LLM_MODEL_FAST||""};if(r[e])return r[e];let n=t||(process.env.OPENROUTER_API_KEY?"openrouter":"openai");return nr[e][n]}var{v4:re}=(vt(),W(yt));function Cr(){return`You are an expert science communicator creating an engaging audio lecture from scientific content.

Your goal is to:
1. Explain complex scientific concepts in clear, accessible language
2. Make the content engaging and easy to understand for a general audience
3. Provide verbal descriptions of all visual elements (figures, tables, formulas)
4. Maintain scientific accuracy while simplifying explanations
5. Create a natural, conversational flow suitable for audio narration

Guidelines:
- Use analogies and examples to clarify difficult concepts
- Define technical terms when first introduced
- Explain the significance and implications of findings
- Connect ideas to show how concepts relate to each other
- For figures: Describe what is shown, key patterns, and what it means
- For tables: Summarize the data and highlight important trends or comparisons
- For formulas: Explain what each variable represents and what the formula tells us
- Avoid phrases like "as shown in the figure" - instead describe what the figure shows
- Write in a natural speaking style, not formal academic writing
- Use complete sentences that flow well when read aloud`}function Dr(e){let t=Cr(),r=e.personality.instructions,n=e.personality.tone,i=e.personality.examples||[],o=`

PERSONALITY AND TONE:
`;switch(o+=`You are presenting as: ${e.name}
`,o+=`${r}

`,n){case"humorous":o+=`Tone: Humorous and entertaining
- Include appropriate jokes, puns, or witty observations
- Use playful analogies and comparisons
- Keep the mood light while maintaining educational value
- Don't force humor - it should feel natural
- Balance entertainment with clear explanations
`;break;case"serious":o+=`Tone: Serious and academic
- Maintain formal, professional language
- Focus on precision and accuracy
- Use scholarly vocabulary appropriately
- Emphasize the rigor and importance of the research
- Adopt a measured, authoritative delivery
`;break;case"casual":o+=`Tone: Casual and conversational
- Use everyday language and informal expressions
- Speak as if explaining to a friend
- Include relatable examples from daily life
- Keep it relaxed and approachable
- Use contractions and natural speech patterns
`;break;case"formal":o+=`Tone: Formal and structured
- Use proper academic conventions
- Maintain professional distance
- Organize information systematically
- Use precise technical terminology
- Follow traditional lecture structure
`;break;case"enthusiastic":o+=`Tone: Enthusiastic and energetic
- Express excitement about the discoveries
- Use dynamic, engaging language
- Emphasize the fascinating aspects
- Convey passion for the subject matter
- Inspire curiosity and wonder
`;break}return i.length>0&&(o+=`
Example phrases in your style:
`,i.forEach((s,a)=>{o+=`${a+1}. "${s}"
`})),t+o}function kr(e,t,r,n){let i=Dr(t),o=`

${"=".repeat(80)}
`;o+=`SEGMENT ${r+1} of ${n}: ${e.title}
`,o+=`${"=".repeat(80)}

`,r===0?o+=`CONTEXT: This is the FIRST segment. Introduce the topic and set the stage for the lecture.

`:r===n-1?o+=`CONTEXT: This is the FINAL segment. Wrap up the lecture and provide concluding thoughts.

`:o+=`CONTEXT: This is segment ${r+1} of ${n}. Build on previous concepts and prepare for what's next.

`,o+=`Create an engaging lecture script for this segment. The script should be suitable for audio narration.

`;let s=0,a=0,u=0;e.contentBlocks.forEach(p=>{p.type==="figure"&&s++,p.type==="table"&&a++,p.type==="formula"&&u++}),(s>0||a>0||u>0)&&(o+=`VISUAL ELEMENTS IN THIS SEGMENT:
`,s>0&&(o+=`- ${s} figure(s)
`),a>0&&(o+=`- ${a} table(s)
`),u>0&&(o+=`- ${u} formula(s)
`),o+=`
`),o+=`CONTENT TO COVER:

`,e.contentBlocks.forEach((p,x)=>{switch(o+=`--- Content Block ${x+1} (Page ${p.pageReference}) ---
`,p.type){case"text":o+=`Text content:
${p.content}

`;break;case"figure":let y=p.content;o+=`Figure:
`,o+=`Caption: ${y.caption||"N/A"}
`,o+=`Description: ${y.description}
`,o+=`[Provide a clear verbal description of this figure in your script]

`;break;case"table":let C=p.content;o+=`Table:
`,o+=`Headers: ${C.headers.join(", ")}
`,o+=`Interpretation: ${C.interpretation}
`,o+=`[Summarize the key data and trends from this table in your script]

`;break;case"formula":let v=p.content;o+=`Formula:
`,o+=`LaTeX: ${v.latex}
`,o+=`Explanation: ${v.explanation}
`,o+=`[Explain this formula verbally, describing what each part means]

`;break;case"citation":o+=`Citation: ${JSON.stringify(p.content)}
`,o+=`[Reference this work naturally in your explanation]

`;break}});let m=Math.max(2,Math.min(5,e.contentBlocks.length));return o+=`
LENGTH GUIDANCE:
`,o+=`Target: ${m}-${m+1} minutes of speaking time (approximately ${m*150}-${(m+1)*150} words)

`,o+=`INSTRUCTIONS:
`,o+=`1. Write a complete lecture script for this segment
`,o+=`2. Integrate all content blocks into a cohesive narrative
`,o+=`3. Provide verbal descriptions for all visual elements
`,o+=`4. Maintain your personality and tone throughout
`,o+=`5. Write in a natural speaking style suitable for audio
`,o+=`6. The script should flow smoothly when read aloud
`,o+=`7. Reference specific figures, tables, and formulas by describing what they show

`,o+=`Respond with ONLY the lecture script text, no additional formatting or metadata.
`,i+o}function Or(e,t){let r=e;switch(t.personality.tone){case"humorous":_r(r)||c.warn("Script may lack humor for humorous agent",{agentId:t.id});break;case"serious":r=At(r);break;case"casual":r=Mr(r);break;case"formal":r=At(r);break;case"enthusiastic":Pr(r)||c.warn("Script may lack enthusiasm for enthusiastic agent",{agentId:t.id});break}return r}function _r(e){return[/\b(funny|hilarious|joke|pun|amusing)\b/i,/\b(imagine|picture this|think about)\b/i,/!/,/\?.*\?/].some(r=>r.test(e))}function Pr(e){return[/\b(amazing|incredible|fascinating|remarkable|extraordinary)\b/i,/\b(exciting|wonderful|fantastic|brilliant)\b/i,/!/].some(r=>r.test(e))}function At(e){let t={"don't":"do not","doesn't":"does not","didn't":"did not","won't":"will not","wouldn't":"would not","can't":"cannot","couldn't":"could not","shouldn't":"should not","isn't":"is not","aren't":"are not","wasn't":"was not","weren't":"were not","haven't":"have not","hasn't":"has not","hadn't":"had not","it's":"it is","that's":"that is","there's":"there is","here's":"here is","what's":"what is","who's":"who is","where's":"where is","we're":"we are","they're":"they are","you're":"you are","I'm":"I am","we've":"we have","they've":"they have","you've":"you have","I've":"I have","we'll":"we will","they'll":"they will","you'll":"you will","I'll":"I will"},r=e;for(let[n,i]of Object.entries(t)){let o=new RegExp(n,"gi");r=r.replace(o,s=>s[0]===s[0].toUpperCase()?i.charAt(0).toUpperCase()+i.slice(1):i)}return r}function Mr(e){let t={"do not":"don't","does not":"doesn't","did not":"didn't","will not":"won't","would not":"wouldn't",cannot:"can't","could not":"couldn't","should not":"shouldn't","is not":"isn't","are not":"aren't","was not":"wasn't","were not":"weren't","have not":"haven't","has not":"hasn't","had not":"hadn't","it is":"it's","that is":"that's","there is":"there's","here is":"here's","what is":"what's","who is":"who's","where is":"where's","we are":"we're","they are":"they're","you are":"you're","I am":"I'm","we have":"we've","they have":"they've","you have":"you've","I have":"I've","we will":"we'll","they will":"they'll","you will":"you'll","I will":"I'll"},r=e;for(let[n,i]of Object.entries(t)){let o=new RegExp(`\\b${n}\\b`,"gi");r=r.replace(o,s=>s[0]===s[0].toUpperCase()?i.charAt(0).toUpperCase()+i.slice(1):i)}return r}function Ur(e,t=155){let i=$r(e)/t*60;return Math.round(i)}function $r(e){return e.trim().split(/\s+/).filter(r=>r.length>0).length}function Fr(e){return e.map(t=>({...t,estimatedDuration:Ur(t.text)}))}function jr(e){let t=0;for(let r of e)for(let n of r.scriptBlocks)t+=n.estimatedDuration;return t}function Vr(e){let t=`You are a lecture script writer creating engaging educational content.

AGENT PERSONALITY:
${e.personality.instructions}

TONE: ${e.personality.tone}

GUIDELINES:
- Explain complex scientific concepts in accessible language
- Reference figures, tables, and formulas with clear verbal descriptions
- Maintain the specified tone throughout
- Create a natural, conversational flow
- Use analogies and examples to clarify difficult concepts`;return e.personality.tone==="humorous"?t+`

HUMOR GUIDELINES:
- Include appropriate jokes or witty observations
- Use playful analogies
- Keep humor relevant to the content
- Don't force jokes - let them arise naturally`:e.personality.tone==="serious"?t+`

FORMAL GUIDELINES:
- Maintain academic rigor
- Use precise scientific terminology
- Avoid colloquialisms
- Focus on clarity and accuracy`:e.personality.tone==="casual"?t+`

CASUAL GUIDELINES:
- Use everyday language and informal expressions
- Speak as if explaining to a friend
- Include relatable examples from daily life
- Keep it relaxed and approachable`:e.personality.tone==="formal"?t+`

FORMAL GUIDELINES:
- Use proper academic conventions
- Maintain professional distance
- Organize information systematically
- Use precise technical terminology`:e.personality.tone==="enthusiastic"?t+`

ENTHUSIASTIC GUIDELINES:
- Express excitement about the discoveries
- Use dynamic, engaging language
- Emphasize the fascinating aspects
- Convey passion for the subject matter`:t}async function Kr(e,t){return c.info("Using mock script generation (feature flag disabled)",{agentId:t.id}),await new Promise(n=>setTimeout(n,200)),`Welcome to this segment of our lecture, presented ${t.personality.tone==="humorous"?"with a touch of humor":t.personality.tone==="serious"?"in a formal academic style":"in a conversational manner"}. 
  
In this section, we'll explore the key concepts and findings from the research. The content has been carefully organized to help you understand the material in a logical progression.

We'll examine the data, discuss the methodology, and consider the implications of these findings for the field. Throughout this presentation, I'll be referencing various figures, tables, and formulas that illustrate these important points.

Let's dive into the details and see what we can learn from this fascinating research.`}async function Br(e,t,r){if(!l.featureFlags.enableRealScriptGeneration)return c.info("Real script generation disabled by feature flag, using mock implementation",{correlationId:r,agentId:t.id}),Kr(e,t);let n=Date.now(),i=r||re(),o;try{o=Fe("script",M.getProvider()),c.info("Calling LLM for script generation",{correlationId:i,model:o,agentId:t.id,agentTone:t.personality.tone});let s=Vr(t),a=await M.chat({messages:[{role:"system",content:s},{role:"user",content:e}],model:o,temperature:.8,maxTokens:2e3}),u=Date.now()-n;return c.info("Script generation completed successfully",{correlationId:i,scriptLength:a.content.length,duration:u,tokensUsed:a.usage?.totalTokens,promptTokens:a.usage?.promptTokens,completionTokens:a.usage?.completionTokens,agentId:t.id}),a.usage&&w({operation:"script_generation",model:a.model,provider:M.getProvider(),promptTokens:a.usage.promptTokens,completionTokens:a.usage.completionTokens,totalTokens:a.usage.totalTokens,durationMs:u,success:!0}),a.content}catch(s){let a=Date.now()-n;throw w({operation:"script_generation",model:o||"unknown",provider:M.getProvider(),promptTokens:0,completionTokens:0,totalTokens:0,durationMs:a,success:!1,errorType:s instanceof Error?s.message:"Unknown error"}),c.error("Script generation LLM call failed",{correlationId:i,error:s,agentId:t.id,duration:a,errorMessage:s instanceof Error?s.message:"Unknown error",errorStack:s instanceof Error?s.stack:void 0}),new Error(`Failed to generate script: ${s instanceof Error?s.message:"Unknown error"}`)}}async function Jr(e,t,r,n,i){let o=i||re();c.info("Generating script for segment",{correlationId:o,segmentId:e.id,title:e.title,blockCount:e.contentBlocks.length,segmentIndex:r,totalSegments:n});let s=kr(e,t,r,n),a=await Br(s,t,o),u=Or(a,t),m=[];u.split(/\n\n+/).filter(y=>y.trim().length>0).forEach((y,C)=>{let v;if(e.contentBlocks.length>0){let D=Math.min(C,e.contentBlocks.length-1),O=e.contentBlocks[D];v={type:O.type,id:typeof O.content=="string"?"text":O.content.id||"unknown",pageNumber:O.pageReference}}else v={type:"text",id:"default",pageNumber:1};m.push({id:re(),text:y.trim(),contentReference:v})});let x=Fr(m);return{segmentId:e.id,title:e.title,scriptBlocks:x}}async function It(e,t){let r=`script-${e}-${re()}`;try{c.info("Starting script generation",{jobId:e,agentId:t,correlationId:r});let{getContent:n,updateContent:i,getAgent:o,updateJob:s}=(te(),W(Ae)),a=await n(e);if(!a||!a.segmentedContent)throw new Error(`No segmented content found for job: ${e}`);let u=a.segmentedContent,m=null;if(t)m=await o(t);else{let{getJob:v}=(te(),W(Ae)),D=await v(e);D&&D.agentId&&(m=await o(D.agentId))}m||(c.warn("No agent specified, using default agent"),m={id:"default",name:"Default Lecturer",description:"A clear and straightforward science communicator",personality:{instructions:"Explain concepts clearly and accessibly",tone:"casual"},voice:{voiceId:"default",speed:1,pitch:0},createdAt:new Date});let p=[],x=u.segments.length;for(let v=0;v<x;v++){let D=u.segments[v],O=`${r}-seg${v}`,Nt=await Jr(D,m,v,x,O);p.push(Nt)}let y=jr(p),C={segments:p,totalEstimatedDuration:y};return await i(e,{script:C}),await s(e,{status:"synthesizing_audio"}),c.info("Script generation completed",{jobId:e,correlationId:r,segmentCount:p.length,totalDuration:y}),C}catch(n){throw c.error("Script generation failed",{jobId:e,correlationId:r,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",errorStack:n instanceof Error?n.stack:void 0}),n}}te();var Lt=require("aws-sdk");_();T();var Yr=new Lt.EventBridge({endpoint:l.isLocal?"http://localhost:4566":void 0,region:l.awsRegion});async function Wr(e,t){let r=l.eventBusName||"pdf-lecture-service-events";try{c.info("Publishing pipeline event",{detailType:e,jobId:t.jobId});let n={Entries:[{Source:"pdf-lecture-service",DetailType:e,Detail:JSON.stringify(t),EventBusName:r}]},i=await Yr.putEvents(n).promise();if(i.FailedEntryCount&&i.FailedEntryCount>0){let o=i.Entries?.filter(s=>s.ErrorCode).map(s=>({code:s.ErrorCode,message:s.ErrorMessage}));throw new Error(`Failed to publish event: ${JSON.stringify(o)}`)}c.info("Pipeline event published successfully",{detailType:e,jobId:t.jobId})}catch(n){throw c.error("Failed to publish pipeline event",{error:n,detailType:e,jobId:t.jobId}),n}}async function Rt(e){await Wr("ScriptGenerationCompleted",{jobId:e})}T();_();async function Gr(e){try{c.info("Script generator function invoked");let t=e.jobId,r=e.agentId;if(!t)throw new Error("jobId is required");let n=await K(t);if(!n)throw new Error(`Job not found: ${t}`);await B(t,{status:"generating_script",stages:n.stages.map(o=>o.stage==="script_generation"?{...o,status:"in_progress",startedAt:new Date}:o)}),c.info("Starting script generation",{jobId:t,agentId:r});let i=await It(t,r);return await B(t,{status:"synthesizing_audio",stages:n.stages.map(o=>o.stage==="script_generation"?{...o,status:"completed",completedAt:new Date}:o.stage==="audio_synthesis"?{...o,status:"in_progress",startedAt:new Date}:o)}),c.info("Script generation completed successfully",{jobId:t}),l.nodeEnv==="production"&&(await Rt(t),c.info("Audio synthesis triggered asynchronously",{jobId:t})),{statusCode:200,body:JSON.stringify({jobId:t,status:"synthesizing_audio",message:"Script generation completed",lectureScript:{segments:i.segments.length,totalEstimatedDuration:i.totalEstimatedDuration}})}}catch(t){c.error("Script generator handler error",{error:t});let r={error:t instanceof Error?t.message:"Unknown error",code:"SCRIPT_GENERATION_FAILED",retryable:!0};if(e.jobId)try{let n=await K(e.jobId);n&&await B(e.jobId,{status:"failed",error:r.error,stages:n.stages.map(i=>i.stage==="script_generation"?{...i,status:"failed",error:r.error}:i)})}catch(n){c.error("Failed to update job status",{error:n})}return{statusCode:500,body:JSON.stringify(r)}}}0&&(module.exports={scriptHandler});
//# sourceMappingURL=script.js.map
