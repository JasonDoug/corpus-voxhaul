{
  "version": 3,
  "sources": ["../../../../../../../tmp/tmpu6nr5vk_/src/utils/logger.ts", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/dotenv/package.json", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/dotenv/lib/main.js", "../../../../../../../tmp/tmpu6nr5vk_/src/utils/config.ts", "../../../../../../../tmp/tmpu6nr5vk_/src/utils/cloudwatch.ts", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/max.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/nil.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/regex.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/validate.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/parse.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/stringify.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/rng.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/v1.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/v1ToV6.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/md5.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/v35.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/v3.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/native.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/v4.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/sha1.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/v5.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/v6.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/v6ToV1.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/v7.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/version.js", "../../../../../../../tmp/tmpu6nr5vk_/node_modules/uuid/dist-node/index.js", "../../../../../../../tmp/tmpu6nr5vk_/src/services/dynamodb.ts", "../../../../../../../tmp/tmpu6nr5vk_/src/functions/script.ts", "../../../../../../../tmp/tmpu6nr5vk_/src/services/script-generator.ts", "../../../../../../../tmp/tmpu6nr5vk_/src/services/llm.ts", "../../../../../../../tmp/tmpu6nr5vk_/src/utils/retry.ts", "../../../../../../../tmp/tmpu6nr5vk_/src/utils/llm-metrics.ts", "../../../../../../../tmp/tmpu6nr5vk_/src/utils/metrics.ts", "../../../../../../../tmp/tmpu6nr5vk_/src/services/eventbridge.ts"],
  "sourcesContent": ["// Logging utility with structured JSON logging, correlation IDs, and sensitive data redaction\n\nexport enum LogLevel {\n  ERROR = 'ERROR',\n  WARN = 'WARN',\n  INFO = 'INFO',\n  DEBUG = 'DEBUG',\n}\n\ninterface LogEntry {\n  level: LogLevel;\n  message: string;\n  timestamp: string;\n  correlationId?: string;\n  metadata?: Record<string, any>;\n  service?: string;\n  function?: string;\n}\n\n// Sensitive field patterns to redact\nconst SENSITIVE_PATTERNS = [\n  /password/i,\n  /secret/i,\n  /token/i,\n  /apikey/i,\n  /api[_-]?key/i,\n  /authorization/i,\n  /auth/i,\n  /credential/i,\n  /private[_-]?key/i,\n  /access[_-]?key/i,\n];\n\nclass Logger {\n  private correlationId?: string;\n  private serviceName?: string;\n  private functionName?: string;\n  private minLogLevel: LogLevel;\n\n  constructor() {\n    // Set minimum log level from environment or default to INFO\n    const envLogLevel = process.env.LOG_LEVEL?.toUpperCase() as LogLevel;\n    this.minLogLevel = envLogLevel || LogLevel.INFO;\n  }\n\n  setCorrelationId(id: string) {\n    this.correlationId = id;\n  }\n\n  getCorrelationId(): string | undefined {\n    return this.correlationId;\n  }\n\n  setServiceName(name: string) {\n    this.serviceName = name;\n  }\n\n  setFunctionName(name: string) {\n    this.functionName = name;\n  }\n\n  /**\n   * Redact sensitive data from metadata\n   */\n  private redactSensitiveData(data: any): any {\n    if (data === null || data === undefined) {\n      return data;\n    }\n\n    if (typeof data === 'string') {\n      return data;\n    }\n\n    if (Array.isArray(data)) {\n      return data.map(item => this.redactSensitiveData(item));\n    }\n\n    if (typeof data === 'object') {\n      const redacted: Record<string, any> = {};\n      for (const [key, value] of Object.entries(data)) {\n        // Check if key matches sensitive patterns\n        const isSensitive = SENSITIVE_PATTERNS.some(pattern => pattern.test(key));\n        \n        if (isSensitive) {\n          redacted[key] = '[REDACTED]';\n        } else if (typeof value === 'object' && value !== null) {\n          redacted[key] = this.redactSensitiveData(value);\n        } else {\n          redacted[key] = value;\n        }\n      }\n      return redacted;\n    }\n\n    return data;\n  }\n\n  /**\n   * Check if log level should be logged based on minimum level\n   */\n  private shouldLog(level: LogLevel): boolean {\n    const levels = [LogLevel.ERROR, LogLevel.WARN, LogLevel.INFO, LogLevel.DEBUG];\n    const currentLevelIndex = levels.indexOf(level);\n    const minLevelIndex = levels.indexOf(this.minLogLevel);\n    return currentLevelIndex <= minLevelIndex;\n  }\n\n  private log(level: LogLevel, message: string, metadata?: Record<string, any>) {\n    if (!this.shouldLog(level)) {\n      return;\n    }\n\n    const entry: LogEntry = {\n      level,\n      message,\n      timestamp: new Date().toISOString(),\n      correlationId: this.correlationId,\n      service: this.serviceName,\n      function: this.functionName,\n      metadata: metadata ? this.redactSensitiveData(metadata) : undefined,\n    };\n    \n    // Output as JSON for structured logging\n    console.log(JSON.stringify(entry));\n  }\n\n  error(message: string, metadata?: Record<string, any>) {\n    this.log(LogLevel.ERROR, message, metadata);\n  }\n\n  warn(message: string, metadata?: Record<string, any>) {\n    this.log(LogLevel.WARN, message, metadata);\n  }\n\n  info(message: string, metadata?: Record<string, any>) {\n    this.log(LogLevel.INFO, message, metadata);\n  }\n\n  debug(message: string, metadata?: Record<string, any>) {\n    this.log(LogLevel.DEBUG, message, metadata);\n  }\n\n  /**\n   * Create a child logger with a specific correlation ID\n   */\n  child(correlationId: string): Logger {\n    const childLogger = new Logger();\n    childLogger.setCorrelationId(correlationId);\n    childLogger.setServiceName(this.serviceName || '');\n    childLogger.setFunctionName(this.functionName || '');\n    return childLogger;\n  }\n}\n\nexport const logger = new Logger();\n", "{\n  \"name\": \"dotenv\",\n  \"version\": \"16.6.1\",\n  \"description\": \"Loads environment variables from .env file\",\n  \"main\": \"lib/main.js\",\n  \"types\": \"lib/main.d.ts\",\n  \"exports\": {\n    \".\": {\n      \"types\": \"./lib/main.d.ts\",\n      \"require\": \"./lib/main.js\",\n      \"default\": \"./lib/main.js\"\n    },\n    \"./config\": \"./config.js\",\n    \"./config.js\": \"./config.js\",\n    \"./lib/env-options\": \"./lib/env-options.js\",\n    \"./lib/env-options.js\": \"./lib/env-options.js\",\n    \"./lib/cli-options\": \"./lib/cli-options.js\",\n    \"./lib/cli-options.js\": \"./lib/cli-options.js\",\n    \"./package.json\": \"./package.json\"\n  },\n  \"scripts\": {\n    \"dts-check\": \"tsc --project tests/types/tsconfig.json\",\n    \"lint\": \"standard\",\n    \"pretest\": \"npm run lint && npm run dts-check\",\n    \"test\": \"tap run --allow-empty-coverage --disable-coverage --timeout=60000\",\n    \"test:coverage\": \"tap run --show-full-coverage --timeout=60000 --coverage-report=text --coverage-report=lcov\",\n    \"prerelease\": \"npm test\",\n    \"release\": \"standard-version\"\n  },\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"git://github.com/motdotla/dotenv.git\"\n  },\n  \"homepage\": \"https://github.com/motdotla/dotenv#readme\",\n  \"funding\": \"https://dotenvx.com\",\n  \"keywords\": [\n    \"dotenv\",\n    \"env\",\n    \".env\",\n    \"environment\",\n    \"variables\",\n    \"config\",\n    \"settings\"\n  ],\n  \"readmeFilename\": \"README.md\",\n  \"license\": \"BSD-2-Clause\",\n  \"devDependencies\": {\n    \"@types/node\": \"^18.11.3\",\n    \"decache\": \"^4.6.2\",\n    \"sinon\": \"^14.0.1\",\n    \"standard\": \"^17.0.0\",\n    \"standard-version\": \"^9.5.0\",\n    \"tap\": \"^19.2.0\",\n    \"typescript\": \"^4.8.4\"\n  },\n  \"engines\": {\n    \"node\": \">=12\"\n  },\n  \"browser\": {\n    \"fs\": false\n  }\n}\n", "const fs = require('fs')\nconst path = require('path')\nconst os = require('os')\nconst crypto = require('crypto')\nconst packageJson = require('../package.json')\n\nconst version = packageJson.version\n\nconst LINE = /(?:^|^)\\s*(?:export\\s+)?([\\w.-]+)(?:\\s*=\\s*?|:\\s+?)(\\s*'(?:\\\\'|[^'])*'|\\s*\"(?:\\\\\"|[^\"])*\"|\\s*`(?:\\\\`|[^`])*`|[^#\\r\\n]+)?\\s*(?:#.*)?(?:$|$)/mg\n\n// Parse src into an Object\nfunction parse (src) {\n  const obj = {}\n\n  // Convert buffer to string\n  let lines = src.toString()\n\n  // Convert line breaks to same format\n  lines = lines.replace(/\\r\\n?/mg, '\\n')\n\n  let match\n  while ((match = LINE.exec(lines)) != null) {\n    const key = match[1]\n\n    // Default undefined or null to empty string\n    let value = (match[2] || '')\n\n    // Remove whitespace\n    value = value.trim()\n\n    // Check if double quoted\n    const maybeQuote = value[0]\n\n    // Remove surrounding quotes\n    value = value.replace(/^(['\"`])([\\s\\S]*)\\1$/mg, '$2')\n\n    // Expand newlines if double quoted\n    if (maybeQuote === '\"') {\n      value = value.replace(/\\\\n/g, '\\n')\n      value = value.replace(/\\\\r/g, '\\r')\n    }\n\n    // Add to object\n    obj[key] = value\n  }\n\n  return obj\n}\n\nfunction _parseVault (options) {\n  options = options || {}\n\n  const vaultPath = _vaultPath(options)\n  options.path = vaultPath // parse .env.vault\n  const result = DotenvModule.configDotenv(options)\n  if (!result.parsed) {\n    const err = new Error(`MISSING_DATA: Cannot parse ${vaultPath} for an unknown reason`)\n    err.code = 'MISSING_DATA'\n    throw err\n  }\n\n  // handle scenario for comma separated keys - for use with key rotation\n  // example: DOTENV_KEY=\"dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=prod,dotenv://:key_7890@dotenvx.com/vault/.env.vault?environment=prod\"\n  const keys = _dotenvKey(options).split(',')\n  const length = keys.length\n\n  let decrypted\n  for (let i = 0; i < length; i++) {\n    try {\n      // Get full key\n      const key = keys[i].trim()\n\n      // Get instructions for decrypt\n      const attrs = _instructions(result, key)\n\n      // Decrypt\n      decrypted = DotenvModule.decrypt(attrs.ciphertext, attrs.key)\n\n      break\n    } catch (error) {\n      // last key\n      if (i + 1 >= length) {\n        throw error\n      }\n      // try next key\n    }\n  }\n\n  // Parse decrypted .env string\n  return DotenvModule.parse(decrypted)\n}\n\nfunction _warn (message) {\n  console.log(`[dotenv@${version}][WARN] ${message}`)\n}\n\nfunction _debug (message) {\n  console.log(`[dotenv@${version}][DEBUG] ${message}`)\n}\n\nfunction _log (message) {\n  console.log(`[dotenv@${version}] ${message}`)\n}\n\nfunction _dotenvKey (options) {\n  // prioritize developer directly setting options.DOTENV_KEY\n  if (options && options.DOTENV_KEY && options.DOTENV_KEY.length > 0) {\n    return options.DOTENV_KEY\n  }\n\n  // secondary infra already contains a DOTENV_KEY environment variable\n  if (process.env.DOTENV_KEY && process.env.DOTENV_KEY.length > 0) {\n    return process.env.DOTENV_KEY\n  }\n\n  // fallback to empty string\n  return ''\n}\n\nfunction _instructions (result, dotenvKey) {\n  // Parse DOTENV_KEY. Format is a URI\n  let uri\n  try {\n    uri = new URL(dotenvKey)\n  } catch (error) {\n    if (error.code === 'ERR_INVALID_URL') {\n      const err = new Error('INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development')\n      err.code = 'INVALID_DOTENV_KEY'\n      throw err\n    }\n\n    throw error\n  }\n\n  // Get decrypt key\n  const key = uri.password\n  if (!key) {\n    const err = new Error('INVALID_DOTENV_KEY: Missing key part')\n    err.code = 'INVALID_DOTENV_KEY'\n    throw err\n  }\n\n  // Get environment\n  const environment = uri.searchParams.get('environment')\n  if (!environment) {\n    const err = new Error('INVALID_DOTENV_KEY: Missing environment part')\n    err.code = 'INVALID_DOTENV_KEY'\n    throw err\n  }\n\n  // Get ciphertext payload\n  const environmentKey = `DOTENV_VAULT_${environment.toUpperCase()}`\n  const ciphertext = result.parsed[environmentKey] // DOTENV_VAULT_PRODUCTION\n  if (!ciphertext) {\n    const err = new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${environmentKey} in your .env.vault file.`)\n    err.code = 'NOT_FOUND_DOTENV_ENVIRONMENT'\n    throw err\n  }\n\n  return { ciphertext, key }\n}\n\nfunction _vaultPath (options) {\n  let possibleVaultPath = null\n\n  if (options && options.path && options.path.length > 0) {\n    if (Array.isArray(options.path)) {\n      for (const filepath of options.path) {\n        if (fs.existsSync(filepath)) {\n          possibleVaultPath = filepath.endsWith('.vault') ? filepath : `${filepath}.vault`\n        }\n      }\n    } else {\n      possibleVaultPath = options.path.endsWith('.vault') ? options.path : `${options.path}.vault`\n    }\n  } else {\n    possibleVaultPath = path.resolve(process.cwd(), '.env.vault')\n  }\n\n  if (fs.existsSync(possibleVaultPath)) {\n    return possibleVaultPath\n  }\n\n  return null\n}\n\nfunction _resolveHome (envPath) {\n  return envPath[0] === '~' ? path.join(os.homedir(), envPath.slice(1)) : envPath\n}\n\nfunction _configVault (options) {\n  const debug = Boolean(options && options.debug)\n  const quiet = options && 'quiet' in options ? options.quiet : true\n\n  if (debug || !quiet) {\n    _log('Loading env from encrypted .env.vault')\n  }\n\n  const parsed = DotenvModule._parseVault(options)\n\n  let processEnv = process.env\n  if (options && options.processEnv != null) {\n    processEnv = options.processEnv\n  }\n\n  DotenvModule.populate(processEnv, parsed, options)\n\n  return { parsed }\n}\n\nfunction configDotenv (options) {\n  const dotenvPath = path.resolve(process.cwd(), '.env')\n  let encoding = 'utf8'\n  const debug = Boolean(options && options.debug)\n  const quiet = options && 'quiet' in options ? options.quiet : true\n\n  if (options && options.encoding) {\n    encoding = options.encoding\n  } else {\n    if (debug) {\n      _debug('No encoding is specified. UTF-8 is used by default')\n    }\n  }\n\n  let optionPaths = [dotenvPath] // default, look for .env\n  if (options && options.path) {\n    if (!Array.isArray(options.path)) {\n      optionPaths = [_resolveHome(options.path)]\n    } else {\n      optionPaths = [] // reset default\n      for (const filepath of options.path) {\n        optionPaths.push(_resolveHome(filepath))\n      }\n    }\n  }\n\n  // Build the parsed data in a temporary object (because we need to return it).  Once we have the final\n  // parsed data, we will combine it with process.env (or options.processEnv if provided).\n  let lastError\n  const parsedAll = {}\n  for (const path of optionPaths) {\n    try {\n      // Specifying an encoding returns a string instead of a buffer\n      const parsed = DotenvModule.parse(fs.readFileSync(path, { encoding }))\n\n      DotenvModule.populate(parsedAll, parsed, options)\n    } catch (e) {\n      if (debug) {\n        _debug(`Failed to load ${path} ${e.message}`)\n      }\n      lastError = e\n    }\n  }\n\n  let processEnv = process.env\n  if (options && options.processEnv != null) {\n    processEnv = options.processEnv\n  }\n\n  DotenvModule.populate(processEnv, parsedAll, options)\n\n  if (debug || !quiet) {\n    const keysCount = Object.keys(parsedAll).length\n    const shortPaths = []\n    for (const filePath of optionPaths) {\n      try {\n        const relative = path.relative(process.cwd(), filePath)\n        shortPaths.push(relative)\n      } catch (e) {\n        if (debug) {\n          _debug(`Failed to load ${filePath} ${e.message}`)\n        }\n        lastError = e\n      }\n    }\n\n    _log(`injecting env (${keysCount}) from ${shortPaths.join(',')}`)\n  }\n\n  if (lastError) {\n    return { parsed: parsedAll, error: lastError }\n  } else {\n    return { parsed: parsedAll }\n  }\n}\n\n// Populates process.env from .env file\nfunction config (options) {\n  // fallback to original dotenv if DOTENV_KEY is not set\n  if (_dotenvKey(options).length === 0) {\n    return DotenvModule.configDotenv(options)\n  }\n\n  const vaultPath = _vaultPath(options)\n\n  // dotenvKey exists but .env.vault file does not exist\n  if (!vaultPath) {\n    _warn(`You set DOTENV_KEY but you are missing a .env.vault file at ${vaultPath}. Did you forget to build it?`)\n\n    return DotenvModule.configDotenv(options)\n  }\n\n  return DotenvModule._configVault(options)\n}\n\nfunction decrypt (encrypted, keyStr) {\n  const key = Buffer.from(keyStr.slice(-64), 'hex')\n  let ciphertext = Buffer.from(encrypted, 'base64')\n\n  const nonce = ciphertext.subarray(0, 12)\n  const authTag = ciphertext.subarray(-16)\n  ciphertext = ciphertext.subarray(12, -16)\n\n  try {\n    const aesgcm = crypto.createDecipheriv('aes-256-gcm', key, nonce)\n    aesgcm.setAuthTag(authTag)\n    return `${aesgcm.update(ciphertext)}${aesgcm.final()}`\n  } catch (error) {\n    const isRange = error instanceof RangeError\n    const invalidKeyLength = error.message === 'Invalid key length'\n    const decryptionFailed = error.message === 'Unsupported state or unable to authenticate data'\n\n    if (isRange || invalidKeyLength) {\n      const err = new Error('INVALID_DOTENV_KEY: It must be 64 characters long (or more)')\n      err.code = 'INVALID_DOTENV_KEY'\n      throw err\n    } else if (decryptionFailed) {\n      const err = new Error('DECRYPTION_FAILED: Please check your DOTENV_KEY')\n      err.code = 'DECRYPTION_FAILED'\n      throw err\n    } else {\n      throw error\n    }\n  }\n}\n\n// Populate process.env with parsed values\nfunction populate (processEnv, parsed, options = {}) {\n  const debug = Boolean(options && options.debug)\n  const override = Boolean(options && options.override)\n\n  if (typeof parsed !== 'object') {\n    const err = new Error('OBJECT_REQUIRED: Please check the processEnv argument being passed to populate')\n    err.code = 'OBJECT_REQUIRED'\n    throw err\n  }\n\n  // Set process.env\n  for (const key of Object.keys(parsed)) {\n    if (Object.prototype.hasOwnProperty.call(processEnv, key)) {\n      if (override === true) {\n        processEnv[key] = parsed[key]\n      }\n\n      if (debug) {\n        if (override === true) {\n          _debug(`\"${key}\" is already defined and WAS overwritten`)\n        } else {\n          _debug(`\"${key}\" is already defined and was NOT overwritten`)\n        }\n      }\n    } else {\n      processEnv[key] = parsed[key]\n    }\n  }\n}\n\nconst DotenvModule = {\n  configDotenv,\n  _configVault,\n  _parseVault,\n  config,\n  decrypt,\n  parse,\n  populate\n}\n\nmodule.exports.configDotenv = DotenvModule.configDotenv\nmodule.exports._configVault = DotenvModule._configVault\nmodule.exports._parseVault = DotenvModule._parseVault\nmodule.exports.config = DotenvModule.config\nmodule.exports.decrypt = DotenvModule.decrypt\nmodule.exports.parse = DotenvModule.parse\nmodule.exports.populate = DotenvModule.populate\n\nmodule.exports = DotenvModule\n", "// Configuration utilities\nimport dotenv from 'dotenv';\n\ndotenv.config();\n\nexport const config = {\n  nodeEnv: process.env.NODE_ENV || 'development',\n  port: parseInt(process.env.PORT || '3000', 10),\n  localMode: process.env.LOCAL_MODE === 'true',\n  isLocal: process.env.NODE_ENV !== 'production',\n  awsRegion: process.env.AWS_REGION || 'us-east-1',\n  eventBusName: process.env.EVENT_BUS_NAME || 'pdf-lecture-service-events',\n  \n  aws: {\n    region: process.env.AWS_REGION || 'us-east-1',\n    accessKeyId: process.env.AWS_ACCESS_KEY_ID,\n    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,\n  },\n  \n  localstack: {\n    endpoint: process.env.LOCALSTACK_ENDPOINT || 'http://localhost:4566',\n    useLocalStack: process.env.USE_LOCALSTACK === 'true',\n  },\n  \n  s3: {\n    bucketName: process.env.S3_BUCKET_NAME || 'pdf-lecture-service',\n    pdfPrefix: process.env.S3_PDF_PREFIX || 'pdfs',\n    audioPrefix: process.env.S3_AUDIO_PREFIX || 'audio',\n    cachePrefix: process.env.S3_CACHE_PREFIX || 'cache',\n  },\n  \n  dynamodb: {\n    jobsTable: process.env.DYNAMODB_JOBS_TABLE || 'pdf-lecture-jobs',\n    agentsTable: process.env.DYNAMODB_AGENTS_TABLE || 'pdf-lecture-agents',\n    contentTable: process.env.DYNAMODB_CONTENT_TABLE || 'pdf-lecture-content',\n  },\n  \n  processing: {\n    maxPdfSizeMB: parseInt(process.env.MAX_PDF_SIZE_MB || '100', 10),\n    analysisTimeoutMs: parseInt(process.env.ANALYSIS_TIMEOUT_MS || '300000', 10),\n    audioSynthesisTimeoutMs: parseInt(process.env.AUDIO_SYNTHESIS_TIMEOUT_MS || '600000', 10),\n  },\n  \n  featureFlags: {\n    enableRealSegmentation: process.env.ENABLE_REAL_SEGMENTATION === 'true',\n    enableRealScriptGeneration: process.env.ENABLE_REAL_SCRIPT_GENERATION === 'true',\n    enableImageExtraction: process.env.ENABLE_IMAGE_EXTRACTION === 'true',\n    enableVisionFirstPipeline: process.env.ENABLE_VISION_FIRST_PIPELINE === 'true',\n  },\n  \n  vision: {\n    model: process.env.VISION_MODEL || 'google/gemini-2.0-flash-exp:free',\n    temperature: parseFloat(process.env.VISION_LLM_TEMPERATURE || '0.3'),\n    maxTokens: parseInt(process.env.VISION_LLM_MAX_TOKENS || '4000', 10),\n  },\n};\n", "// CloudWatch integration for metrics and logs\nimport * as AWS from 'aws-sdk';\nimport { config } from './config';\nimport { logger } from './logger';\n\n// Initialize CloudWatch client\nconst cloudwatch = new AWS.CloudWatch({\n  region: config.aws.region,\n  ...(config.localstack.useLocalStack && {\n    endpoint: config.localstack.endpoint,\n  }),\n});\n\nexport interface CloudWatchMetric {\n  name: string;\n  value: number;\n  unit: string;\n  dimensions?: Record<string, string>;\n  timestamp?: Date;\n}\n\n/**\n * Publish a single metric to CloudWatch\n */\nexport async function publishMetric(metric: CloudWatchMetric): Promise<void> {\n  // Skip CloudWatch publishing in local mode\n  if (config.isLocal && !config.localstack.useLocalStack) {\n    logger.debug('Skipping CloudWatch metric in local mode', { metric });\n    return;\n  }\n\n  try {\n    const dimensions = metric.dimensions\n      ? Object.entries(metric.dimensions).map(([name, value]) => ({\n          Name: name,\n          Value: value,\n        }))\n      : [];\n\n    await cloudwatch\n      .putMetricData({\n        Namespace: 'PDFLectureService',\n        MetricData: [\n          {\n            MetricName: metric.name,\n            Value: metric.value,\n            Unit: metric.unit as any,\n            Timestamp: metric.timestamp || new Date(),\n            Dimensions: dimensions,\n          },\n        ],\n      })\n      .promise();\n\n    logger.debug('Metric published to CloudWatch', { metric });\n  } catch (error) {\n    logger.error('Failed to publish metric to CloudWatch', {\n      metric,\n      error: error instanceof Error ? error.message : String(error),\n    });\n  }\n}\n\n/**\n * Publish multiple metrics to CloudWatch in a batch\n */\nexport async function publishMetrics(metrics: CloudWatchMetric[]): Promise<void> {\n  // Skip CloudWatch publishing in local mode\n  if (config.isLocal && !config.localstack.useLocalStack) {\n    logger.debug('Skipping CloudWatch metrics in local mode', { count: metrics.length });\n    return;\n  }\n\n  try {\n    const metricData = metrics.map((metric) => {\n      const dimensions = metric.dimensions\n        ? Object.entries(metric.dimensions).map(([name, value]) => ({\n            Name: name,\n            Value: value,\n          }))\n        : [];\n\n      return {\n        MetricName: metric.name,\n        Value: metric.value,\n        Unit: metric.unit as any,\n        Timestamp: metric.timestamp || new Date(),\n        Dimensions: dimensions,\n      };\n    });\n\n    // CloudWatch allows max 20 metrics per request\n    const batchSize = 20;\n    for (let i = 0; i < metricData.length; i += batchSize) {\n      const batch = metricData.slice(i, i + batchSize);\n      await cloudwatch\n        .putMetricData({\n          Namespace: 'PDFLectureService',\n          MetricData: batch,\n        })\n        .promise();\n    }\n\n    logger.debug('Metrics published to CloudWatch', { count: metrics.length });\n  } catch (error) {\n    logger.error('Failed to publish metrics to CloudWatch', {\n      count: metrics.length,\n      error: error instanceof Error ? error.message : String(error),\n    });\n  }\n}\n\n/**\n * Create a CloudWatch alarm programmatically\n */\nexport async function createAlarm(params: {\n  alarmName: string;\n  metricName: string;\n  threshold: number;\n  comparisonOperator: string;\n  evaluationPeriods: number;\n  period: number;\n  statistic: string;\n  dimensions?: Record<string, string>;\n}): Promise<void> {\n  try {\n    const dimensions = params.dimensions\n      ? Object.entries(params.dimensions).map(([name, value]) => ({\n          Name: name,\n          Value: value,\n        }))\n      : [];\n\n    await cloudwatch\n      .putMetricAlarm({\n        AlarmName: params.alarmName,\n        MetricName: params.metricName,\n        Namespace: 'PDFLectureService',\n        Statistic: params.statistic,\n        Period: params.period,\n        EvaluationPeriods: params.evaluationPeriods,\n        Threshold: params.threshold,\n        ComparisonOperator: params.comparisonOperator,\n        Dimensions: dimensions,\n        TreatMissingData: 'notBreaching',\n      })\n      .promise();\n\n    logger.info('CloudWatch alarm created', { alarmName: params.alarmName });\n  } catch (error) {\n    logger.error('Failed to create CloudWatch alarm', {\n      alarmName: params.alarmName,\n      error: error instanceof Error ? error.message : String(error),\n    });\n  }\n}\n\n/**\n * Helper to create standard alarms for a Lambda function\n */\nexport async function createStandardAlarmsForFunction(\n  functionName: string,\n  timeoutMs: number\n): Promise<void> {\n  // Error rate alarm\n  await createAlarm({\n    alarmName: `${functionName}-ErrorRate`,\n    metricName: 'Errors',\n    threshold: 5,\n    comparisonOperator: 'GreaterThanThreshold',\n    evaluationPeriods: 1,\n    period: 300,\n    statistic: 'Sum',\n    dimensions: { FunctionName: functionName },\n  });\n\n  // Timeout alarm (90% of actual timeout)\n  await createAlarm({\n    alarmName: `${functionName}-Timeout`,\n    metricName: 'Duration',\n    threshold: timeoutMs * 0.9,\n    comparisonOperator: 'GreaterThanThreshold',\n    evaluationPeriods: 1,\n    period: 300,\n    statistic: 'Maximum',\n    dimensions: { FunctionName: functionName },\n  });\n\n  // Throttle alarm\n  await createAlarm({\n    alarmName: `${functionName}-Throttles`,\n    metricName: 'Throttles',\n    threshold: 1,\n    comparisonOperator: 'GreaterThanThreshold',\n    evaluationPeriods: 1,\n    period: 300,\n    statistic: 'Sum',\n    dimensions: { FunctionName: functionName },\n  });\n}\n", "export default 'ffffffff-ffff-ffff-ffff-ffffffffffff';\n", "export default '00000000-0000-0000-0000-000000000000';\n", "export default /^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;\n", "import REGEX from './regex.js';\nfunction validate(uuid) {\n    return typeof uuid === 'string' && REGEX.test(uuid);\n}\nexport default validate;\n", "import validate from './validate.js';\nfunction parse(uuid) {\n    if (!validate(uuid)) {\n        throw TypeError('Invalid UUID');\n    }\n    let v;\n    return Uint8Array.of((v = parseInt(uuid.slice(0, 8), 16)) >>> 24, (v >>> 16) & 0xff, (v >>> 8) & 0xff, v & 0xff, (v = parseInt(uuid.slice(9, 13), 16)) >>> 8, v & 0xff, (v = parseInt(uuid.slice(14, 18), 16)) >>> 8, v & 0xff, (v = parseInt(uuid.slice(19, 23), 16)) >>> 8, v & 0xff, ((v = parseInt(uuid.slice(24, 36), 16)) / 0x10000000000) & 0xff, (v / 0x100000000) & 0xff, (v >>> 24) & 0xff, (v >>> 16) & 0xff, (v >>> 8) & 0xff, v & 0xff);\n}\nexport default parse;\n", "import validate from './validate.js';\nconst byteToHex = [];\nfor (let i = 0; i < 256; ++i) {\n    byteToHex.push((i + 0x100).toString(16).slice(1));\n}\nexport function unsafeStringify(arr, offset = 0) {\n    return (byteToHex[arr[offset + 0]] +\n        byteToHex[arr[offset + 1]] +\n        byteToHex[arr[offset + 2]] +\n        byteToHex[arr[offset + 3]] +\n        '-' +\n        byteToHex[arr[offset + 4]] +\n        byteToHex[arr[offset + 5]] +\n        '-' +\n        byteToHex[arr[offset + 6]] +\n        byteToHex[arr[offset + 7]] +\n        '-' +\n        byteToHex[arr[offset + 8]] +\n        byteToHex[arr[offset + 9]] +\n        '-' +\n        byteToHex[arr[offset + 10]] +\n        byteToHex[arr[offset + 11]] +\n        byteToHex[arr[offset + 12]] +\n        byteToHex[arr[offset + 13]] +\n        byteToHex[arr[offset + 14]] +\n        byteToHex[arr[offset + 15]]).toLowerCase();\n}\nfunction stringify(arr, offset = 0) {\n    const uuid = unsafeStringify(arr, offset);\n    if (!validate(uuid)) {\n        throw TypeError('Stringified UUID is invalid');\n    }\n    return uuid;\n}\nexport default stringify;\n", "import { randomFillSync } from 'node:crypto';\nconst rnds8Pool = new Uint8Array(256);\nlet poolPtr = rnds8Pool.length;\nexport default function rng() {\n    if (poolPtr > rnds8Pool.length - 16) {\n        randomFillSync(rnds8Pool);\n        poolPtr = 0;\n    }\n    return rnds8Pool.slice(poolPtr, (poolPtr += 16));\n}\n", "import rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\nconst _state = {};\nfunction v1(options, buf, offset) {\n    let bytes;\n    const isV6 = options?._v6 ?? false;\n    if (options) {\n        const optionsKeys = Object.keys(options);\n        if (optionsKeys.length === 1 && optionsKeys[0] === '_v6') {\n            options = undefined;\n        }\n    }\n    if (options) {\n        bytes = v1Bytes(options.random ?? options.rng?.() ?? rng(), options.msecs, options.nsecs, options.clockseq, options.node, buf, offset);\n    }\n    else {\n        const now = Date.now();\n        const rnds = rng();\n        updateV1State(_state, now, rnds);\n        bytes = v1Bytes(rnds, _state.msecs, _state.nsecs, isV6 ? undefined : _state.clockseq, isV6 ? undefined : _state.node, buf, offset);\n    }\n    return buf ?? unsafeStringify(bytes);\n}\nexport function updateV1State(state, now, rnds) {\n    state.msecs ??= -Infinity;\n    state.nsecs ??= 0;\n    if (now === state.msecs) {\n        state.nsecs++;\n        if (state.nsecs >= 10000) {\n            state.node = undefined;\n            state.nsecs = 0;\n        }\n    }\n    else if (now > state.msecs) {\n        state.nsecs = 0;\n    }\n    else if (now < state.msecs) {\n        state.node = undefined;\n    }\n    if (!state.node) {\n        state.node = rnds.slice(10, 16);\n        state.node[0] |= 0x01;\n        state.clockseq = ((rnds[8] << 8) | rnds[9]) & 0x3fff;\n    }\n    state.msecs = now;\n    return state;\n}\nfunction v1Bytes(rnds, msecs, nsecs, clockseq, node, buf, offset = 0) {\n    if (rnds.length < 16) {\n        throw new Error('Random bytes length must be >= 16');\n    }\n    if (!buf) {\n        buf = new Uint8Array(16);\n        offset = 0;\n    }\n    else {\n        if (offset < 0 || offset + 16 > buf.length) {\n            throw new RangeError(`UUID byte range ${offset}:${offset + 15} is out of buffer bounds`);\n        }\n    }\n    msecs ??= Date.now();\n    nsecs ??= 0;\n    clockseq ??= ((rnds[8] << 8) | rnds[9]) & 0x3fff;\n    node ??= rnds.slice(10, 16);\n    msecs += 12219292800000;\n    const tl = ((msecs & 0xfffffff) * 10000 + nsecs) % 0x100000000;\n    buf[offset++] = (tl >>> 24) & 0xff;\n    buf[offset++] = (tl >>> 16) & 0xff;\n    buf[offset++] = (tl >>> 8) & 0xff;\n    buf[offset++] = tl & 0xff;\n    const tmh = ((msecs / 0x100000000) * 10000) & 0xfffffff;\n    buf[offset++] = (tmh >>> 8) & 0xff;\n    buf[offset++] = tmh & 0xff;\n    buf[offset++] = ((tmh >>> 24) & 0xf) | 0x10;\n    buf[offset++] = (tmh >>> 16) & 0xff;\n    buf[offset++] = (clockseq >>> 8) | 0x80;\n    buf[offset++] = clockseq & 0xff;\n    for (let n = 0; n < 6; ++n) {\n        buf[offset++] = node[n];\n    }\n    return buf;\n}\nexport default v1;\n", "import parse from './parse.js';\nimport { unsafeStringify } from './stringify.js';\nexport default function v1ToV6(uuid) {\n    const v1Bytes = typeof uuid === 'string' ? parse(uuid) : uuid;\n    const v6Bytes = _v1ToV6(v1Bytes);\n    return typeof uuid === 'string' ? unsafeStringify(v6Bytes) : v6Bytes;\n}\nfunction _v1ToV6(v1Bytes) {\n    return Uint8Array.of(((v1Bytes[6] & 0x0f) << 4) | ((v1Bytes[7] >> 4) & 0x0f), ((v1Bytes[7] & 0x0f) << 4) | ((v1Bytes[4] & 0xf0) >> 4), ((v1Bytes[4] & 0x0f) << 4) | ((v1Bytes[5] & 0xf0) >> 4), ((v1Bytes[5] & 0x0f) << 4) | ((v1Bytes[0] & 0xf0) >> 4), ((v1Bytes[0] & 0x0f) << 4) | ((v1Bytes[1] & 0xf0) >> 4), ((v1Bytes[1] & 0x0f) << 4) | ((v1Bytes[2] & 0xf0) >> 4), 0x60 | (v1Bytes[2] & 0x0f), v1Bytes[3], v1Bytes[8], v1Bytes[9], v1Bytes[10], v1Bytes[11], v1Bytes[12], v1Bytes[13], v1Bytes[14], v1Bytes[15]);\n}\n", "import { createHash } from 'node:crypto';\nfunction md5(bytes) {\n    if (Array.isArray(bytes)) {\n        bytes = Buffer.from(bytes);\n    }\n    else if (typeof bytes === 'string') {\n        bytes = Buffer.from(bytes, 'utf8');\n    }\n    return createHash('md5').update(bytes).digest();\n}\nexport default md5;\n", "import parse from './parse.js';\nimport { unsafeStringify } from './stringify.js';\nexport function stringToBytes(str) {\n    str = unescape(encodeURIComponent(str));\n    const bytes = new Uint8Array(str.length);\n    for (let i = 0; i < str.length; ++i) {\n        bytes[i] = str.charCodeAt(i);\n    }\n    return bytes;\n}\nexport const DNS = '6ba7b810-9dad-11d1-80b4-00c04fd430c8';\nexport const URL = '6ba7b811-9dad-11d1-80b4-00c04fd430c8';\nexport default function v35(version, hash, value, namespace, buf, offset) {\n    const valueBytes = typeof value === 'string' ? stringToBytes(value) : value;\n    const namespaceBytes = typeof namespace === 'string' ? parse(namespace) : namespace;\n    if (typeof namespace === 'string') {\n        namespace = parse(namespace);\n    }\n    if (namespace?.length !== 16) {\n        throw TypeError('Namespace must be array-like (16 iterable integer values, 0-255)');\n    }\n    let bytes = new Uint8Array(16 + valueBytes.length);\n    bytes.set(namespaceBytes);\n    bytes.set(valueBytes, namespaceBytes.length);\n    bytes = hash(bytes);\n    bytes[6] = (bytes[6] & 0x0f) | version;\n    bytes[8] = (bytes[8] & 0x3f) | 0x80;\n    if (buf) {\n        offset = offset || 0;\n        for (let i = 0; i < 16; ++i) {\n            buf[offset + i] = bytes[i];\n        }\n        return buf;\n    }\n    return unsafeStringify(bytes);\n}\n", "import md5 from './md5.js';\nimport v35, { DNS, URL } from './v35.js';\nexport { DNS, URL } from './v35.js';\nfunction v3(value, namespace, buf, offset) {\n    return v35(0x30, md5, value, namespace, buf, offset);\n}\nv3.DNS = DNS;\nv3.URL = URL;\nexport default v3;\n", "import { randomUUID } from 'node:crypto';\nexport default { randomUUID };\n", "import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\nfunction _v4(options, buf, offset) {\n    options = options || {};\n    const rnds = options.random ?? options.rng?.() ?? rng();\n    if (rnds.length < 16) {\n        throw new Error('Random bytes length must be >= 16');\n    }\n    rnds[6] = (rnds[6] & 0x0f) | 0x40;\n    rnds[8] = (rnds[8] & 0x3f) | 0x80;\n    if (buf) {\n        offset = offset || 0;\n        if (offset < 0 || offset + 16 > buf.length) {\n            throw new RangeError(`UUID byte range ${offset}:${offset + 15} is out of buffer bounds`);\n        }\n        for (let i = 0; i < 16; ++i) {\n            buf[offset + i] = rnds[i];\n        }\n        return buf;\n    }\n    return unsafeStringify(rnds);\n}\nfunction v4(options, buf, offset) {\n    if (native.randomUUID && !buf && !options) {\n        return native.randomUUID();\n    }\n    return _v4(options, buf, offset);\n}\nexport default v4;\n", "import { createHash } from 'node:crypto';\nfunction sha1(bytes) {\n    if (Array.isArray(bytes)) {\n        bytes = Buffer.from(bytes);\n    }\n    else if (typeof bytes === 'string') {\n        bytes = Buffer.from(bytes, 'utf8');\n    }\n    return createHash('sha1').update(bytes).digest();\n}\nexport default sha1;\n", "import sha1 from './sha1.js';\nimport v35, { DNS, URL } from './v35.js';\nexport { DNS, URL } from './v35.js';\nfunction v5(value, namespace, buf, offset) {\n    return v35(0x50, sha1, value, namespace, buf, offset);\n}\nv5.DNS = DNS;\nv5.URL = URL;\nexport default v5;\n", "import { unsafeStringify } from './stringify.js';\nimport v1 from './v1.js';\nimport v1ToV6 from './v1ToV6.js';\nfunction v6(options, buf, offset) {\n    options ??= {};\n    offset ??= 0;\n    let bytes = v1({ ...options, _v6: true }, new Uint8Array(16));\n    bytes = v1ToV6(bytes);\n    if (buf) {\n        for (let i = 0; i < 16; i++) {\n            buf[offset + i] = bytes[i];\n        }\n        return buf;\n    }\n    return unsafeStringify(bytes);\n}\nexport default v6;\n", "import parse from './parse.js';\nimport { unsafeStringify } from './stringify.js';\nexport default function v6ToV1(uuid) {\n    const v6Bytes = typeof uuid === 'string' ? parse(uuid) : uuid;\n    const v1Bytes = _v6ToV1(v6Bytes);\n    return typeof uuid === 'string' ? unsafeStringify(v1Bytes) : v1Bytes;\n}\nfunction _v6ToV1(v6Bytes) {\n    return Uint8Array.of(((v6Bytes[3] & 0x0f) << 4) | ((v6Bytes[4] >> 4) & 0x0f), ((v6Bytes[4] & 0x0f) << 4) | ((v6Bytes[5] & 0xf0) >> 4), ((v6Bytes[5] & 0x0f) << 4) | (v6Bytes[6] & 0x0f), v6Bytes[7], ((v6Bytes[1] & 0x0f) << 4) | ((v6Bytes[2] & 0xf0) >> 4), ((v6Bytes[2] & 0x0f) << 4) | ((v6Bytes[3] & 0xf0) >> 4), 0x10 | ((v6Bytes[0] & 0xf0) >> 4), ((v6Bytes[0] & 0x0f) << 4) | ((v6Bytes[1] & 0xf0) >> 4), v6Bytes[8], v6Bytes[9], v6Bytes[10], v6Bytes[11], v6Bytes[12], v6Bytes[13], v6Bytes[14], v6Bytes[15]);\n}\n", "import rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\nconst _state = {};\nfunction v7(options, buf, offset) {\n    let bytes;\n    if (options) {\n        bytes = v7Bytes(options.random ?? options.rng?.() ?? rng(), options.msecs, options.seq, buf, offset);\n    }\n    else {\n        const now = Date.now();\n        const rnds = rng();\n        updateV7State(_state, now, rnds);\n        bytes = v7Bytes(rnds, _state.msecs, _state.seq, buf, offset);\n    }\n    return buf ?? unsafeStringify(bytes);\n}\nexport function updateV7State(state, now, rnds) {\n    state.msecs ??= -Infinity;\n    state.seq ??= 0;\n    if (now > state.msecs) {\n        state.seq = (rnds[6] << 23) | (rnds[7] << 16) | (rnds[8] << 8) | rnds[9];\n        state.msecs = now;\n    }\n    else {\n        state.seq = (state.seq + 1) | 0;\n        if (state.seq === 0) {\n            state.msecs++;\n        }\n    }\n    return state;\n}\nfunction v7Bytes(rnds, msecs, seq, buf, offset = 0) {\n    if (rnds.length < 16) {\n        throw new Error('Random bytes length must be >= 16');\n    }\n    if (!buf) {\n        buf = new Uint8Array(16);\n        offset = 0;\n    }\n    else {\n        if (offset < 0 || offset + 16 > buf.length) {\n            throw new RangeError(`UUID byte range ${offset}:${offset + 15} is out of buffer bounds`);\n        }\n    }\n    msecs ??= Date.now();\n    seq ??= ((rnds[6] * 0x7f) << 24) | (rnds[7] << 16) | (rnds[8] << 8) | rnds[9];\n    buf[offset++] = (msecs / 0x10000000000) & 0xff;\n    buf[offset++] = (msecs / 0x100000000) & 0xff;\n    buf[offset++] = (msecs / 0x1000000) & 0xff;\n    buf[offset++] = (msecs / 0x10000) & 0xff;\n    buf[offset++] = (msecs / 0x100) & 0xff;\n    buf[offset++] = msecs & 0xff;\n    buf[offset++] = 0x70 | ((seq >>> 28) & 0x0f);\n    buf[offset++] = (seq >>> 20) & 0xff;\n    buf[offset++] = 0x80 | ((seq >>> 14) & 0x3f);\n    buf[offset++] = (seq >>> 6) & 0xff;\n    buf[offset++] = ((seq << 2) & 0xff) | (rnds[10] & 0x03);\n    buf[offset++] = rnds[11];\n    buf[offset++] = rnds[12];\n    buf[offset++] = rnds[13];\n    buf[offset++] = rnds[14];\n    buf[offset++] = rnds[15];\n    return buf;\n}\nexport default v7;\n", "import validate from './validate.js';\nfunction version(uuid) {\n    if (!validate(uuid)) {\n        throw TypeError('Invalid UUID');\n    }\n    return parseInt(uuid.slice(14, 15), 16);\n}\nexport default version;\n", "export { default as MAX } from './max.js';\nexport { default as NIL } from './nil.js';\nexport { default as parse } from './parse.js';\nexport { default as stringify } from './stringify.js';\nexport { default as v1 } from './v1.js';\nexport { default as v1ToV6 } from './v1ToV6.js';\nexport { default as v3 } from './v3.js';\nexport { default as v4 } from './v4.js';\nexport { default as v5 } from './v5.js';\nexport { default as v6 } from './v6.js';\nexport { default as v6ToV1 } from './v6ToV1.js';\nexport { default as v7 } from './v7.js';\nexport { default as validate } from './validate.js';\nexport { default as version } from './version.js';\n", "// DynamoDB client wrapper with local/production mode support\nimport AWS from 'aws-sdk';\nimport { config } from '../utils/config';\nimport { logger } from '../utils/logger';\nimport { Job, JobStatus, StageStatus } from '../models/job';\nimport { LectureAgent } from '../models/agent';\nimport { ExtractedContent, SegmentedContent } from '../models/content';\nimport { WordTiming } from '../models/audio';\n\n// Configure AWS SDK based on environment\nconst dynamoDBConfig: AWS.DynamoDB.ClientConfiguration = {\n  region: config.aws.region,\n};\n\nif (config.localstack.useLocalStack) {\n  dynamoDBConfig.endpoint = config.localstack.endpoint;\n  dynamoDBConfig.accessKeyId = 'test';\n  dynamoDBConfig.secretAccessKey = 'test';\n} else if (config.aws.accessKeyId && config.aws.secretAccessKey) {\n  dynamoDBConfig.accessKeyId = config.aws.accessKeyId;\n  dynamoDBConfig.secretAccessKey = config.aws.secretAccessKey;\n}\n\nconst dynamoDB = new AWS.DynamoDB.DocumentClient(dynamoDBConfig);\n\n// Helper function to handle DynamoDB errors\nfunction handleDynamoDBError(error: any, operation: string): never {\n  logger.error(`DynamoDB ${operation} failed`, { error: error.message });\n  throw new Error(`Database operation failed: ${operation}`);\n}\n\n// ============================================================================\n// Jobs Table Operations\n// ============================================================================\n\nexport interface JobRecord {\n  jobId: string;\n  status: JobStatus;\n  createdAt: string;\n  updatedAt: string;\n  pdfFilename: string;\n  pdfUrl: string;\n  agentId?: string;\n  stages: StageStatus[];\n  error?: string;\n}\n\nfunction jobToRecord(job: Job): JobRecord {\n  return {\n    ...job,\n    createdAt: job.createdAt.toISOString(),\n    updatedAt: job.updatedAt.toISOString(),\n  };\n}\n\nfunction recordToJob(record: JobRecord): Job {\n  return {\n    ...record,\n    createdAt: new Date(record.createdAt),\n    updatedAt: new Date(record.updatedAt),\n    stages: record.stages.map(stage => ({\n      ...stage,\n      startedAt: stage.startedAt ? new Date(stage.startedAt) : undefined,\n      completedAt: stage.completedAt ? new Date(stage.completedAt) : undefined,\n    })),\n  };\n}\n\nexport async function createJob(job: Job): Promise<Job> {\n  try {\n    const record = jobToRecord(job);\n    await dynamoDB.put({\n      TableName: config.dynamodb.jobsTable,\n      Item: record,\n    }).promise();\n    \n    logger.info('Job created', { jobId: job.jobId });\n    return job;\n  } catch (error) {\n    handleDynamoDBError(error, 'createJob');\n  }\n}\n\nexport async function getJob(jobId: string): Promise<Job | null> {\n  try {\n    const result = await dynamoDB.get({\n      TableName: config.dynamodb.jobsTable,\n      Key: { jobId },\n    }).promise();\n    \n    if (!result.Item) {\n      return null;\n    }\n    \n    return recordToJob(result.Item as JobRecord);\n  } catch (error) {\n    handleDynamoDBError(error, 'getJob');\n  }\n}\n\nexport async function updateJob(jobId: string, updates: Partial<Job>): Promise<Job> {\n  try {\n    const current = await getJob(jobId);\n    if (!current) {\n      throw new Error(`Job not found: ${jobId}`);\n    }\n    \n    const updated: Job = {\n      ...current,\n      ...updates,\n      jobId, // Ensure jobId doesn't change\n      updatedAt: new Date(),\n    };\n    \n    const record = jobToRecord(updated);\n    await dynamoDB.put({\n      TableName: config.dynamodb.jobsTable,\n      Item: record,\n    }).promise();\n    \n    logger.info('Job updated', { jobId });\n    return updated;\n  } catch (error) {\n    if (error instanceof Error && error.message.includes('not found')) {\n      throw error;\n    }\n    handleDynamoDBError(error, 'updateJob');\n  }\n}\n\nexport async function deleteJob(jobId: string): Promise<void> {\n  try {\n    await dynamoDB.delete({\n      TableName: config.dynamodb.jobsTable,\n      Key: { jobId },\n    }).promise();\n    \n    logger.info('Job deleted', { jobId });\n  } catch (error) {\n    handleDynamoDBError(error, 'deleteJob');\n  }\n}\n\nexport async function listJobs(): Promise<Job[]> {\n  try {\n    const result = await dynamoDB.scan({\n      TableName: config.dynamodb.jobsTable,\n    }).promise();\n    \n    return (result.Items || []).map(item => recordToJob(item as JobRecord));\n  } catch (error) {\n    handleDynamoDBError(error, 'listJobs');\n  }\n}\n\n// ============================================================================\n// Agents Table Operations\n// ============================================================================\n\nexport interface AgentRecord {\n  id: string;\n  name: string;\n  description: string;\n  personality: {\n    instructions: string;\n    tone: string;\n    examples?: string[];\n  };\n  voice: {\n    voiceId: string;\n    speed: number;\n    pitch: number;\n  };\n  createdAt: string;\n}\n\nfunction agentToRecord(agent: LectureAgent): AgentRecord {\n  return {\n    ...agent,\n    createdAt: agent.createdAt.toISOString(),\n  };\n}\n\nfunction recordToAgent(record: AgentRecord): LectureAgent {\n  return {\n    ...record,\n    personality: {\n      ...record.personality,\n      tone: record.personality.tone as any,\n    },\n    createdAt: new Date(record.createdAt),\n  };\n}\n\nexport async function createAgent(agent: LectureAgent): Promise<LectureAgent> {\n  try {\n    // Check for unique name\n    const existing = await listAgents();\n    if (existing.some(a => a.name === agent.name && a.id !== agent.id)) {\n      throw new Error(`Agent with name \"${agent.name}\" already exists`);\n    }\n    \n    const record = agentToRecord(agent);\n    await dynamoDB.put({\n      TableName: config.dynamodb.agentsTable,\n      Item: record,\n    }).promise();\n    \n    logger.info('Agent created', { agentId: agent.id, name: agent.name });\n    return agent;\n  } catch (error) {\n    if (error instanceof Error && error.message.includes('already exists')) {\n      throw error;\n    }\n    handleDynamoDBError(error, 'createAgent');\n  }\n}\n\nexport async function getAgent(id: string): Promise<LectureAgent | null> {\n  try {\n    const result = await dynamoDB.get({\n      TableName: config.dynamodb.agentsTable,\n      Key: { id },\n    }).promise();\n    \n    if (!result.Item) {\n      return null;\n    }\n    \n    return recordToAgent(result.Item as AgentRecord);\n  } catch (error) {\n    handleDynamoDBError(error, 'getAgent');\n  }\n}\n\nexport async function updateAgent(id: string, updates: Partial<LectureAgent>): Promise<LectureAgent> {\n  try {\n    const current = await getAgent(id);\n    if (!current) {\n      throw new Error(`Agent not found: ${id}`);\n    }\n    \n    // Check for unique name if name is being updated\n    if (updates.name && updates.name !== current.name) {\n      const existing = await listAgents();\n      if (existing.some(a => a.name === updates.name && a.id !== id)) {\n        throw new Error(`Agent with name \"${updates.name}\" already exists`);\n      }\n    }\n    \n    const updated: LectureAgent = {\n      ...current,\n      ...updates,\n      id, // Ensure id doesn't change\n      // Deep merge nested objects\n      personality: updates.personality ? {\n        ...current.personality,\n        ...updates.personality,\n      } : current.personality,\n      voice: updates.voice ? {\n        ...current.voice,\n        ...updates.voice,\n      } : current.voice,\n    };\n    \n    const record = agentToRecord(updated);\n    await dynamoDB.put({\n      TableName: config.dynamodb.agentsTable,\n      Item: record,\n    }).promise();\n    \n    logger.info('Agent updated', { agentId: id });\n    return updated;\n  } catch (error) {\n    if (error instanceof Error && (error.message.includes('already exists') || error.message.includes('not found'))) {\n      throw error;\n    }\n    handleDynamoDBError(error, 'updateAgent');\n  }\n}\n\nexport async function deleteAgent(id: string): Promise<void> {\n  try {\n    await dynamoDB.delete({\n      TableName: config.dynamodb.agentsTable,\n      Key: { id },\n    }).promise();\n    \n    logger.info('Agent deleted', { agentId: id });\n  } catch (error) {\n    handleDynamoDBError(error, 'deleteAgent');\n  }\n}\n\nexport async function listAgents(): Promise<LectureAgent[]> {\n  try {\n    const result = await dynamoDB.scan({\n      TableName: config.dynamodb.agentsTable,\n    }).promise();\n    \n    return (result.Items || []).map(item => recordToAgent(item as AgentRecord));\n  } catch (error) {\n    handleDynamoDBError(error, 'listAgents');\n  }\n}\n\n// ============================================================================\n// Content Table Operations\n// ============================================================================\n\nexport interface ContentRecord {\n  jobId: string;\n  extractedContent?: ExtractedContent;\n  segmentedContent?: SegmentedContent;\n  script?: any; // LectureScript type from script model\n  audioUrl?: string;\n  wordTimings?: WordTiming[];\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport async function createContent(jobId: string): Promise<ContentRecord> {\n  try {\n    const record: ContentRecord = {\n      jobId,\n      createdAt: new Date().toISOString(),\n      updatedAt: new Date().toISOString(),\n    };\n    \n    await dynamoDB.put({\n      TableName: config.dynamodb.contentTable,\n      Item: record,\n    }).promise();\n    \n    logger.info('Content record created', { jobId });\n    return record;\n  } catch (error) {\n    handleDynamoDBError(error, 'createContent');\n  }\n}\n\nexport async function getContent(jobId: string): Promise<ContentRecord | null> {\n  try {\n    const result = await dynamoDB.get({\n      TableName: config.dynamodb.contentTable,\n      Key: { jobId },\n    }).promise();\n    \n    if (!result.Item) {\n      return null;\n    }\n    \n    return result.Item as ContentRecord;\n  } catch (error) {\n    handleDynamoDBError(error, 'getContent');\n  }\n}\n\nexport async function updateContent(jobId: string, updates: Partial<ContentRecord>): Promise<ContentRecord> {\n  try {\n    const current = await getContent(jobId);\n    if (!current) {\n      throw new Error(`Content not found for job: ${jobId}`);\n    }\n    \n    const updated: ContentRecord = {\n      ...current,\n      ...updates,\n      jobId, // Ensure jobId doesn't change\n      updatedAt: new Date().toISOString(),\n    };\n    \n    await dynamoDB.put({\n      TableName: config.dynamodb.contentTable,\n      Item: updated,\n    }).promise();\n    \n    logger.info('Content updated', { jobId });\n    return updated;\n  } catch (error) {\n    if (error instanceof Error && error.message.includes('not found')) {\n      throw error;\n    }\n    handleDynamoDBError(error, 'updateContent');\n  }\n}\n\nexport async function deleteContent(jobId: string): Promise<void> {\n  try {\n    await dynamoDB.delete({\n      TableName: config.dynamodb.contentTable,\n      Key: { jobId },\n    }).promise();\n    \n    logger.info('Content deleted', { jobId });\n  } catch (error) {\n    handleDynamoDBError(error, 'deleteContent');\n  }\n}\n\n// ============================================================================\n// Table Creation (for local development)\n// ============================================================================\n\nexport async function createTablesIfNotExist(): Promise<void> {\n  if (!config.localstack.useLocalStack) {\n    logger.info('Skipping table creation in production mode');\n    return;\n  }\n  \n  const dynamoDBClient = new AWS.DynamoDB(dynamoDBConfig);\n  \n  const tables = [\n    {\n      TableName: config.dynamodb.jobsTable,\n      KeySchema: [{ AttributeName: 'jobId', KeyType: 'HASH' }],\n      AttributeDefinitions: [{ AttributeName: 'jobId', AttributeType: 'S' }],\n    },\n    {\n      TableName: config.dynamodb.agentsTable,\n      KeySchema: [{ AttributeName: 'id', KeyType: 'HASH' }],\n      AttributeDefinitions: [{ AttributeName: 'id', AttributeType: 'S' }],\n    },\n    {\n      TableName: config.dynamodb.contentTable,\n      KeySchema: [{ AttributeName: 'jobId', KeyType: 'HASH' }],\n      AttributeDefinitions: [{ AttributeName: 'jobId', AttributeType: 'S' }],\n    },\n  ];\n  \n  for (const tableConfig of tables) {\n    try {\n      await dynamoDBClient.describeTable({ TableName: tableConfig.TableName }).promise();\n      logger.info(`Table ${tableConfig.TableName} already exists`);\n    } catch (error: any) {\n      if (error.code === 'ResourceNotFoundException') {\n        try {\n          await dynamoDBClient.createTable({\n            ...tableConfig,\n            BillingMode: 'PAY_PER_REQUEST',\n          }).promise();\n          logger.info(`Table ${tableConfig.TableName} created`);\n        } catch (createError) {\n          logger.error(`Failed to create table ${tableConfig.TableName}`, { error: createError });\n        }\n      }\n    }\n  }\n}\n", "// Script Generator function - Serverless function wrapper\nimport { generateScript } from '../services/script-generator';\nimport { getJob, updateJob } from '../services/dynamodb';\nimport { triggerAudioSynthesis } from '../services/eventbridge';\nimport { ErrorResponse } from '../models/errors';\nimport { logger } from '../utils/logger';\nimport { config } from '../utils/config';\n\n/**\n * Lambda handler for script generation\n * This function generates a lecture script with personality,\n * applies timing calculations, and triggers audio synthesis.\n */\nexport async function scriptHandler(event: any): Promise<any> {\n  try {\n    logger.info('Script generator function invoked');\n    \n    // Parse the request\n    const jobId = event.jobId;\n    const agentId = event.agentId; // Optional agent ID override\n    \n    if (!jobId) {\n      throw new Error('jobId is required');\n    }\n    \n    // Get the job\n    const job = await getJob(jobId);\n    if (!job) {\n      throw new Error(`Job not found: ${jobId}`);\n    }\n    \n    // Update job status to 'generating_script'\n    await updateJob(jobId, {\n      status: 'generating_script',\n      stages: job.stages.map(stage =>\n        stage.stage === 'script_generation'\n          ? { ...stage, status: 'in_progress', startedAt: new Date() }\n          : stage\n      ),\n    });\n    \n    logger.info('Starting script generation', { jobId, agentId });\n    \n    // Generate the script\n    const lectureScript = await generateScript(jobId, agentId);\n    \n    // Update job status to 'synthesizing_audio'\n    await updateJob(jobId, {\n      status: 'synthesizing_audio',\n      stages: job.stages.map(stage => {\n        if (stage.stage === 'script_generation') {\n          return { ...stage, status: 'completed', completedAt: new Date() };\n        }\n        if (stage.stage === 'audio_synthesis') {\n          return { ...stage, status: 'in_progress', startedAt: new Date() };\n        }\n        return stage;\n      }),\n    });\n    \n    logger.info('Script generation completed successfully', { jobId });\n    \n    // Trigger audio synthesis asynchronously in production\n    if (config.nodeEnv === 'production') {\n      await triggerAudioSynthesis(jobId);\n      logger.info('Audio synthesis triggered asynchronously', { jobId });\n    }\n    \n    return {\n      statusCode: 200,\n      body: JSON.stringify({\n        jobId,\n        status: 'synthesizing_audio',\n        message: 'Script generation completed',\n        lectureScript: {\n          segments: lectureScript.segments.length,\n          totalEstimatedDuration: lectureScript.totalEstimatedDuration,\n        },\n      }),\n    };\n  } catch (error) {\n    logger.error('Script generator handler error', { error });\n    \n    const errorResponse: ErrorResponse = {\n      error: error instanceof Error ? error.message : 'Unknown error',\n      code: 'SCRIPT_GENERATION_FAILED',\n      retryable: true,\n    };\n    \n    // Try to update job status to failed\n    if (event.jobId) {\n      try {\n        const job = await getJob(event.jobId);\n        if (job) {\n          await updateJob(event.jobId, {\n            status: 'failed',\n            error: errorResponse.error,\n            stages: job.stages.map(stage =>\n              stage.stage === 'script_generation'\n                ? { ...stage, status: 'failed', error: errorResponse.error }\n                : stage\n            ),\n          });\n        }\n      } catch (updateError) {\n        logger.error('Failed to update job status', { error: updateError });\n      }\n    }\n    \n    return {\n      statusCode: 500,\n      body: JSON.stringify(errorResponse),\n    };\n  }\n}\n", "// Script Generator service - Create lecture scripts with personality\nimport { logger } from '../utils/logger';\nimport { config } from '../utils/config';\nimport { LectureAgent } from '../models/agent';\nimport { ContentSegment, Figure, Table, Formula } from '../models/content';\nimport { LectureScript, ScriptSegment, ScriptBlock } from '../models/script';\nimport { llmService, getRecommendedModel } from './llm';\nimport { recordLLMCallMetrics } from '../utils/llm-metrics';\n\nconst { v4: uuidv4 } = require('uuid');\n\n/**\n * Create base prompt for explaining scientific concepts accessibly\n */\nexport function createBasePrompt(): string {\n  return `You are an expert science communicator creating an engaging audio lecture from scientific content.\n\nYour goal is to:\n1. Explain complex scientific concepts in clear, accessible language\n2. Make the content engaging and easy to understand for a general audience\n3. Provide verbal descriptions of all visual elements (figures, tables, formulas)\n4. Maintain scientific accuracy while simplifying explanations\n5. Create a natural, conversational flow suitable for audio narration\n\nGuidelines:\n- Use analogies and examples to clarify difficult concepts\n- Define technical terms when first introduced\n- Explain the significance and implications of findings\n- Connect ideas to show how concepts relate to each other\n- For figures: Describe what is shown, key patterns, and what it means\n- For tables: Summarize the data and highlight important trends or comparisons\n- For formulas: Explain what each variable represents and what the formula tells us\n- Avoid phrases like \"as shown in the figure\" - instead describe what the figure shows\n- Write in a natural speaking style, not formal academic writing\n- Use complete sentences that flow well when read aloud`;\n}\n\n/**\n * Create personality-specific prompt variations\n */\nexport function createPersonalityPrompt(agent: LectureAgent): string {\n  const basePrompt = createBasePrompt();\n  \n  const personalityInstructions = agent.personality.instructions;\n  const tone = agent.personality.tone;\n  const examples = agent.personality.examples || [];\n  \n  let personalitySection = `\\n\\nPERSONALITY AND TONE:\\n`;\n  personalitySection += `You are presenting as: ${agent.name}\\n`;\n  personalitySection += `${personalityInstructions}\\n\\n`;\n  \n  // Add tone-specific guidance\n  switch (tone) {\n    case 'humorous':\n      personalitySection += `Tone: Humorous and entertaining\n- Include appropriate jokes, puns, or witty observations\n- Use playful analogies and comparisons\n- Keep the mood light while maintaining educational value\n- Don't force humor - it should feel natural\n- Balance entertainment with clear explanations\\n`;\n      break;\n      \n    case 'serious':\n      personalitySection += `Tone: Serious and academic\n- Maintain formal, professional language\n- Focus on precision and accuracy\n- Use scholarly vocabulary appropriately\n- Emphasize the rigor and importance of the research\n- Adopt a measured, authoritative delivery\\n`;\n      break;\n      \n    case 'casual':\n      personalitySection += `Tone: Casual and conversational\n- Use everyday language and informal expressions\n- Speak as if explaining to a friend\n- Include relatable examples from daily life\n- Keep it relaxed and approachable\n- Use contractions and natural speech patterns\\n`;\n      break;\n      \n    case 'formal':\n      personalitySection += `Tone: Formal and structured\n- Use proper academic conventions\n- Maintain professional distance\n- Organize information systematically\n- Use precise technical terminology\n- Follow traditional lecture structure\\n`;\n      break;\n      \n    case 'enthusiastic':\n      personalitySection += `Tone: Enthusiastic and energetic\n- Express excitement about the discoveries\n- Use dynamic, engaging language\n- Emphasize the fascinating aspects\n- Convey passion for the subject matter\n- Inspire curiosity and wonder\\n`;\n      break;\n  }\n  \n  // Add examples if provided\n  if (examples.length > 0) {\n    personalitySection += `\\nExample phrases in your style:\\n`;\n    examples.forEach((example, index) => {\n      personalitySection += `${index + 1}. \"${example}\"\\n`;\n    });\n  }\n  \n  return basePrompt + personalitySection;\n}\n\n/**\n * Create prompt for a specific segment\n */\nexport function createSegmentPrompt(\n  segment: ContentSegment,\n  agent: LectureAgent,\n  segmentIndex: number,\n  totalSegments: number\n): string {\n  const personalityPrompt = createPersonalityPrompt(agent);\n  \n  let segmentPrompt = `\\n\\n${'='.repeat(80)}\\n`;\n  segmentPrompt += `SEGMENT ${segmentIndex + 1} of ${totalSegments}: ${segment.title}\\n`;\n  segmentPrompt += `${'='.repeat(80)}\\n\\n`;\n  \n  // Add context about segment position\n  if (segmentIndex === 0) {\n    segmentPrompt += `CONTEXT: This is the FIRST segment. Introduce the topic and set the stage for the lecture.\\n\\n`;\n  } else if (segmentIndex === totalSegments - 1) {\n    segmentPrompt += `CONTEXT: This is the FINAL segment. Wrap up the lecture and provide concluding thoughts.\\n\\n`;\n  } else {\n    segmentPrompt += `CONTEXT: This is segment ${segmentIndex + 1} of ${totalSegments}. Build on previous concepts and prepare for what's next.\\n\\n`;\n  }\n  \n  segmentPrompt += `Create an engaging lecture script for this segment. The script should be suitable for audio narration.\\n\\n`;\n  \n  // Count visual elements for summary\n  let figureCount = 0;\n  let tableCount = 0;\n  let formulaCount = 0;\n  \n  segment.contentBlocks.forEach(block => {\n    if (block.type === 'figure') figureCount++;\n    if (block.type === 'table') tableCount++;\n    if (block.type === 'formula') formulaCount++;\n  });\n  \n  // Add visual element summary\n  if (figureCount > 0 || tableCount > 0 || formulaCount > 0) {\n    segmentPrompt += `VISUAL ELEMENTS IN THIS SEGMENT:\\n`;\n    if (figureCount > 0) segmentPrompt += `- ${figureCount} figure(s)\\n`;\n    if (tableCount > 0) segmentPrompt += `- ${tableCount} table(s)\\n`;\n    if (formulaCount > 0) segmentPrompt += `- ${formulaCount} formula(s)\\n`;\n    segmentPrompt += `\\n`;\n  }\n  \n  // Add content blocks\n  segmentPrompt += `CONTENT TO COVER:\\n\\n`;\n  \n  segment.contentBlocks.forEach((block, index) => {\n    segmentPrompt += `--- Content Block ${index + 1} (Page ${block.pageReference}) ---\\n`;\n    \n    switch (block.type) {\n      case 'text':\n        segmentPrompt += `Text content:\\n${block.content}\\n\\n`;\n        break;\n        \n      case 'figure':\n        const figure = block.content as Figure;\n        segmentPrompt += `Figure:\\n`;\n        segmentPrompt += `Caption: ${figure.caption || 'N/A'}\\n`;\n        segmentPrompt += `Description: ${figure.description}\\n`;\n        segmentPrompt += `[Provide a clear verbal description of this figure in your script]\\n\\n`;\n        break;\n        \n      case 'table':\n        const table = block.content as Table;\n        segmentPrompt += `Table:\\n`;\n        segmentPrompt += `Headers: ${table.headers.join(', ')}\\n`;\n        segmentPrompt += `Interpretation: ${table.interpretation}\\n`;\n        segmentPrompt += `[Summarize the key data and trends from this table in your script]\\n\\n`;\n        break;\n        \n      case 'formula':\n        const formula = block.content as Formula;\n        segmentPrompt += `Formula:\\n`;\n        segmentPrompt += `LaTeX: ${formula.latex}\\n`;\n        segmentPrompt += `Explanation: ${formula.explanation}\\n`;\n        segmentPrompt += `[Explain this formula verbally, describing what each part means]\\n\\n`;\n        break;\n        \n      case 'citation':\n        segmentPrompt += `Citation: ${JSON.stringify(block.content)}\\n`;\n        segmentPrompt += `[Reference this work naturally in your explanation]\\n\\n`;\n        break;\n    }\n  });\n  \n  // Add length guidance\n  const estimatedMinutes = Math.max(2, Math.min(5, segment.contentBlocks.length));\n  segmentPrompt += `\\nLENGTH GUIDANCE:\\n`;\n  segmentPrompt += `Target: ${estimatedMinutes}-${estimatedMinutes + 1} minutes of speaking time (approximately ${estimatedMinutes * 150}-${(estimatedMinutes + 1) * 150} words)\\n\\n`;\n  \n  segmentPrompt += `INSTRUCTIONS:\\n`;\n  segmentPrompt += `1. Write a complete lecture script for this segment\\n`;\n  segmentPrompt += `2. Integrate all content blocks into a cohesive narrative\\n`;\n  segmentPrompt += `3. Provide verbal descriptions for all visual elements\\n`;\n  segmentPrompt += `4. Maintain your personality and tone throughout\\n`;\n  segmentPrompt += `5. Write in a natural speaking style suitable for audio\\n`;\n  segmentPrompt += `6. The script should flow smoothly when read aloud\\n`;\n  segmentPrompt += `7. Reference specific figures, tables, and formulas by describing what they show\\n\\n`;\n  \n  segmentPrompt += `Respond with ONLY the lecture script text, no additional formatting or metadata.\\n`;\n  \n  return personalityPrompt + segmentPrompt;\n}\n\n/**\n * Get instructions for verbal descriptions of visual elements\n */\nexport function getVisualDescriptionInstructions(): string {\n  return `\nVERBAL DESCRIPTIONS FOR VISUAL ELEMENTS:\n\nWhen describing figures:\n- Start with what type of visualization it is (graph, diagram, photo, etc.)\n- Describe the axes, labels, and what is being measured\n- Highlight key patterns, trends, or features\n- Explain what the visual tells us or why it's significant\n- Use spatial language (left, right, top, bottom, increasing, decreasing)\n\nWhen describing tables:\n- Mention what data is being presented\n- Highlight the most important values or comparisons\n- Point out trends or patterns in the data\n- Explain what the data reveals or supports\n\nWhen describing formulas:\n- Name the formula if it has a common name\n- Explain what each variable or symbol represents\n- Describe what the formula calculates or predicts\n- Explain the relationship between the variables\n- Mention why this formula is important or useful\n\nRemember: The listener cannot see these elements, so your verbal description must paint a complete picture.`;\n}\n\n/**\n * Apply personality-specific modifications to generated script text\n * This adds tone markers and adjusts language based on agent personality\n */\nexport function applyPersonalityModifications(\n  scriptText: string,\n  agent: LectureAgent\n): string {\n  let modifiedText = scriptText;\n  \n  // Apply tone-specific modifications\n  switch (agent.personality.tone) {\n    case 'humorous':\n      // Ensure humor markers are present\n      // Check if script has some informal language or humor indicators\n      if (!hasHumorMarkers(modifiedText)) {\n        logger.warn('Script may lack humor for humorous agent', { agentId: agent.id });\n      }\n      break;\n      \n    case 'serious':\n      // Ensure formal language\n      // Remove contractions for more formal tone\n      modifiedText = removeContractions(modifiedText);\n      break;\n      \n    case 'casual':\n      // Ensure casual language\n      // Add contractions if missing\n      modifiedText = addContractions(modifiedText);\n      break;\n      \n    case 'formal':\n      // Ensure formal structure\n      modifiedText = removeContractions(modifiedText);\n      break;\n      \n    case 'enthusiastic':\n      // Ensure enthusiastic language is present\n      if (!hasEnthusiasticMarkers(modifiedText)) {\n        logger.warn('Script may lack enthusiasm for enthusiastic agent', { agentId: agent.id });\n      }\n      break;\n  }\n  \n  return modifiedText;\n}\n\n/**\n * Check if text contains humor markers\n */\nfunction hasHumorMarkers(text: string): boolean {\n  const humorIndicators = [\n    /\\b(funny|hilarious|joke|pun|amusing)\\b/i,\n    /\\b(imagine|picture this|think about)\\b/i,\n    /!/,  // Exclamation marks often indicate humor\n    /\\?.*\\?/,  // Multiple questions can indicate playful tone\n  ];\n  \n  return humorIndicators.some(pattern => pattern.test(text));\n}\n\n/**\n * Check if text contains enthusiastic markers\n */\nfunction hasEnthusiasticMarkers(text: string): boolean {\n  const enthusiasmIndicators = [\n    /\\b(amazing|incredible|fascinating|remarkable|extraordinary)\\b/i,\n    /\\b(exciting|wonderful|fantastic|brilliant)\\b/i,\n    /!/,  // Exclamation marks\n  ];\n  \n  return enthusiasmIndicators.some(pattern => pattern.test(text));\n}\n\n/**\n * Remove contractions for formal tone\n */\nfunction removeContractions(text: string): string {\n  const contractions: Record<string, string> = {\n    \"don't\": \"do not\",\n    \"doesn't\": \"does not\",\n    \"didn't\": \"did not\",\n    \"won't\": \"will not\",\n    \"wouldn't\": \"would not\",\n    \"can't\": \"cannot\",\n    \"couldn't\": \"could not\",\n    \"shouldn't\": \"should not\",\n    \"isn't\": \"is not\",\n    \"aren't\": \"are not\",\n    \"wasn't\": \"was not\",\n    \"weren't\": \"were not\",\n    \"haven't\": \"have not\",\n    \"hasn't\": \"has not\",\n    \"hadn't\": \"had not\",\n    \"it's\": \"it is\",\n    \"that's\": \"that is\",\n    \"there's\": \"there is\",\n    \"here's\": \"here is\",\n    \"what's\": \"what is\",\n    \"who's\": \"who is\",\n    \"where's\": \"where is\",\n    \"we're\": \"we are\",\n    \"they're\": \"they are\",\n    \"you're\": \"you are\",\n    \"I'm\": \"I am\",\n    \"we've\": \"we have\",\n    \"they've\": \"they have\",\n    \"you've\": \"you have\",\n    \"I've\": \"I have\",\n    \"we'll\": \"we will\",\n    \"they'll\": \"they will\",\n    \"you'll\": \"you will\",\n    \"I'll\": \"I will\",\n  };\n  \n  let result = text;\n  for (const [contraction, expansion] of Object.entries(contractions)) {\n    // Case-insensitive replacement\n    const regex = new RegExp(contraction, 'gi');\n    result = result.replace(regex, (match) => {\n      // Preserve capitalization\n      if (match[0] === match[0].toUpperCase()) {\n        return expansion.charAt(0).toUpperCase() + expansion.slice(1);\n      }\n      return expansion;\n    });\n  }\n  \n  return result;\n}\n\n/**\n * Add contractions for casual tone\n */\nfunction addContractions(text: string): string {\n  const expansions: Record<string, string> = {\n    \"do not\": \"don't\",\n    \"does not\": \"doesn't\",\n    \"did not\": \"didn't\",\n    \"will not\": \"won't\",\n    \"would not\": \"wouldn't\",\n    \"cannot\": \"can't\",\n    \"could not\": \"couldn't\",\n    \"should not\": \"shouldn't\",\n    \"is not\": \"isn't\",\n    \"are not\": \"aren't\",\n    \"was not\": \"wasn't\",\n    \"were not\": \"weren't\",\n    \"have not\": \"haven't\",\n    \"has not\": \"hasn't\",\n    \"had not\": \"hadn't\",\n    \"it is\": \"it's\",\n    \"that is\": \"that's\",\n    \"there is\": \"there's\",\n    \"here is\": \"here's\",\n    \"what is\": \"what's\",\n    \"who is\": \"who's\",\n    \"where is\": \"where's\",\n    \"we are\": \"we're\",\n    \"they are\": \"they're\",\n    \"you are\": \"you're\",\n    \"I am\": \"I'm\",\n    \"we have\": \"we've\",\n    \"they have\": \"they've\",\n    \"you have\": \"you've\",\n    \"I have\": \"I've\",\n    \"we will\": \"we'll\",\n    \"they will\": \"they'll\",\n    \"you will\": \"you'll\",\n    \"I will\": \"I'll\",\n  };\n  \n  let result = text;\n  for (const [expansion, contraction] of Object.entries(expansions)) {\n    // Case-insensitive replacement, but be careful not to replace in the middle of sentences\n    const regex = new RegExp(`\\\\b${expansion}\\\\b`, 'gi');\n    result = result.replace(regex, (match) => {\n      // Preserve capitalization\n      if (match[0] === match[0].toUpperCase()) {\n        return contraction.charAt(0).toUpperCase() + contraction.slice(1);\n      }\n      return contraction;\n    });\n  }\n  \n  return result;\n}\n\n/**\n * Merge agent personality instructions with base prompt\n * This creates the complete prompt for LLM script generation\n */\nexport function mergePromptWithPersonality(\n  _basePrompt: string,\n  agent: LectureAgent,\n  segmentContent: string\n): string {\n  const personalityPrompt = createPersonalityPrompt(agent);\n  return personalityPrompt + '\\n\\n' + segmentContent;\n}\n\n/**\n * Calculate estimated duration based on word count\n * Uses average speaking rate of 150-160 words per minute\n */\nexport function calculateDuration(text: string, wordsPerMinute: number = 155): number {\n  // Count words in the text\n  const wordCount = countWords(text);\n  \n  // Calculate duration in seconds\n  const durationMinutes = wordCount / wordsPerMinute;\n  const durationSeconds = durationMinutes * 60;\n  \n  return Math.round(durationSeconds);\n}\n\n/**\n * Count words in a text string\n */\nexport function countWords(text: string): number {\n  // Remove extra whitespace and split by whitespace\n  const words = text.trim().split(/\\s+/);\n  \n  // Filter out empty strings\n  return words.filter(word => word.length > 0).length;\n}\n\n/**\n * Assign timing to each script block\n * Returns script blocks with estimated duration\n */\nexport function assignTimingToBlocks(scriptBlocks: Omit<ScriptBlock, 'estimatedDuration'>[]): ScriptBlock[] {\n  return scriptBlocks.map(block => ({\n    ...block,\n    estimatedDuration: calculateDuration(block.text),\n  }));\n}\n\n/**\n * Calculate total lecture duration from all segments\n */\nexport function calculateTotalDuration(segments: ScriptSegment[]): number {\n  let totalDuration = 0;\n  \n  for (const segment of segments) {\n    for (const block of segment.scriptBlocks) {\n      totalDuration += block.estimatedDuration;\n    }\n  }\n  \n  return totalDuration;\n}\n\n/**\n * Build system prompt incorporating agent personality\n */\nfunction buildScriptSystemPrompt(agent: LectureAgent): string {\n  const basePrompt = `You are a lecture script writer creating engaging educational content.\n\nAGENT PERSONALITY:\n${agent.personality.instructions}\n\nTONE: ${agent.personality.tone}\n\nGUIDELINES:\n- Explain complex scientific concepts in accessible language\n- Reference figures, tables, and formulas with clear verbal descriptions\n- Maintain the specified tone throughout\n- Create a natural, conversational flow\n- Use analogies and examples to clarify difficult concepts`;\n\n  // Add tone-specific guidance\n  if (agent.personality.tone === 'humorous') {\n    return basePrompt + `\n\nHUMOR GUIDELINES:\n- Include appropriate jokes or witty observations\n- Use playful analogies\n- Keep humor relevant to the content\n- Don't force jokes - let them arise naturally`;\n  } else if (agent.personality.tone === 'serious') {\n    return basePrompt + `\n\nFORMAL GUIDELINES:\n- Maintain academic rigor\n- Use precise scientific terminology\n- Avoid colloquialisms\n- Focus on clarity and accuracy`;\n  } else if (agent.personality.tone === 'casual') {\n    return basePrompt + `\n\nCASUAL GUIDELINES:\n- Use everyday language and informal expressions\n- Speak as if explaining to a friend\n- Include relatable examples from daily life\n- Keep it relaxed and approachable`;\n  } else if (agent.personality.tone === 'formal') {\n    return basePrompt + `\n\nFORMAL GUIDELINES:\n- Use proper academic conventions\n- Maintain professional distance\n- Organize information systematically\n- Use precise technical terminology`;\n  } else if (agent.personality.tone === 'enthusiastic') {\n    return basePrompt + `\n\nENTHUSIASTIC GUIDELINES:\n- Express excitement about the discoveries\n- Use dynamic, engaging language\n- Emphasize the fascinating aspects\n- Convey passion for the subject matter`;\n  }\n  \n  return basePrompt;\n}\n\n/**\n * Mock implementation for script generation (used when feature flag is disabled)\n */\nasync function mockScriptGenerationLLM(_prompt: string, agent: LectureAgent): Promise<string> {\n  logger.info('Using mock script generation (feature flag disabled)', { agentId: agent.id });\n  \n  // Simulate API delay\n  await new Promise(resolve => setTimeout(resolve, 200));\n  \n  // Return a simple mock script with personality hint\n  const toneHint = agent.personality.tone === 'humorous' ? 'with a touch of humor' : \n                   agent.personality.tone === 'serious' ? 'in a formal academic style' : \n                   'in a conversational manner';\n  \n  return `Welcome to this segment of our lecture, presented ${toneHint}. \n  \nIn this section, we'll explore the key concepts and findings from the research. The content has been carefully organized to help you understand the material in a logical progression.\n\nWe'll examine the data, discuss the methodology, and consider the implications of these findings for the field. Throughout this presentation, I'll be referencing various figures, tables, and formulas that illustrate these important points.\n\nLet's dive into the details and see what we can learn from this fascinating research.`;\n}\n\n/**\n * Call LLM API to generate script for a segment\n */\nasync function callScriptGenerationLLM(prompt: string, agent: LectureAgent, correlationId?: string): Promise<string> {\n  // Check feature flag\n  if (!config.featureFlags.enableRealScriptGeneration) {\n    logger.info('Real script generation disabled by feature flag, using mock implementation', {\n      correlationId,\n      agentId: agent.id,\n    });\n    return mockScriptGenerationLLM(prompt, agent);\n  }\n  \n  const startTime = Date.now();\n  const requestId = correlationId || uuidv4();\n  let model: string | undefined;\n  \n  try {\n    model = getRecommendedModel('script', llmService.getProvider());\n    \n    logger.info('Calling LLM for script generation', { \n      correlationId: requestId,\n      model, \n      agentId: agent.id,\n      agentTone: agent.personality.tone,\n    });\n    \n    // Build personality-specific system prompt\n    const systemPrompt = buildScriptSystemPrompt(agent);\n    \n    const response = await llmService.chat({\n      messages: [\n        {\n          role: 'system',\n          content: systemPrompt,\n        },\n        {\n          role: 'user',\n          content: prompt,\n        },\n      ],\n      model,\n      temperature: 0.8, // Higher for more creative/personality-driven output\n      maxTokens: 2000,\n    });\n    \n    const duration = Date.now() - startTime;\n    \n    logger.info('Script generation completed successfully', {\n      correlationId: requestId,\n      scriptLength: response.content.length,\n      duration,\n      tokensUsed: response.usage?.totalTokens,\n      promptTokens: response.usage?.promptTokens,\n      completionTokens: response.usage?.completionTokens,\n      agentId: agent.id,\n    });\n    \n    // Record operation-specific metrics\n    if (response.usage) {\n      recordLLMCallMetrics({\n        operation: 'script_generation',\n        model: response.model,\n        provider: llmService.getProvider(),\n        promptTokens: response.usage.promptTokens,\n        completionTokens: response.usage.completionTokens,\n        totalTokens: response.usage.totalTokens,\n        durationMs: duration,\n        success: true,\n      });\n    }\n    \n    return response.content;\n  } catch (error) {\n    const duration = Date.now() - startTime;\n    \n    // Record failure metrics\n    recordLLMCallMetrics({\n      operation: 'script_generation',\n      model: model || 'unknown',\n      provider: llmService.getProvider(),\n      promptTokens: 0,\n      completionTokens: 0,\n      totalTokens: 0,\n      durationMs: duration,\n      success: false,\n      errorType: error instanceof Error ? error.message : 'Unknown error',\n    });\n    \n    logger.error('Script generation LLM call failed', { \n      correlationId: requestId,\n      error, \n      agentId: agent.id, \n      duration,\n      errorMessage: error instanceof Error ? error.message : 'Unknown error',\n      errorStack: error instanceof Error ? error.stack : undefined,\n    });\n    throw new Error(`Failed to generate script: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\n/**\n * Generate script blocks for a content segment\n */\nasync function generateScriptForSegment(\n  segment: ContentSegment,\n  agent: LectureAgent,\n  segmentIndex: number,\n  totalSegments: number,\n  correlationId?: string\n): Promise<ScriptSegment> {\n  const requestId = correlationId || uuidv4();\n  \n  logger.info('Generating script for segment', {\n    correlationId: requestId,\n    segmentId: segment.id,\n    title: segment.title,\n    blockCount: segment.contentBlocks.length,\n    segmentIndex,\n    totalSegments,\n  });\n  \n  // Create prompt for this segment\n  const prompt = createSegmentPrompt(segment, agent, segmentIndex, totalSegments);\n  \n  // Call LLM to generate script\n  const scriptText = await callScriptGenerationLLM(prompt, agent, requestId);\n  \n  // Apply personality modifications\n  const modifiedScript = applyPersonalityModifications(scriptText, agent);\n  \n  // Create script blocks from the generated text\n  // For now, we'll create one block per content block\n  // In a more sophisticated implementation, we might split the script differently\n  const scriptBlocks: Omit<ScriptBlock, 'estimatedDuration'>[] = [];\n  \n  // Split script into paragraphs\n  const paragraphs = modifiedScript.split(/\\n\\n+/).filter(p => p.trim().length > 0);\n  \n  // Create a script block for each paragraph, mapping to content blocks\n  paragraphs.forEach((paragraph, index) => {\n    // Map to corresponding content block (or create a default if none exist)\n    let contentReference;\n    \n    if (segment.contentBlocks.length > 0) {\n      const contentBlockIndex = Math.min(index, segment.contentBlocks.length - 1);\n      const contentBlock = segment.contentBlocks[contentBlockIndex];\n      \n      contentReference = {\n        type: contentBlock.type,\n        id: typeof contentBlock.content === 'string' ? 'text' : (contentBlock.content as any).id || 'unknown',\n        pageNumber: contentBlock.pageReference,\n      };\n    } else {\n      // Default reference when no content blocks exist\n      contentReference = {\n        type: 'text' as const,\n        id: 'default',\n        pageNumber: 1,\n      };\n    }\n    \n    scriptBlocks.push({\n      id: uuidv4(),\n      text: paragraph.trim(),\n      contentReference,\n    });\n  });\n  \n  // Assign timing to blocks\n  const blocksWithTiming = assignTimingToBlocks(scriptBlocks);\n  \n  return {\n    segmentId: segment.id,\n    title: segment.title,\n    scriptBlocks: blocksWithTiming,\n  };\n}\n\n/**\n * Main script generation function\n * Retrieves segmented content and agent, generates script, and stores the result\n */\nexport async function generateScript(jobId: string, agentId?: string): Promise<LectureScript> {\n  const correlationId = `script-${jobId}-${uuidv4()}`;\n  \n  try {\n    logger.info('Starting script generation', { \n      jobId, \n      agentId,\n      correlationId,\n    });\n    \n    // Import dynamodb functions here to avoid circular dependencies\n    const { getContent, updateContent, getAgent, updateJob } = require('./dynamodb');\n    \n    // Retrieve segmented content from database\n    const contentRecord = await getContent(jobId);\n    if (!contentRecord || !contentRecord.segmentedContent) {\n      throw new Error(`No segmented content found for job: ${jobId}`);\n    }\n    \n    const segmentedContent = contentRecord.segmentedContent;\n    \n    // Retrieve agent configuration\n    // If agentId is provided, use that agent; otherwise, check if job has an agent\n    let agent: LectureAgent | null = null;\n    \n    if (agentId) {\n      agent = await getAgent(agentId);\n    } else {\n      // Check if job has an associated agent\n      const { getJob } = require('./dynamodb');\n      const job = await getJob(jobId);\n      if (job && job.agentId) {\n        agent = await getAgent(job.agentId);\n      }\n    }\n    \n    // If no agent found, create a default agent\n    if (!agent) {\n      logger.warn('No agent specified, using default agent');\n      agent = {\n        id: 'default',\n        name: 'Default Lecturer',\n        description: 'A clear and straightforward science communicator',\n        personality: {\n          instructions: 'Explain concepts clearly and accessibly',\n          tone: 'casual',\n        },\n        voice: {\n          voiceId: 'default',\n          speed: 1.0,\n          pitch: 0,\n        },\n        createdAt: new Date(),\n      };\n    }\n    \n    // Generate script for each segment\n    const scriptSegments: ScriptSegment[] = [];\n    const totalSegments = segmentedContent.segments.length;\n    \n    for (let i = 0; i < totalSegments; i++) {\n      const segment = segmentedContent.segments[i];\n      const segmentCorrelationId = `${correlationId}-seg${i}`;\n      const scriptSegment = await generateScriptForSegment(segment, agent, i, totalSegments, segmentCorrelationId);\n      scriptSegments.push(scriptSegment);\n    }\n    \n    // Calculate total duration\n    const totalDuration = calculateTotalDuration(scriptSegments);\n    \n    const lectureScript: LectureScript = {\n      segments: scriptSegments,\n      totalEstimatedDuration: totalDuration,\n    };\n    \n    // Store lecture script in database\n    await updateContent(jobId, {\n      script: lectureScript,\n    });\n    \n    // Update job status\n    await updateJob(jobId, {\n      status: 'synthesizing_audio',\n    });\n    \n    logger.info('Script generation completed', {\n      jobId,\n      correlationId,\n      segmentCount: scriptSegments.length,\n      totalDuration,\n    });\n    \n    return lectureScript;\n  } catch (error) {\n    logger.error('Script generation failed', { \n      jobId, \n      correlationId,\n      error,\n      errorMessage: error instanceof Error ? error.message : 'Unknown error',\n      errorStack: error instanceof Error ? error.stack : undefined,\n    });\n    throw error;\n  }\n}\n\n", "/**\n * LLM Service - Unified interface for multiple LLM providers via OpenRouter\n * \n * Supports:\n * - OpenRouter (unified access to OpenAI, Anthropic, Google, Meta, etc.)\n * - Direct OpenAI API\n * - Direct Anthropic API\n */\n\nimport { logger } from '../utils/logger';\nimport { withRetry } from '../utils/retry';\nimport { recordLLMCallMetrics } from '../utils/llm-metrics';\n\nexport interface LLMMessage {\n  role: 'system' | 'user' | 'assistant';\n  content: string;\n}\n\nexport interface LLMRequest {\n  messages: LLMMessage[];\n  model?: string;\n  temperature?: number;\n  maxTokens?: number;\n  stream?: boolean;\n}\n\nexport interface LLMResponse {\n  content: string;\n  model: string;\n  usage?: {\n    promptTokens: number;\n    completionTokens: number;\n    totalTokens: number;\n  };\n}\n\nexport interface VisionRequest {\n  imageUrl: string;\n  prompt: string;\n  model?: string;\n}\n\n/**\n * LLM Provider types\n */\nexport type LLMProvider = 'openrouter' | 'openai' | 'anthropic';\n\n/**\n * Rate limit error class\n */\nclass RateLimitError extends Error {\n  public retryable = true;\n  public retryAfter?: number;\n  \n  constructor(message: string, retryAfter?: number) {\n    super(message);\n    this.name = 'RateLimitError';\n    this.retryAfter = retryAfter;\n  }\n}\n\n/**\n * OpenRouter API client with enhanced rate limit handling\n */\nclass OpenRouterClient {\n  private apiKey: string;\n  private baseUrl: string = 'https://openrouter.ai/api/v1';\n  private appName: string = 'PDF Lecture Service';\n  private lastRequestTime: number = 0;\n  private minRequestInterval: number;\n  \n  constructor(apiKey: string) {\n    this.apiKey = apiKey;\n    // Configurable minimum interval between requests (default: 500ms for free tier)\n    this.minRequestInterval = parseInt(process.env.OPENROUTER_MIN_REQUEST_INTERVAL_MS || '500', 10);\n  }\n  \n  /**\n   * Rate limit requests to avoid hitting API limits\n   */\n  private async rateLimit(): Promise<void> {\n    const now = Date.now();\n    const timeSinceLastRequest = now - this.lastRequestTime;\n    \n    if (timeSinceLastRequest < this.minRequestInterval) {\n      const waitTime = this.minRequestInterval - timeSinceLastRequest;\n      logger.debug('Rate limiting OpenRouter request', { waitTime });\n      await new Promise(resolve => setTimeout(resolve, waitTime));\n    }\n    \n    this.lastRequestTime = Date.now();\n  }\n  \n  /**\n   * Parse error response and extract rate limit info\n   */\n  private parseErrorResponse(status: number, errorText: string): Error {\n    try {\n      const errorData = JSON.parse(errorText);\n      \n      // Check for rate limit error\n      if (status === 429 || errorData.error?.code === 429) {\n        const message = errorData.error?.message || 'Rate limit exceeded';\n        const retryAfter = errorData.error?.metadata?.headers?.['X-RateLimit-Reset'];\n        \n        logger.warn('OpenRouter rate limit hit', {\n          message,\n          retryAfter,\n          remaining: errorData.error?.metadata?.headers?.['X-RateLimit-Remaining'],\n        });\n        \n        return new RateLimitError(message, retryAfter);\n      }\n      \n      // Other API errors\n      return new Error(`OpenRouter API error: ${status} - ${errorData.error?.message || errorText}`);\n    } catch (e) {\n      // If we can't parse the error, return a generic error\n      return new Error(`OpenRouter API error: ${status} - ${errorText}`);\n    }\n  }\n  \n  async chat(request: LLMRequest): Promise<LLMResponse> {\n    const model = request.model || 'openai/gpt-4-turbo-preview';\n    const startTime = Date.now();\n    \n    logger.info('OpenRouter chat request', {\n      model,\n      messageCount: request.messages.length,\n    });\n    \n    try {\n      // Apply rate limiting\n      await this.rateLimit();\n      \n      const response = await fetch(`${this.baseUrl}/chat/completions`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${this.apiKey}`,\n          'Content-Type': 'application/json',\n          'HTTP-Referer': 'https://github.com/pdf-lecture-service',\n          'X-Title': this.appName,\n        },\n        body: JSON.stringify({\n          model,\n          messages: request.messages,\n          temperature: request.temperature ?? 0.7,\n          max_tokens: request.maxTokens ?? 4096,\n          stream: request.stream ?? false,\n        }),\n      });\n      \n      if (!response.ok) {\n        const error = await response.text();\n        logger.error('OpenRouter API error', { status: response.status, error });\n        throw this.parseErrorResponse(response.status, error);\n      }\n      \n      const data: any = await response.json();\n      const duration = Date.now() - startTime;\n      \n      // Log rate limit headers if available\n      const rateLimitHeaders = {\n        limit: response.headers.get('X-RateLimit-Limit'),\n        remaining: response.headers.get('X-RateLimit-Remaining'),\n        reset: response.headers.get('X-RateLimit-Reset'),\n      };\n      \n      if (rateLimitHeaders.remaining) {\n        logger.debug('OpenRouter rate limit status', rateLimitHeaders);\n      }\n      \n      const result = {\n        content: data.choices[0].message.content,\n        model: data.model,\n        usage: {\n          promptTokens: data.usage?.prompt_tokens || 0,\n          completionTokens: data.usage?.completion_tokens || 0,\n          totalTokens: data.usage?.total_tokens || 0,\n        },\n      };\n      \n      // Record metrics for successful call\n      recordLLMCallMetrics({\n        operation: 'chat',\n        model: data.model,\n        provider: 'openrouter',\n        promptTokens: result.usage.promptTokens,\n        completionTokens: result.usage.completionTokens,\n        totalTokens: result.usage.totalTokens,\n        durationMs: duration,\n        success: true,\n      });\n      \n      return result;\n    } catch (error) {\n      const duration = Date.now() - startTime;\n      \n      // Record metrics for failed call\n      recordLLMCallMetrics({\n        operation: 'chat',\n        model,\n        provider: 'openrouter',\n        promptTokens: 0,\n        completionTokens: 0,\n        totalTokens: 0,\n        durationMs: duration,\n        success: false,\n        errorType: error instanceof Error ? error.message : 'Unknown error',\n      });\n      \n      throw error;\n    }\n  }\n  \n  async vision(request: VisionRequest): Promise<string> {\n    const model = request.model || 'openai/gpt-4-vision-preview';\n    const startTime = Date.now();\n    \n    logger.info('OpenRouter vision request', { model });\n    \n    try {\n      // Apply rate limiting\n      await this.rateLimit();\n      \n      const response = await fetch(`${this.baseUrl}/chat/completions`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${this.apiKey}`,\n          'Content-Type': 'application/json',\n          'HTTP-Referer': 'https://github.com/pdf-lecture-service',\n          'X-Title': this.appName,\n        },\n        body: JSON.stringify({\n          model,\n          messages: [\n            {\n              role: 'user',\n              content: [\n                {\n                  type: 'text',\n                  text: request.prompt,\n                },\n                {\n                  type: 'image_url',\n                  image_url: {\n                    url: request.imageUrl,\n                  },\n                },\n              ],\n            },\n          ],\n          max_tokens: 1024,\n        }),\n      });\n      \n      if (!response.ok) {\n        const error = await response.text();\n        logger.error('OpenRouter vision API error', { status: response.status, error });\n        throw this.parseErrorResponse(response.status, error);\n      }\n      \n      const data: any = await response.json();\n      const duration = Date.now() - startTime;\n      \n      // Log rate limit headers if available\n      const rateLimitHeaders = {\n        limit: response.headers.get('X-RateLimit-Limit'),\n        remaining: response.headers.get('X-RateLimit-Remaining'),\n        reset: response.headers.get('X-RateLimit-Reset'),\n      };\n      \n      if (rateLimitHeaders.remaining) {\n        logger.debug('OpenRouter rate limit status', rateLimitHeaders);\n      }\n      \n      // Record metrics\n      recordLLMCallMetrics({\n        operation: 'vision',\n        model: data.model,\n        provider: 'openrouter',\n        promptTokens: data.usage?.prompt_tokens || 0,\n        completionTokens: data.usage?.completion_tokens || 0,\n        totalTokens: data.usage?.total_tokens || 0,\n        durationMs: duration,\n        success: true,\n      });\n      \n      return data.choices[0].message.content;\n    } catch (error) {\n      const duration = Date.now() - startTime;\n      \n      // Record metrics for failed call\n      recordLLMCallMetrics({\n        operation: 'vision',\n        model,\n        provider: 'openrouter',\n        promptTokens: 0,\n        completionTokens: 0,\n        totalTokens: 0,\n        durationMs: duration,\n        success: false,\n        errorType: error instanceof Error ? error.message : 'Unknown error',\n      });\n      \n      throw error;\n    }\n  }\n}\n\n/**\n * OpenAI API client (direct)\n */\nclass OpenAIClient {\n  private apiKey: string;\n  private baseUrl: string = 'https://api.openai.com/v1';\n  \n  constructor(apiKey: string) {\n    this.apiKey = apiKey;\n  }\n  \n  async chat(request: LLMRequest): Promise<LLMResponse> {\n    const model = request.model || 'gpt-4-turbo-preview';\n    const startTime = Date.now();\n    \n    logger.info('OpenAI chat request', {\n      model,\n      messageCount: request.messages.length,\n    });\n    \n    try {\n      const response = await fetch(`${this.baseUrl}/chat/completions`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${this.apiKey}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          model,\n          messages: request.messages,\n          temperature: request.temperature ?? 0.7,\n          max_tokens: request.maxTokens ?? 4096,\n        }),\n      });\n      \n      if (!response.ok) {\n        const error = await response.text();\n        logger.error('OpenAI API error', { status: response.status, error });\n        throw new Error(`OpenAI API error: ${response.status} - ${error}`);\n      }\n      \n      const data: any = await response.json();\n      const duration = Date.now() - startTime;\n      \n      const result = {\n        content: data.choices[0].message.content,\n        model: data.model,\n        usage: {\n          promptTokens: data.usage.prompt_tokens,\n          completionTokens: data.usage.completion_tokens,\n          totalTokens: data.usage.total_tokens,\n        },\n      };\n      \n      // Record metrics for successful call\n      recordLLMCallMetrics({\n        operation: 'chat',\n        model: data.model,\n        provider: 'openai',\n        promptTokens: result.usage.promptTokens,\n        completionTokens: result.usage.completionTokens,\n        totalTokens: result.usage.totalTokens,\n        durationMs: duration,\n        success: true,\n      });\n      \n      return result;\n    } catch (error) {\n      const duration = Date.now() - startTime;\n      \n      // Record metrics for failed call\n      recordLLMCallMetrics({\n        operation: 'chat',\n        model,\n        provider: 'openai',\n        promptTokens: 0,\n        completionTokens: 0,\n        totalTokens: 0,\n        durationMs: duration,\n        success: false,\n        errorType: error instanceof Error ? error.message : 'Unknown error',\n      });\n      \n      throw error;\n    }\n  }\n  \n  async vision(request: VisionRequest): Promise<string> {\n    const model = request.model || 'gpt-4-vision-preview';\n    \n    logger.info('OpenAI vision request', { model });\n    \n    const response = await fetch(`${this.baseUrl}/chat/completions`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${this.apiKey}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        model,\n        messages: [\n          {\n            role: 'user',\n            content: [\n              {\n                type: 'text',\n                text: request.prompt,\n              },\n              {\n                type: 'image_url',\n                image_url: {\n                  url: request.imageUrl,\n                },\n              },\n            ],\n          },\n        ],\n        max_tokens: 1024,\n      }),\n    });\n    \n    if (!response.ok) {\n      const error = await response.text();\n      logger.error('OpenAI vision API error', { status: response.status, error });\n      throw new Error(`OpenAI vision API error: ${response.status} - ${error}`);\n    }\n    \n    const data: any = await response.json();\n    return data.choices[0].message.content;\n  }\n}\n\n/**\n * Anthropic API client (direct)\n */\nclass AnthropicClient {\n  private apiKey: string;\n  private baseUrl: string = 'https://api.anthropic.com/v1';\n  \n  constructor(apiKey: string) {\n    this.apiKey = apiKey;\n  }\n  \n  async chat(request: LLMRequest): Promise<LLMResponse> {\n    const model = request.model || 'claude-3-opus-20240229';\n    const startTime = Date.now();\n    \n    logger.info('Anthropic chat request', {\n      model,\n      messageCount: request.messages.length,\n    });\n    \n    try {\n      // Convert messages format for Anthropic\n      const systemMessage = request.messages.find(m => m.role === 'system');\n      const messages = request.messages\n        .filter(m => m.role !== 'system')\n        .map(m => ({\n          role: m.role === 'assistant' ? 'assistant' : 'user',\n          content: m.content,\n        }));\n      \n      const response = await fetch(`${this.baseUrl}/messages`, {\n        method: 'POST',\n        headers: {\n          'x-api-key': this.apiKey,\n          'anthropic-version': '2023-06-01',\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          model,\n          messages,\n          system: systemMessage?.content,\n          temperature: request.temperature ?? 0.7,\n          max_tokens: request.maxTokens ?? 4096,\n        }),\n      });\n      \n      if (!response.ok) {\n        const error = await response.text();\n        logger.error('Anthropic API error', { status: response.status, error });\n        throw new Error(`Anthropic API error: ${response.status} - ${error}`);\n      }\n      \n      const data: any = await response.json();\n      const duration = Date.now() - startTime;\n      \n      const result = {\n        content: data.content[0].text,\n        model: data.model,\n        usage: {\n          promptTokens: data.usage.input_tokens,\n          completionTokens: data.usage.output_tokens,\n          totalTokens: data.usage.input_tokens + data.usage.output_tokens,\n        },\n      };\n      \n      // Record metrics for successful call\n      recordLLMCallMetrics({\n        operation: 'chat',\n        model: data.model,\n        provider: 'anthropic',\n        promptTokens: result.usage.promptTokens,\n        completionTokens: result.usage.completionTokens,\n        totalTokens: result.usage.totalTokens,\n        durationMs: duration,\n        success: true,\n      });\n      \n      return result;\n    } catch (error) {\n      const duration = Date.now() - startTime;\n      \n      // Record metrics for failed call\n      recordLLMCallMetrics({\n        operation: 'chat',\n        model,\n        provider: 'anthropic',\n        promptTokens: 0,\n        completionTokens: 0,\n        totalTokens: 0,\n        durationMs: duration,\n        success: false,\n        errorType: error instanceof Error ? error.message : 'Unknown error',\n      });\n      \n      throw error;\n    }\n  }\n  \n  async vision(request: VisionRequest): Promise<string> {\n    const model = request.model || 'claude-3-opus-20240229';\n    \n    logger.info('Anthropic vision request', { model });\n    \n    const response = await fetch(`${this.baseUrl}/messages`, {\n      method: 'POST',\n      headers: {\n        'x-api-key': this.apiKey,\n        'anthropic-version': '2023-06-01',\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        model,\n        messages: [\n          {\n            role: 'user',\n            content: [\n              {\n                type: 'image',\n                source: {\n                  type: 'url',\n                  url: request.imageUrl,\n                },\n              },\n              {\n                type: 'text',\n                text: request.prompt,\n              },\n            ],\n          },\n        ],\n        max_tokens: 1024,\n      }),\n    });\n    \n    if (!response.ok) {\n      const error = await response.text();\n      logger.error('Anthropic vision API error', { status: response.status, error });\n      throw new Error(`Anthropic vision API error: ${response.status} - ${error}`);\n    }\n    \n    const data: any = await response.json();\n    return data.content[0].text;\n  }\n}\n\n/**\n * LLM Service - Main interface\n */\nexport class LLMService {\n  private provider: LLMProvider;\n  private client: OpenRouterClient | OpenAIClient | AnthropicClient;\n  \n  constructor(provider?: LLMProvider) {\n    this.provider = provider || this.detectProvider();\n    this.client = this.createClient();\n    \n    logger.info('LLM Service initialized', { provider: this.provider });\n  }\n  \n  private detectProvider(): LLMProvider {\n    // Check environment variables to determine provider\n    if (process.env.OPENROUTER_API_KEY) {\n      return 'openrouter';\n    } else if (process.env.OPENAI_API_KEY) {\n      return 'openai';\n    } else if (process.env.ANTHROPIC_API_KEY) {\n      return 'anthropic';\n    }\n    \n    // Default to OpenRouter\n    return 'openrouter';\n  }\n  \n  private createClient(): OpenRouterClient | OpenAIClient | AnthropicClient {\n    switch (this.provider) {\n      case 'openrouter':\n        const openrouterKey = process.env.OPENROUTER_API_KEY || process.env.OPENAI_API_KEY;\n        if (!openrouterKey) {\n          throw new Error('OPENROUTER_API_KEY or OPENAI_API_KEY not set');\n        }\n        return new OpenRouterClient(openrouterKey);\n      \n      case 'openai':\n        const openaiKey = process.env.OPENAI_API_KEY;\n        if (!openaiKey) {\n          throw new Error('OPENAI_API_KEY not set');\n        }\n        return new OpenAIClient(openaiKey);\n      \n      case 'anthropic':\n        const anthropicKey = process.env.ANTHROPIC_API_KEY;\n        if (!anthropicKey) {\n          throw new Error('ANTHROPIC_API_KEY not set');\n        }\n        return new AnthropicClient(anthropicKey);\n      \n      default:\n        throw new Error(`Unknown provider: ${this.provider}`);\n    }\n  }\n  \n  /**\n   * Send a chat completion request with retry logic\n   */\n  async chat(request: LLMRequest): Promise<LLMResponse> {\n    // Configurable retry settings for OpenRouter\n    const maxAttempts = parseInt(process.env.LLM_MAX_RETRY_ATTEMPTS || '5', 10);\n    const initialDelay = parseInt(process.env.LLM_INITIAL_RETRY_DELAY_MS || '2000', 10);\n    const maxDelay = parseInt(process.env.LLM_MAX_RETRY_DELAY_MS || '30000', 10);\n    \n    return withRetry(\n      async () => this.client.chat(request),\n      {\n        maxAttempts,\n        initialDelayMs: initialDelay,\n        maxDelayMs: maxDelay,\n        backoffMultiplier: 2,\n        retryableErrors: ['ECONNRESET', 'ETIMEDOUT', 'ENOTFOUND', 'ECONNREFUSED', 'RateLimitError'],\n      }\n    );\n  }\n  \n  /**\n   * Analyze an image with vision model with retry logic\n   */\n  async vision(request: VisionRequest): Promise<string> {\n    // More aggressive retry for vision (often hits rate limits)\n    const maxAttempts = parseInt(process.env.LLM_VISION_MAX_RETRY_ATTEMPTS || '5', 10);\n    const initialDelay = parseInt(process.env.LLM_VISION_INITIAL_RETRY_DELAY_MS || '3000', 10);\n    const maxDelay = parseInt(process.env.LLM_VISION_MAX_RETRY_DELAY_MS || '60000', 10);\n    \n    return withRetry(\n      async () => this.client.vision(request),\n      {\n        maxAttempts,\n        initialDelayMs: initialDelay,\n        maxDelayMs: maxDelay,\n        backoffMultiplier: 2,\n        retryableErrors: ['ECONNRESET', 'ETIMEDOUT', 'ENOTFOUND', 'ECONNREFUSED', 'RateLimitError'],\n      }\n    );\n  }\n  \n  /**\n   * Get the current provider\n   */\n  getProvider(): LLMProvider {\n    return this.provider;\n  }\n}\n\n/**\n * Default LLM service instance\n */\nexport const llmService = new LLMService();\n\n/**\n * Model recommendations for different tasks\n */\nexport const RECOMMENDED_MODELS = {\n  // Content analysis - needs good reasoning\n  analysis: {\n    openrouter: 'openai/gpt-4-turbo-preview',\n    openai: 'gpt-4-turbo-preview',\n    anthropic: 'claude-3-opus-20240229',\n  },\n  \n  // Vision - for figures and diagrams\n  vision: {\n    openrouter: 'openai/gpt-4-vision-preview',\n    openai: 'gpt-4-vision-preview',\n    anthropic: 'claude-3-opus-20240229',\n  },\n  \n  // Segmentation - needs good structure understanding\n  segmentation: {\n    openrouter: 'anthropic/claude-3-opus',\n    openai: 'gpt-4-turbo-preview',\n    anthropic: 'claude-3-opus-20240229',\n  },\n  \n  // Script generation - needs creativity\n  script: {\n    openrouter: 'openai/gpt-4-turbo-preview',\n    openai: 'gpt-4-turbo-preview',\n    anthropic: 'claude-3-opus-20240229',\n  },\n  \n  // Fast/cheap for testing\n  fast: {\n    openrouter: 'openai/gpt-3.5-turbo',\n    openai: 'gpt-3.5-turbo',\n    anthropic: 'claude-3-haiku-20240307',\n  },\n};\n\n/**\n * Get recommended model for a task\n */\nexport function getRecommendedModel(\n  task: keyof typeof RECOMMENDED_MODELS,\n  provider?: LLMProvider\n): string {\n  // Check for environment variable override first\n  const envVarMap: Record<string, string> = {\n    'analysis': process.env.LLM_MODEL_ANALYSIS || '',\n    'vision': process.env.LLM_MODEL_VISION || '',\n    'segmentation': process.env.LLM_MODEL_SEGMENTATION || '',\n    'script': process.env.LLM_MODEL_SCRIPT || '',\n    'fast': process.env.LLM_MODEL_FAST || '',\n  };\n  \n  if (envVarMap[task]) {\n    return envVarMap[task];\n  }\n  \n  // Fall back to recommended models\n  const detectedProvider = provider || (process.env.OPENROUTER_API_KEY ? 'openrouter' : 'openai');\n  return RECOMMENDED_MODELS[task][detectedProvider];\n}\n", "// Retry logic and circuit breaker utilities\n\nimport { logger } from './logger';\nimport { ExternalServiceError, ResourceError } from './errors';\n\nexport interface RetryOptions {\n  maxAttempts?: number;\n  initialDelayMs?: number;\n  maxDelayMs?: number;\n  backoffMultiplier?: number;\n  retryableErrors?: string[];\n}\n\nconst DEFAULT_RETRY_OPTIONS: Required<RetryOptions> = {\n  maxAttempts: 3,\n  initialDelayMs: 1000,\n  maxDelayMs: 10000,\n  backoffMultiplier: 2,\n  retryableErrors: ['ECONNRESET', 'ETIMEDOUT', 'ENOTFOUND', 'ECONNREFUSED'],\n};\n\n/**\n * Delays execution for the specified number of milliseconds\n */\nfunction delay(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Determines if an error is retryable\n */\nfunction isRetryableError(error: any, retryableErrors: string[]): boolean {\n  if (!error) return false;\n  \n  // Check if error has retryable flag\n  if (typeof error.retryable === 'boolean') {\n    return error.retryable;\n  }\n  \n  // Check error name (for custom error classes)\n  if (error.name && retryableErrors.includes(error.name)) {\n    return true;\n  }\n  \n  // Check error code\n  if (error.code && retryableErrors.includes(error.code)) {\n    return true;\n  }\n  \n  // Check for common transient error messages\n  const message = error.message?.toLowerCase() || '';\n  return (\n    message.includes('timeout') ||\n    message.includes('connection') ||\n    message.includes('network') ||\n    message.includes('temporary') ||\n    message.includes('rate limit') ||\n    message.includes('429') ||\n    message.includes('too many requests')\n  );\n}\n\n/**\n * Executes a function with exponential backoff retry logic\n * @param fn Function to execute\n * @param options Retry configuration options\n * @returns Result of the function\n * @throws Last error if all retries fail\n */\nexport async function withRetry<T>(\n  fn: () => Promise<T>,\n  options: RetryOptions = {}\n): Promise<T> {\n  const opts = { ...DEFAULT_RETRY_OPTIONS, ...options };\n  let lastError: any;\n  let delayMs = opts.initialDelayMs;\n  \n  for (let attempt = 1; attempt <= opts.maxAttempts; attempt++) {\n    try {\n      const result = await fn();\n      \n      if (attempt > 1) {\n        logger.info('Operation succeeded after retry', { attempt });\n      }\n      \n      return result;\n    } catch (error) {\n      lastError = error;\n      \n      const isRetryable = isRetryableError(error, opts.retryableErrors);\n      const isLastAttempt = attempt === opts.maxAttempts;\n      \n      logger.warn('Operation failed', {\n        attempt,\n        maxAttempts: opts.maxAttempts,\n        isRetryable,\n        error: error instanceof Error ? error.message : String(error),\n      });\n      \n      if (!isRetryable || isLastAttempt) {\n        throw error;\n      }\n      \n      // Wait before retrying\n      logger.info('Retrying operation', { attempt, delayMs });\n      await delay(delayMs);\n      \n      // Increase delay for next attempt (exponential backoff)\n      delayMs = Math.min(delayMs * opts.backoffMultiplier, opts.maxDelayMs);\n    }\n  }\n  \n  throw lastError;\n}\n\n// ============================================================================\n// Circuit Breaker\n// ============================================================================\n\nexport enum CircuitState {\n  CLOSED = 'CLOSED',     // Normal operation\n  OPEN = 'OPEN',         // Failing, reject requests\n  HALF_OPEN = 'HALF_OPEN', // Testing if service recovered\n}\n\nexport interface CircuitBreakerOptions {\n  failureThreshold?: number;\n  successThreshold?: number;\n  timeout?: number;\n  resetTimeoutMs?: number;\n}\n\nconst DEFAULT_CIRCUIT_OPTIONS: Required<CircuitBreakerOptions> = {\n  failureThreshold: 5,\n  successThreshold: 2,\n  timeout: 30000,\n  resetTimeoutMs: 60000,\n};\n\n/**\n * Circuit breaker implementation for external service calls\n */\nexport class CircuitBreaker {\n  private state: CircuitState = CircuitState.CLOSED;\n  private failureCount = 0;\n  private successCount = 0;\n  private nextAttemptTime = 0;\n  private readonly options: Required<CircuitBreakerOptions>;\n  \n  constructor(\n    private readonly serviceName: string,\n    options: CircuitBreakerOptions = {}\n  ) {\n    this.options = { ...DEFAULT_CIRCUIT_OPTIONS, ...options };\n  }\n  \n  /**\n   * Executes a function with circuit breaker protection\n   */\n  async execute<T>(fn: () => Promise<T>): Promise<T> {\n    if (this.state === CircuitState.OPEN) {\n      if (Date.now() < this.nextAttemptTime) {\n        logger.warn('Circuit breaker is OPEN, rejecting request', {\n          service: this.serviceName,\n          nextAttemptTime: new Date(this.nextAttemptTime).toISOString(),\n        });\n        throw new ExternalServiceError(\n          `Service ${this.serviceName} is currently unavailable (circuit breaker OPEN)`,\n          this.serviceName\n        );\n      }\n      \n      // Try to recover\n      this.state = CircuitState.HALF_OPEN;\n      this.successCount = 0;\n      logger.info('Circuit breaker entering HALF_OPEN state', {\n        service: this.serviceName,\n      });\n    }\n    \n    try {\n      // Execute with timeout\n      const result = await this.executeWithTimeout(fn);\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      this.onFailure();\n      throw error;\n    }\n  }\n  \n  /**\n   * Executes function with timeout\n   */\n  private async executeWithTimeout<T>(fn: () => Promise<T>): Promise<T> {\n    return Promise.race([\n      fn(),\n      new Promise<T>((_, reject) =>\n        setTimeout(\n          () => reject(new ResourceError('Operation timeout', { timeout: this.options.timeout })),\n          this.options.timeout\n        )\n      ),\n    ]);\n  }\n  \n  /**\n   * Handles successful execution\n   */\n  private onSuccess(): void {\n    this.failureCount = 0;\n    \n    if (this.state === CircuitState.HALF_OPEN) {\n      this.successCount++;\n      \n      if (this.successCount >= this.options.successThreshold) {\n        this.state = CircuitState.CLOSED;\n        this.successCount = 0;\n        logger.info('Circuit breaker closed', { service: this.serviceName });\n      }\n    }\n  }\n  \n  /**\n   * Handles failed execution\n   */\n  private onFailure(): void {\n    this.failureCount++;\n    this.successCount = 0;\n    \n    if (this.state === CircuitState.HALF_OPEN) {\n      this.state = CircuitState.OPEN;\n      this.nextAttemptTime = Date.now() + this.options.resetTimeoutMs;\n      logger.warn('Circuit breaker opened from HALF_OPEN', {\n        service: this.serviceName,\n        nextAttemptTime: new Date(this.nextAttemptTime).toISOString(),\n      });\n    } else if (this.failureCount >= this.options.failureThreshold) {\n      this.state = CircuitState.OPEN;\n      this.nextAttemptTime = Date.now() + this.options.resetTimeoutMs;\n      logger.warn('Circuit breaker opened', {\n        service: this.serviceName,\n        failureCount: this.failureCount,\n        nextAttemptTime: new Date(this.nextAttemptTime).toISOString(),\n      });\n    }\n  }\n  \n  /**\n   * Gets current circuit breaker state\n   */\n  getState(): CircuitState {\n    return this.state;\n  }\n  \n  /**\n   * Resets circuit breaker to closed state\n   */\n  reset(): void {\n    this.state = CircuitState.CLOSED;\n    this.failureCount = 0;\n    this.successCount = 0;\n    this.nextAttemptTime = 0;\n    logger.info('Circuit breaker manually reset', { service: this.serviceName });\n  }\n}\n\n// ============================================================================\n// Global Circuit Breakers\n// ============================================================================\n\nconst circuitBreakers = new Map<string, CircuitBreaker>();\n\n/**\n * Gets or creates a circuit breaker for a service\n */\nexport function getCircuitBreaker(\n  serviceName: string,\n  options?: CircuitBreakerOptions\n): CircuitBreaker {\n  if (!circuitBreakers.has(serviceName)) {\n    circuitBreakers.set(serviceName, new CircuitBreaker(serviceName, options));\n  }\n  return circuitBreakers.get(serviceName)!;\n}\n\n/**\n * Executes a function with both retry logic and circuit breaker protection\n */\nexport async function withRetryAndCircuitBreaker<T>(\n  serviceName: string,\n  fn: () => Promise<T>,\n  retryOptions?: RetryOptions,\n  circuitOptions?: CircuitBreakerOptions\n): Promise<T> {\n  const circuitBreaker = getCircuitBreaker(serviceName, circuitOptions);\n  \n  return withRetry(\n    () => circuitBreaker.execute(fn),\n    retryOptions\n  );\n}\n", "// LLM-specific metrics tracking for monitoring API usage, costs, and performance\n\nimport { logger } from './logger';\nimport { metrics } from './metrics';\n\n/**\n * Model pricing per 1M tokens (approximate, as of 2024-2025)\n * These are rough estimates and should be updated based on actual provider pricing\n */\nconst MODEL_PRICING = {\n  // OpenAI models\n  'gpt-4-turbo-preview': { input: 10.0, output: 30.0 },\n  'gpt-4-vision-preview': { input: 10.0, output: 30.0 },\n  'gpt-3.5-turbo': { input: 0.5, output: 1.5 },\n  \n  // Anthropic models\n  'claude-3-opus-20240229': { input: 15.0, output: 75.0 },\n  'claude-3-sonnet-20240229': { input: 3.0, output: 15.0 },\n  'claude-3-haiku-20240307': { input: 0.25, output: 1.25 },\n  \n  // OpenRouter models (using base model pricing)\n  'openai/gpt-4-turbo-preview': { input: 10.0, output: 30.0 },\n  'openai/gpt-4-vision-preview': { input: 10.0, output: 30.0 },\n  'openai/gpt-3.5-turbo': { input: 0.5, output: 1.5 },\n  'anthropic/claude-3-opus': { input: 15.0, output: 75.0 },\n  'anthropic/claude-3-sonnet': { input: 3.0, output: 15.0 },\n  'anthropic/claude-3-5-sonnet': { input: 3.0, output: 15.0 },\n  'anthropic/claude-3-haiku': { input: 0.25, output: 1.25 },\n  \n  // FREE OpenRouter models (cost = $0)\n  'google/gemini-2.0-flash-exp:free': { input: 0.0, output: 0.0 },\n  'google/gemini-pro-vision': { input: 0.0, output: 0.0 },\n  'x-ai/grok-4.1-fast:free': { input: 0.0, output: 0.0 },\n  'meta-llama/llama-3.3-70b-instruct:free': { input: 0.0, output: 0.0 },\n  'meta-llama/llama-3.1-405b-instruct:free': { input: 0.0, output: 0.0 },\n  'qwen/qwen-2.5-72b-instruct:free': { input: 0.0, output: 0.0 },\n  'mistralai/mistral-7b-instruct:free': { input: 0.0, output: 0.0 },\n  \n  // Default fallback pricing\n  'default': { input: 5.0, output: 15.0 },\n};\n\n/**\n * Calculate cost for an LLM API call based on token usage\n */\nexport function calculateLLMCost(\n  model: string,\n  promptTokens: number,\n  completionTokens: number\n): number {\n  // Get pricing for the model, or use default\n  const pricing = MODEL_PRICING[model as keyof typeof MODEL_PRICING] || MODEL_PRICING.default;\n  \n  // Calculate cost (pricing is per 1M tokens, so divide by 1,000,000)\n  const inputCost = (promptTokens / 1_000_000) * pricing.input;\n  const outputCost = (completionTokens / 1_000_000) * pricing.output;\n  \n  return inputCost + outputCost;\n}\n\n/**\n * Track metrics for an LLM API call\n */\nexport interface LLMCallMetrics {\n  operation: string; // e.g., 'segmentation', 'script_generation', 'vision_analysis'\n  model: string;\n  provider: string;\n  promptTokens: number;\n  completionTokens: number;\n  totalTokens: number;\n  durationMs: number;\n  success: boolean;\n  errorType?: string;\n  jobId?: string;\n}\n\n/**\n * Record metrics for an LLM API call\n */\nexport function recordLLMCallMetrics(callMetrics: LLMCallMetrics): void {\n  const dimensions = {\n    operation: callMetrics.operation,\n    model: callMetrics.model,\n    provider: callMetrics.provider,\n    success: callMetrics.success.toString(),\n  };\n  \n  // Record success/failure count\n  if (callMetrics.success) {\n    metrics.recordCount('LLMCallSuccess', 1, dimensions);\n  } else {\n    metrics.recordCount('LLMCallFailure', 1, {\n      ...dimensions,\n      errorType: callMetrics.errorType || 'Unknown',\n    });\n  }\n  \n  // Record response time\n  metrics.recordDuration('LLMCallDuration', callMetrics.durationMs, dimensions);\n  \n  // Record token usage\n  metrics.recordCount('LLMPromptTokens', callMetrics.promptTokens, dimensions);\n  metrics.recordCount('LLMCompletionTokens', callMetrics.completionTokens, dimensions);\n  metrics.recordCount('LLMTotalTokens', callMetrics.totalTokens, dimensions);\n  \n  // Calculate and record cost\n  const cost = calculateLLMCost(\n    callMetrics.model,\n    callMetrics.promptTokens,\n    callMetrics.completionTokens\n  );\n  \n  // Record cost in cents (multiply by 100 to avoid floating point issues)\n  metrics.recordCount('LLMCallCostCents', Math.round(cost * 100), dimensions);\n  \n  // Log detailed metrics\n  logger.info('LLM call metrics recorded', {\n    ...callMetrics,\n    estimatedCost: cost,\n    costFormatted: `$${cost.toFixed(4)}`,\n  });\n}\n\n/**\n * Helper class to track LLM metrics for a specific job\n */\nexport class JobLLMMetrics {\n  private jobId: string;\n  private totalCost: number = 0;\n  private totalTokens: number = 0;\n  private totalCalls: number = 0;\n  private callsByOperation: Map<string, number> = new Map();\n  \n  constructor(jobId: string) {\n    this.jobId = jobId;\n  }\n  \n  /**\n   * Record an LLM call for this job\n   */\n  recordCall(callMetrics: Omit<LLMCallMetrics, 'jobId'>): void {\n    // Add jobId to metrics\n    const fullMetrics: LLMCallMetrics = {\n      ...callMetrics,\n      jobId: this.jobId,\n    };\n    \n    // Record global metrics\n    recordLLMCallMetrics(fullMetrics);\n    \n    // Update job-specific tracking\n    if (callMetrics.success) {\n      this.totalCalls++;\n      this.totalTokens += callMetrics.totalTokens;\n      \n      const cost = calculateLLMCost(\n        callMetrics.model,\n        callMetrics.promptTokens,\n        callMetrics.completionTokens\n      );\n      this.totalCost += cost;\n      \n      // Track calls by operation\n      const currentCount = this.callsByOperation.get(callMetrics.operation) || 0;\n      this.callsByOperation.set(callMetrics.operation, currentCount + 1);\n    }\n  }\n  \n  /**\n   * Get summary of LLM usage for this job\n   */\n  getSummary(): {\n    jobId: string;\n    totalCalls: number;\n    totalTokens: number;\n    totalCost: number;\n    callsByOperation: Record<string, number>;\n  } {\n    return {\n      jobId: this.jobId,\n      totalCalls: this.totalCalls,\n      totalTokens: this.totalTokens,\n      totalCost: this.totalCost,\n      callsByOperation: Object.fromEntries(this.callsByOperation),\n    };\n  }\n  \n  /**\n   * Log final summary for this job\n   */\n  logSummary(): void {\n    const summary = this.getSummary();\n    \n    logger.info('Job LLM metrics summary', {\n      ...summary,\n      costFormatted: `$${summary.totalCost.toFixed(4)}`,\n    });\n    \n    // Record job-level metrics\n    metrics.recordCount('JobLLMCalls', summary.totalCalls, { jobId: this.jobId });\n    metrics.recordCount('JobLLMTokens', summary.totalTokens, { jobId: this.jobId });\n    metrics.recordCount('JobLLMCostCents', Math.round(summary.totalCost * 100), { jobId: this.jobId });\n  }\n}\n\n/**\n * Calculate success rate for LLM calls\n */\nexport function calculateLLMSuccessRate(\n  successCount: number,\n  failureCount: number\n): number {\n  const total = successCount + failureCount;\n  if (total === 0) return 100;\n  return (successCount / total) * 100;\n}\n", "// Metrics collection utility for tracking request counts, error rates, processing times, and storage usage\n\nimport { logger } from './logger';\n\nexport enum MetricType {\n  COUNT = 'Count',\n  DURATION = 'Duration',\n  SIZE = 'Size',\n  RATE = 'Rate',\n}\n\nexport enum MetricUnit {\n  COUNT = 'Count',\n  MILLISECONDS = 'Milliseconds',\n  SECONDS = 'Seconds',\n  BYTES = 'Bytes',\n  MEGABYTES = 'Megabytes',\n  PERCENT = 'Percent',\n}\n\ninterface MetricData {\n  name: string;\n  value: number;\n  unit: MetricUnit;\n  timestamp: Date;\n  dimensions?: Record<string, string>;\n}\n\ninterface TimerHandle {\n  name: string;\n  startTime: number;\n  dimensions?: Record<string, string>;\n}\n\nclass MetricsCollector {\n  private metrics: MetricData[] = [];\n  private activeTimers: Map<string, TimerHandle> = new Map();\n\n  /**\n   * Record a count metric (e.g., request count, error count)\n   */\n  recordCount(name: string, value: number = 1, dimensions?: Record<string, string>) {\n    this.recordMetric(name, value, MetricUnit.COUNT, dimensions);\n  }\n\n  /**\n   * Record a duration metric in milliseconds\n   */\n  recordDuration(name: string, durationMs: number, dimensions?: Record<string, string>) {\n    this.recordMetric(name, durationMs, MetricUnit.MILLISECONDS, dimensions);\n  }\n\n  /**\n   * Record a size metric in bytes\n   */\n  recordSize(name: string, sizeBytes: number, dimensions?: Record<string, string>) {\n    this.recordMetric(name, sizeBytes, MetricUnit.BYTES, dimensions);\n  }\n\n  /**\n   * Record a rate metric (e.g., error rate as percentage)\n   */\n  recordRate(name: string, rate: number, dimensions?: Record<string, string>) {\n    this.recordMetric(name, rate, MetricUnit.PERCENT, dimensions);\n  }\n\n  /**\n   * Start a timer for measuring duration\n   */\n  startTimer(name: string, dimensions?: Record<string, string>): string {\n    const timerId = `${name}-${Date.now()}-${Math.random()}`;\n    this.activeTimers.set(timerId, {\n      name,\n      startTime: Date.now(),\n      dimensions,\n    });\n    return timerId;\n  }\n\n  /**\n   * Stop a timer and record the duration\n   */\n  stopTimer(timerId: string): number | null {\n    const timer = this.activeTimers.get(timerId);\n    if (!timer) {\n      logger.warn('Attempted to stop non-existent timer', { timerId });\n      return null;\n    }\n\n    const duration = Date.now() - timer.startTime;\n    this.recordDuration(timer.name, duration, timer.dimensions);\n    this.activeTimers.delete(timerId);\n    return duration;\n  }\n\n  /**\n   * Record a generic metric\n   */\n  private recordMetric(\n    name: string,\n    value: number,\n    unit: MetricUnit,\n    dimensions?: Record<string, string>\n  ) {\n    const metric: MetricData = {\n      name,\n      value,\n      unit,\n      timestamp: new Date(),\n      dimensions,\n    };\n\n    this.metrics.push(metric);\n\n    // Log the metric for CloudWatch ingestion\n    logger.info('Metric recorded', {\n      metric: {\n        name: metric.name,\n        value: metric.value,\n        unit: metric.unit,\n        dimensions: metric.dimensions,\n      },\n    });\n\n    // In production, this would also publish to CloudWatch\n    if (process.env.NODE_ENV === 'production') {\n      this.publishToCloudWatch(metric);\n    }\n  }\n\n  /**\n   * Publish metric to CloudWatch\n   */\n  private async publishToCloudWatch(metric: MetricData) {\n    // Dynamically import to avoid circular dependencies\n    const { publishMetric } = await import('./cloudwatch');\n    \n    await publishMetric({\n      name: metric.name,\n      value: metric.value,\n      unit: metric.unit,\n      dimensions: metric.dimensions,\n      timestamp: metric.timestamp,\n    });\n  }\n\n  /**\n   * Get all recorded metrics (useful for testing)\n   */\n  getMetrics(): MetricData[] {\n    return [...this.metrics];\n  }\n\n  /**\n   * Clear all recorded metrics\n   */\n  clearMetrics() {\n    this.metrics = [];\n  }\n}\n\n// Singleton instance\nexport const metrics = new MetricsCollector();\n\n/**\n * Decorator for measuring function execution time\n */\nexport function measureExecutionTime(metricName: string, dimensions?: Record<string, string>) {\n  return function (\n    _target: any,\n    _propertyKey: string,\n    descriptor: PropertyDescriptor\n  ) {\n    const originalMethod = descriptor.value;\n\n    descriptor.value = async function (...args: any[]) {\n      const timerId = metrics.startTimer(metricName, dimensions);\n      try {\n        const result = await originalMethod.apply(this, args);\n        metrics.stopTimer(timerId);\n        return result;\n      } catch (error) {\n        metrics.stopTimer(timerId);\n        throw error;\n      }\n    };\n\n    return descriptor;\n  };\n}\n\n/**\n * Helper to track request metrics\n */\nexport class RequestMetrics {\n  private requestCount = 0;\n  private errorCount = 0;\n  private successCount = 0;\n\n  incrementRequest(endpoint: string) {\n    this.requestCount++;\n    metrics.recordCount('RequestCount', 1, { endpoint });\n  }\n\n  incrementError(endpoint: string, errorType?: string) {\n    this.errorCount++;\n    metrics.recordCount('ErrorCount', 1, { endpoint, errorType: errorType || 'Unknown' });\n  }\n\n  incrementSuccess(endpoint: string) {\n    this.successCount++;\n    metrics.recordCount('SuccessCount', 1, { endpoint });\n  }\n\n  getErrorRate(): number {\n    if (this.requestCount === 0) return 0;\n    return (this.errorCount / this.requestCount) * 100;\n  }\n\n  recordErrorRate(endpoint: string) {\n    const rate = this.getErrorRate();\n    metrics.recordRate('ErrorRate', rate, { endpoint });\n  }\n}\n\n/**\n * Helper to track processing stage metrics\n */\nexport class StageMetrics {\n  recordStageStart(stage: string, jobId: string) {\n    metrics.recordCount('StageStarted', 1, { stage, jobId });\n  }\n\n  recordStageComplete(stage: string, jobId: string, durationMs: number) {\n    metrics.recordCount('StageCompleted', 1, { stage, jobId });\n    metrics.recordDuration('StageDuration', durationMs, { stage, jobId });\n  }\n\n  recordStageFailed(stage: string, jobId: string, errorType: string) {\n    metrics.recordCount('StageFailed', 1, { stage, jobId, errorType });\n  }\n}\n\n/**\n * Helper to track external API metrics\n */\nexport class ExternalAPIMetrics {\n  recordAPICall(apiName: string, operation: string) {\n    metrics.recordCount('ExternalAPICall', 1, { apiName, operation });\n  }\n\n  recordAPILatency(apiName: string, operation: string, latencyMs: number) {\n    metrics.recordDuration('ExternalAPILatency', latencyMs, { apiName, operation });\n  }\n\n  recordAPIError(apiName: string, operation: string, errorType: string) {\n    metrics.recordCount('ExternalAPIError', 1, { apiName, operation, errorType });\n  }\n}\n\n/**\n * Helper to track storage metrics\n */\nexport class StorageMetrics {\n  recordStorageWrite(storageType: string, sizeBytes: number) {\n    metrics.recordCount('StorageWrite', 1, { storageType });\n    metrics.recordSize('StorageWriteSize', sizeBytes, { storageType });\n  }\n\n  recordStorageRead(storageType: string, sizeBytes: number) {\n    metrics.recordCount('StorageRead', 1, { storageType });\n    metrics.recordSize('StorageReadSize', sizeBytes, { storageType });\n  }\n\n  recordStorageUsage(storageType: string, totalBytes: number) {\n    metrics.recordSize('StorageUsage', totalBytes, { storageType });\n  }\n}\n", "// EventBridge service for asynchronous function triggering\nimport { EventBridge } from 'aws-sdk';\nimport { config } from '../utils/config';\nimport { logger } from '../utils/logger';\n\nconst eventBridge = new EventBridge({\n  endpoint: config.isLocal ? 'http://localhost:4566' : undefined,\n  region: config.awsRegion,\n});\n\nexport interface PipelineEvent {\n  jobId: string;\n  agentId?: string;\n  metadata?: Record<string, any>;\n}\n\n/**\n * Publish an event to EventBridge to trigger the next stage in the pipeline\n */\nexport async function publishPipelineEvent(\n  detailType: string,\n  detail: PipelineEvent\n): Promise<void> {\n  const eventBusName = config.eventBusName || 'pdf-lecture-service-events';\n  \n  try {\n    logger.info('Publishing pipeline event', { detailType, jobId: detail.jobId });\n    \n    const params: EventBridge.PutEventsRequest = {\n      Entries: [\n        {\n          Source: 'pdf-lecture-service',\n          DetailType: detailType,\n          Detail: JSON.stringify(detail),\n          EventBusName: eventBusName,\n        },\n      ],\n    };\n    \n    const result = await eventBridge.putEvents(params).promise();\n    \n    if (result.FailedEntryCount && result.FailedEntryCount > 0) {\n      const errors = result.Entries?.filter(e => e.ErrorCode).map(e => ({\n        code: e.ErrorCode,\n        message: e.ErrorMessage,\n      }));\n      throw new Error(`Failed to publish event: ${JSON.stringify(errors)}`);\n    }\n    \n    logger.info('Pipeline event published successfully', { detailType, jobId: detail.jobId });\n  } catch (error) {\n    logger.error('Failed to publish pipeline event', { error, detailType, jobId: detail.jobId });\n    throw error;\n  }\n}\n\n/**\n * Trigger the content analysis stage\n */\nexport async function triggerAnalysis(jobId: string): Promise<void> {\n  await publishPipelineEvent('JobCreated', { jobId });\n}\n\n/**\n * Trigger the content segmentation stage\n */\nexport async function triggerSegmentation(jobId: string): Promise<void> {\n  await publishPipelineEvent('AnalysisCompleted', { jobId });\n}\n\n/**\n * Trigger the script generation stage\n */\nexport async function triggerScriptGeneration(jobId: string, agentId?: string): Promise<void> {\n  await publishPipelineEvent('SegmentationCompleted', { jobId, agentId });\n}\n\n/**\n * Trigger the audio synthesis stage\n */\nexport async function triggerAudioSynthesis(jobId: string): Promise<void> {\n  await publishPipelineEvent('ScriptGenerationCompleted', { jobId });\n}\n\n/**\n * Publish a job completion event\n */\nexport async function publishJobCompleted(jobId: string): Promise<void> {\n  await publishPipelineEvent('JobCompleted', { jobId });\n}\n\n/**\n * Publish a job failure event\n */\nexport async function publishJobFailed(jobId: string, error: string): Promise<void> {\n  await publishPipelineEvent('JobFailed', { \n    jobId, \n    metadata: { error } \n  });\n}\n"],
  "mappings": "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",
  "names": ["SENSITIVE_PATTERNS", "Logger", "logger", "init_logger", "__esmMin", "_Logger", "envLogLevel", "id", "name", "data", "item", "redacted", "key", "value", "pattern", "level", "levels", "currentLevelIndex", "minLevelIndex", "message", "metadata", "entry", "correlationId", "childLogger", "require_package", "__commonJSMin", "exports", "module", "require_main", "__commonJSMin", "exports", "module", "fs", "path", "os", "crypto", "packageJson", "version", "LINE", "parse", "src", "obj", "lines", "match", "key", "value", "maybeQuote", "_parseVault", "options", "vaultPath", "_vaultPath", "result", "DotenvModule", "err", "keys", "_dotenvKey", "length", "decrypted", "i", "attrs", "_instructions", "error", "_warn", "message", "_debug", "_log", "dotenvKey", "uri", "environment", "environmentKey", "ciphertext", "possibleVaultPath", "filepath", "_resolveHome", "envPath", "_configVault", "debug", "quiet", "parsed", "processEnv", "configDotenv", "dotenvPath", "encoding", "optionPaths", "lastError", "parsedAll", "e", "keysCount", "shortPaths", "filePath", "relative", "config", "decrypt", "encrypted", "keyStr", "nonce", "authTag", "aesgcm", "isRange", "invalidKeyLength", "decryptionFailed", "populate", "override", "import_dotenv", "config", "init_config", "__esmMin", "dotenv", "cloudwatch_exports", "__export", "createAlarm", "createStandardAlarmsForFunction", "publishMetric", "publishMetrics", "metric", "config", "logger", "dimensions", "name", "value", "cloudwatch", "error", "metrics", "metricData", "batchSize", "i", "batch", "params", "functionName", "timeoutMs", "AWS", "init_cloudwatch", "__esmMin", "init_config", "init_logger", "max_default", "init_max", "__esmMin", "nil_default", "init_nil", "__esmMin", "regex_default", "init_regex", "__esmMin", "validate", "uuid", "regex_default", "validate_default", "init_validate", "__esmMin", "init_regex", "parse", "uuid", "validate_default", "v", "parse_default", "init_parse", "__esmMin", "init_validate", "unsafeStringify", "arr", "offset", "byteToHex", "stringify", "uuid", "validate_default", "stringify_default", "init_stringify", "__esmMin", "init_validate", "i", "rng", "poolPtr", "rnds8Pool", "import_node_crypto", "init_rng", "__esmMin", "v1", "options", "buf", "offset", "bytes", "isV6", "optionsKeys", "v1Bytes", "rng", "now", "rnds", "updateV1State", "_state", "unsafeStringify", "state", "msecs", "nsecs", "clockseq", "node", "tl", "tmh", "n", "v1_default", "init_v1", "__esmMin", "init_rng", "init_stringify", "v1ToV6", "uuid", "v1Bytes", "parse_default", "v6Bytes", "_v1ToV6", "unsafeStringify", "init_v1ToV6", "__esmMin", "init_parse", "init_stringify", "md5", "bytes", "import_node_crypto", "md5_default", "init_md5", "__esmMin", "stringToBytes", "str", "bytes", "i", "v35", "version", "hash", "value", "namespace", "buf", "offset", "valueBytes", "namespaceBytes", "parse_default", "unsafeStringify", "DNS", "URL", "init_v35", "__esmMin", "init_parse", "init_stringify", "v3", "value", "namespace", "buf", "offset", "v35", "md5_default", "v3_default", "init_v3", "__esmMin", "init_md5", "init_v35", "DNS", "URL", "import_node_crypto", "native_default", "init_native", "__esmMin", "_v4", "options", "buf", "offset", "rnds", "rng", "unsafeStringify", "v4", "native_default", "v4_default", "init_v4", "__esmMin", "init_native", "init_rng", "init_stringify", "sha1", "bytes", "import_node_crypto", "sha1_default", "init_sha1", "__esmMin", "v5", "value", "namespace", "buf", "offset", "v35", "sha1_default", "v5_default", "init_v5", "__esmMin", "init_sha1", "init_v35", "DNS", "URL", "v6", "options", "buf", "offset", "bytes", "v1_default", "v1ToV6", "unsafeStringify", "v6_default", "init_v6", "__esmMin", "init_stringify", "init_v1", "init_v1ToV6", "v6ToV1", "uuid", "v6Bytes", "parse_default", "v1Bytes", "_v6ToV1", "unsafeStringify", "init_v6ToV1", "__esmMin", "init_parse", "init_stringify", "v7", "options", "buf", "offset", "bytes", "v7Bytes", "rng", "now", "rnds", "updateV7State", "_state", "unsafeStringify", "state", "msecs", "seq", "v7_default", "init_v7", "__esmMin", "init_rng", "init_stringify", "version", "uuid", "validate_default", "version_default", "init_version", "__esmMin", "init_validate", "dist_node_exports", "__export", "max_default", "nil_default", "parse_default", "stringify_default", "v1_default", "v1ToV6", "v3_default", "v4_default", "v5_default", "v6_default", "v6ToV1", "v7_default", "validate_default", "version_default", "init_dist_node", "__esmMin", "init_max", "init_nil", "init_parse", "init_stringify", "init_v1", "init_v1ToV6", "init_v3", "init_v4", "init_v5", "init_v6", "init_v6ToV1", "init_v7", "init_validate", "init_version", "dynamodb_exports", "__export", "createAgent", "createContent", "createJob", "createTablesIfNotExist", "deleteAgent", "deleteContent", "deleteJob", "getAgent", "getContent", "getJob", "listAgents", "listJobs", "updateAgent", "updateContent", "updateJob", "handleDynamoDBError", "error", "operation", "logger", "jobToRecord", "job", "recordToJob", "record", "stage", "dynamoDB", "config", "jobId", "result", "updates", "current", "updated", "item", "agentToRecord", "agent", "recordToAgent", "a", "id", "dynamoDBClient", "AWS", "dynamoDBConfig", "tables", "tableConfig", "createError", "import_aws_sdk", "init_dynamodb", "__esmMin", "init_config", "init_logger", "script_exports", "__export", "scriptHandler", "__toCommonJS", "init_logger", "init_config", "init_logger", "init_logger", "DEFAULT_RETRY_OPTIONS", "delay", "ms", "resolve", "isRetryableError", "error", "retryableErrors", "message", "withRetry", "fn", "options", "opts", "lastError", "delayMs", "attempt", "result", "logger", "isRetryable", "isLastAttempt", "init_logger", "init_logger", "MetricsCollector", "name", "value", "dimensions", "durationMs", "sizeBytes", "rate", "timerId", "timer", "logger", "duration", "unit", "metric", "publishMetric", "metrics", "MODEL_PRICING", "calculateLLMCost", "model", "promptTokens", "completionTokens", "pricing", "inputCost", "outputCost", "recordLLMCallMetrics", "callMetrics", "dimensions", "metrics", "cost", "logger", "RateLimitError", "message", "retryAfter", "OpenRouterClient", "apiKey", "timeSinceLastRequest", "waitTime", "logger", "resolve", "status", "errorText", "errorData", "request", "model", "startTime", "response", "error", "data", "duration", "rateLimitHeaders", "result", "recordLLMCallMetrics", "OpenAIClient", "AnthropicClient", "systemMessage", "m", "messages", "LLMService", "provider", "openrouterKey", "openaiKey", "anthropicKey", "maxAttempts", "initialDelay", "maxDelay", "withRetry", "llmService", "RECOMMENDED_MODELS", "getRecommendedModel", "task", "envVarMap", "detectedProvider", "uuidv4", "createBasePrompt", "createPersonalityPrompt", "agent", "basePrompt", "personalityInstructions", "tone", "examples", "personalitySection", "example", "index", "createSegmentPrompt", "segment", "segmentIndex", "totalSegments", "personalityPrompt", "segmentPrompt", "figureCount", "tableCount", "formulaCount", "block", "figure", "table", "formula", "estimatedMinutes", "applyPersonalityModifications", "scriptText", "agent", "modifiedText", "hasHumorMarkers", "logger", "removeContractions", "addContractions", "hasEnthusiasticMarkers", "text", "pattern", "contractions", "result", "contraction", "expansion", "regex", "match", "expansions", "calculateDuration", "text", "wordsPerMinute", "durationSeconds", "countWords", "word", "assignTimingToBlocks", "scriptBlocks", "block", "calculateTotalDuration", "segments", "totalDuration", "segment", "buildScriptSystemPrompt", "agent", "basePrompt", "mockScriptGenerationLLM", "_prompt", "logger", "resolve", "callScriptGenerationLLM", "prompt", "correlationId", "config", "startTime", "requestId", "uuidv4", "model", "getRecommendedModel", "llmService", "systemPrompt", "response", "duration", "recordLLMCallMetrics", "error", "generateScriptForSegment", "segmentIndex", "totalSegments", "createSegmentPrompt", "scriptText", "modifiedScript", "applyPersonalityModifications", "p", "paragraph", "index", "contentReference", "contentBlockIndex", "contentBlock", "blocksWithTiming", "generateScript", "jobId", "agentId", "getContent", "updateContent", "getAgent", "updateJob", "contentRecord", "segmentedContent", "getJob", "job", "scriptSegments", "i", "segmentCorrelationId", "scriptSegment", "lectureScript", "init_dynamodb", "import_aws_sdk", "init_config", "init_logger", "eventBridge", "config", "publishPipelineEvent", "detailType", "detail", "eventBusName", "logger", "params", "result", "errors", "e", "error", "triggerAudioSynthesis", "jobId", "publishPipelineEvent", "init_logger", "init_config", "scriptHandler", "event", "logger", "jobId", "agentId", "job", "getJob", "updateJob", "stage", "lectureScript", "generateScript", "config", "triggerAudioSynthesis", "error", "errorResponse", "updateError"]
}
