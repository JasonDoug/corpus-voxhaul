"use strict";var At=Object.create;var K=Object.defineProperty;var Lt=Object.getOwnPropertyDescriptor;var Nt=Object.getOwnPropertyNames;var Ot=Object.getPrototypeOf,Dt=Object.prototype.hasOwnProperty;var h=(e,t)=>()=>(e&&(t=e(e=0)),t);var xe=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),J=(e,t)=>{for(var r in t)K(e,r,{get:t[r],enumerable:!0})},Re=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Nt(t))!Dt.call(e,n)&&n!==r&&K(e,n,{get:()=>t[n],enumerable:!(o=Lt(t,n))||o.enumerable});return e};var Z=(e,t,r)=>(r=e!=null?At(Ot(e)):{},Re(t||!e||!e.__esModule?K(r,"default",{value:e,enumerable:!0}):r,e)),ee=e=>Re(K({},"__esModule",{value:!0}),e);var Ct,te,a,x=h(()=>{"use strict";Ct=[/password/i,/secret/i,/token/i,/apikey/i,/api[_-]?key/i,/authorization/i,/auth/i,/credential/i,/private[_-]?key/i,/access[_-]?key/i],te=class e{correlationId;serviceName;functionName;minLogLevel;constructor(){let t=process.env.LOG_LEVEL?.toUpperCase();this.minLogLevel=t||"INFO"}setCorrelationId(t){this.correlationId=t}getCorrelationId(){return this.correlationId}setServiceName(t){this.serviceName=t}setFunctionName(t){this.functionName=t}redactSensitiveData(t){if(t==null||typeof t=="string")return t;if(Array.isArray(t))return t.map(r=>this.redactSensitiveData(r));if(typeof t=="object"){let r={};for(let[o,n]of Object.entries(t))Ct.some(i=>i.test(o))?r[o]="[REDACTED]":typeof n=="object"&&n!==null?r[o]=this.redactSensitiveData(n):r[o]=n;return r}return t}shouldLog(t){let r=["ERROR","WARN","INFO","DEBUG"],o=r.indexOf(t),n=r.indexOf(this.minLogLevel);return o<=n}log(t,r,o){if(!this.shouldLog(t))return;let n={level:t,message:r,timestamp:new Date().toISOString(),correlationId:this.correlationId,service:this.serviceName,function:this.functionName,metadata:o?this.redactSensitiveData(o):void 0};console.log(JSON.stringify(n))}error(t,r){this.log("ERROR",t,r)}warn(t,r){this.log("WARN",t,r)}info(t,r){this.log("INFO",t,r)}debug(t,r){this.log("DEBUG",t,r)}child(t){let r=new e;return r.setCorrelationId(t),r.setServiceName(this.serviceName||""),r.setFunctionName(this.functionName||""),r}},a=new te});var Se=xe((qr,_t)=>{_t.exports={name:"dotenv",version:"16.6.1",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=text --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},homepage:"https://github.com/motdotla/dotenv#readme",funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var De=xe((Kr,S)=>{var re=require("fs"),Y=require("path"),Pt=require("os"),kt=require("crypto"),Mt=Se(),ne=Mt.version,$t=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Ut(e){let t={},r=e.toString();r=r.replace(/\r\n?/mg,`
`);let o;for(;(o=$t.exec(r))!=null;){let n=o[1],s=o[2]||"";s=s.trim();let i=s[0];s=s.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),i==='"'&&(s=s.replace(/\\n/g,`
`),s=s.replace(/\\r/g,"\r")),t[n]=s}return t}function Ft(e){e=e||{};let t=Oe(e);e.path=t;let r=E.configDotenv(e);if(!r.parsed){let i=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw i.code="MISSING_DATA",i}let o=Ne(e).split(","),n=o.length,s;for(let i=0;i<n;i++)try{let c=o[i].trim(),m=jt(r,c);s=E.decrypt(m.ciphertext,m.key);break}catch(c){if(i+1>=n)throw c}return E.parse(s)}function Vt(e){console.log(`[dotenv@${ne}][WARN] ${e}`)}function P(e){console.log(`[dotenv@${ne}][DEBUG] ${e}`)}function Le(e){console.log(`[dotenv@${ne}] ${e}`)}function Ne(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function jt(e,t){let r;try{r=new URL(t)}catch(c){if(c.code==="ERR_INVALID_URL"){let m=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw m.code="INVALID_DOTENV_KEY",m}throw c}let o=r.password;if(!o){let c=new Error("INVALID_DOTENV_KEY: Missing key part");throw c.code="INVALID_DOTENV_KEY",c}let n=r.searchParams.get("environment");if(!n){let c=new Error("INVALID_DOTENV_KEY: Missing environment part");throw c.code="INVALID_DOTENV_KEY",c}let s=`DOTENV_VAULT_${n.toUpperCase()}`,i=e.parsed[s];if(!i){let c=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${s} in your .env.vault file.`);throw c.code="NOT_FOUND_DOTENV_ENVIRONMENT",c}return{ciphertext:i,key:o}}function Oe(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let r of e.path)re.existsSync(r)&&(t=r.endsWith(".vault")?r:`${r}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=Y.resolve(process.cwd(),".env.vault");return re.existsSync(t)?t:null}function Ae(e){return e[0]==="~"?Y.join(Pt.homedir(),e.slice(1)):e}function qt(e){let t=!!(e&&e.debug),r=e&&"quiet"in e?e.quiet:!0;(t||!r)&&Le("Loading env from encrypted .env.vault");let o=E._parseVault(e),n=process.env;return e&&e.processEnv!=null&&(n=e.processEnv),E.populate(n,o,e),{parsed:o}}function Kt(e){let t=Y.resolve(process.cwd(),".env"),r="utf8",o=!!(e&&e.debug),n=e&&"quiet"in e?e.quiet:!0;e&&e.encoding?r=e.encoding:o&&P("No encoding is specified. UTF-8 is used by default");let s=[t];if(e&&e.path)if(!Array.isArray(e.path))s=[Ae(e.path)];else{s=[];for(let l of e.path)s.push(Ae(l))}let i,c={};for(let l of s)try{let u=E.parse(re.readFileSync(l,{encoding:r}));E.populate(c,u,e)}catch(u){o&&P(`Failed to load ${l} ${u.message}`),i=u}let m=process.env;if(e&&e.processEnv!=null&&(m=e.processEnv),E.populate(m,c,e),o||!n){let l=Object.keys(c).length,u=[];for(let f of s)try{let p=Y.relative(process.cwd(),f);u.push(p)}catch(p){o&&P(`Failed to load ${f} ${p.message}`),i=p}Le(`injecting env (${l}) from ${u.join(",")}`)}return i?{parsed:c,error:i}:{parsed:c}}function Jt(e){if(Ne(e).length===0)return E.configDotenv(e);let t=Oe(e);return t?E._configVault(e):(Vt(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),E.configDotenv(e))}function Yt(e,t){let r=Buffer.from(t.slice(-64),"hex"),o=Buffer.from(e,"base64"),n=o.subarray(0,12),s=o.subarray(-16);o=o.subarray(12,-16);try{let i=kt.createDecipheriv("aes-256-gcm",r,n);return i.setAuthTag(s),`${i.update(o)}${i.final()}`}catch(i){let c=i instanceof RangeError,m=i.message==="Invalid key length",l=i.message==="Unsupported state or unable to authenticate data";if(c||m){let u=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw u.code="INVALID_DOTENV_KEY",u}else if(l){let u=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw u.code="DECRYPTION_FAILED",u}else throw i}}function Bt(e,t,r={}){let o=!!(r&&r.debug),n=!!(r&&r.override);if(typeof t!="object"){let s=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw s.code="OBJECT_REQUIRED",s}for(let s of Object.keys(t))Object.prototype.hasOwnProperty.call(e,s)?(n===!0&&(e[s]=t[s]),o&&P(n===!0?`"${s}" is already defined and WAS overwritten`:`"${s}" is already defined and was NOT overwritten`)):e[s]=t[s]}var E={configDotenv:Kt,_configVault:qt,_parseVault:Ft,config:Jt,decrypt:Yt,parse:Ut,populate:Bt};S.exports.configDotenv=E.configDotenv;S.exports._configVault=E._configVault;S.exports._parseVault=E._parseVault;S.exports.config=E.config;S.exports.decrypt=E.decrypt;S.exports.parse=E.parse;S.exports.populate=E.populate;S.exports=E});var Ce,g,_=h(()=>{"use strict";Ce=Z(De());Ce.default.config();g={nodeEnv:process.env.NODE_ENV||"development",port:parseInt(process.env.PORT||"3000",10),localMode:process.env.LOCAL_MODE==="true",isLocal:process.env.NODE_ENV!=="production",awsRegion:process.env.AWS_REGION||"us-east-1",eventBusName:process.env.EVENT_BUS_NAME||"pdf-lecture-service-events",aws:{region:process.env.AWS_REGION||"us-east-1",accessKeyId:process.env.AWS_ACCESS_KEY_ID,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY},localstack:{endpoint:process.env.LOCALSTACK_ENDPOINT||"http://localhost:4566",useLocalStack:process.env.USE_LOCALSTACK==="true"},s3:{bucketName:process.env.S3_BUCKET_NAME||"pdf-lecture-service",pdfPrefix:process.env.S3_PDF_PREFIX||"pdfs",audioPrefix:process.env.S3_AUDIO_PREFIX||"audio",cachePrefix:process.env.S3_CACHE_PREFIX||"cache"},dynamodb:{jobsTable:process.env.DYNAMODB_TABLE_JOBS||"pdf-lecture-jobs",agentsTable:process.env.DYNAMODB_TABLE_AGENTS||"pdf-lecture-agents",contentTable:process.env.DYNAMODB_TABLE_CONTENT||"pdf-lecture-content"},processing:{maxPdfSizeMB:parseInt(process.env.MAX_PDF_SIZE_MB||"100",10),analysisTimeoutMs:parseInt(process.env.ANALYSIS_TIMEOUT_MS||"300000",10),audioSynthesisTimeoutMs:parseInt(process.env.AUDIO_SYNTHESIS_TIMEOUT_MS||"600000",10)},featureFlags:{enableRealSegmentation:process.env.ENABLE_REAL_SEGMENTATION==="true",enableRealScriptGeneration:process.env.ENABLE_REAL_SCRIPT_GENERATION==="true",enableImageExtraction:process.env.ENABLE_IMAGE_EXTRACTION==="true",enableVisionFirstPipeline:process.env.ENABLE_VISION_FIRST_PIPELINE==="true"},vision:{model:process.env.VISION_MODEL||"google/gemini-2.0-flash-exp:free",temperature:parseFloat(process.env.VISION_LLM_TEMPERATURE||"0.3"),maxTokens:parseInt(process.env.VISION_LLM_MAX_TOKENS||"4000",10)}}});var Pe={};J(Pe,{createAlarm:()=>B,createStandardAlarmsForFunction:()=>Qt,publishMetric:()=>Xt,publishMetrics:()=>zt});async function Xt(e){if(g.isLocal&&!g.localstack.useLocalStack){a.debug("Skipping CloudWatch metric in local mode",{metric:e});return}try{let t=e.dimensions?Object.entries(e.dimensions).map(([r,o])=>({Name:r,Value:o})):[];await se.putMetricData({Namespace:"PDFLectureService",MetricData:[{MetricName:e.name,Value:e.value,Unit:e.unit,Timestamp:e.timestamp||new Date,Dimensions:t}]}).promise(),a.debug("Metric published to CloudWatch",{metric:e})}catch(t){a.error("Failed to publish metric to CloudWatch",{metric:e,error:t instanceof Error?t.message:String(t)})}}async function zt(e){if(g.isLocal&&!g.localstack.useLocalStack){a.debug("Skipping CloudWatch metrics in local mode",{count:e.length});return}try{let t=e.map(o=>{let n=o.dimensions?Object.entries(o.dimensions).map(([s,i])=>({Name:s,Value:i})):[];return{MetricName:o.name,Value:o.value,Unit:o.unit,Timestamp:o.timestamp||new Date,Dimensions:n}}),r=20;for(let o=0;o<t.length;o+=r){let n=t.slice(o,o+r);await se.putMetricData({Namespace:"PDFLectureService",MetricData:n}).promise()}a.debug("Metrics published to CloudWatch",{count:e.length})}catch(t){a.error("Failed to publish metrics to CloudWatch",{count:e.length,error:t instanceof Error?t.message:String(t)})}}async function B(e){try{let t=e.dimensions?Object.entries(e.dimensions).map(([r,o])=>({Name:r,Value:o})):[];await se.putMetricAlarm({AlarmName:e.alarmName,MetricName:e.metricName,Namespace:"PDFLectureService",Statistic:e.statistic,Period:e.period,EvaluationPeriods:e.evaluationPeriods,Threshold:e.threshold,ComparisonOperator:e.comparisonOperator,Dimensions:t,TreatMissingData:"notBreaching"}).promise(),a.info("CloudWatch alarm created",{alarmName:e.alarmName})}catch(t){a.error("Failed to create CloudWatch alarm",{alarmName:e.alarmName,error:t instanceof Error?t.message:String(t)})}}async function Qt(e,t){await B({alarmName:`${e}-ErrorRate`,metricName:"Errors",threshold:5,comparisonOperator:"GreaterThanThreshold",evaluationPeriods:1,period:300,statistic:"Sum",dimensions:{FunctionName:e}}),await B({alarmName:`${e}-Timeout`,metricName:"Duration",threshold:t*.9,comparisonOperator:"GreaterThanThreshold",evaluationPeriods:1,period:300,statistic:"Maximum",dimensions:{FunctionName:e}}),await B({alarmName:`${e}-Throttles`,metricName:"Throttles",threshold:1,comparisonOperator:"GreaterThanThreshold",evaluationPeriods:1,period:300,statistic:"Sum",dimensions:{FunctionName:e}})}var _e,se,ke=h(()=>{"use strict";_e=Z(require("aws-sdk"));_();x();se=new _e.CloudWatch({region:g.aws.region,...g.localstack.useLocalStack&&{endpoint:g.localstack.endpoint}})});var Ue,Fe=h(()=>{Ue="ffffffff-ffff-ffff-ffff-ffffffffffff"});var Ve,je=h(()=>{Ve="00000000-0000-0000-0000-000000000000"});var qe,Ke=h(()=>{qe=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i});function tr(e){return typeof e=="string"&&qe.test(e)}var D,k=h(()=>{Ke();D=tr});function rr(e){if(!D(e))throw TypeError("Invalid UUID");let t;return Uint8Array.of((t=parseInt(e.slice(0,8),16))>>>24,t>>>16&255,t>>>8&255,t&255,(t=parseInt(e.slice(9,13),16))>>>8,t&255,(t=parseInt(e.slice(14,18),16))>>>8,t&255,(t=parseInt(e.slice(19,23),16))>>>8,t&255,(t=parseInt(e.slice(24,36),16))/1099511627776&255,t/4294967296&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255)}var A,M=h(()=>{k();A=rr});function v(e,t=0){return(b[e[t+0]]+b[e[t+1]]+b[e[t+2]]+b[e[t+3]]+"-"+b[e[t+4]]+b[e[t+5]]+"-"+b[e[t+6]]+b[e[t+7]]+"-"+b[e[t+8]]+b[e[t+9]]+"-"+b[e[t+10]]+b[e[t+11]]+b[e[t+12]]+b[e[t+13]]+b[e[t+14]]+b[e[t+15]]).toLowerCase()}function nr(e,t=0){let r=v(e,t);if(!D(r))throw TypeError("Stringified UUID is invalid");return r}var b,Je,L=h(()=>{k();b=[];for(let e=0;e<256;++e)b.push((e+256).toString(16).slice(1));Je=nr});function N(){return G>W.length-16&&((0,Ye.randomFillSync)(W),G=0),W.slice(G,G+=16)}var Ye,W,G,H=h(()=>{Ye=require("crypto"),W=new Uint8Array(256),G=W.length});function or(e,t,r){let o,n=e?._v6??!1;if(e){let s=Object.keys(e);s.length===1&&s[0]==="_v6"&&(e=void 0)}if(e)o=Be(e.random??e.rng?.()??N(),e.msecs,e.nsecs,e.clockseq,e.node,t,r);else{let s=Date.now(),i=N();sr($,s,i),o=Be(i,$.msecs,$.nsecs,n?void 0:$.clockseq,n?void 0:$.node,t,r)}return t??v(o)}function sr(e,t,r){return e.msecs??=-1/0,e.nsecs??=0,t===e.msecs?(e.nsecs++,e.nsecs>=1e4&&(e.node=void 0,e.nsecs=0)):t>e.msecs?e.nsecs=0:t<e.msecs&&(e.node=void 0),e.node||(e.node=r.slice(10,16),e.node[0]|=1,e.clockseq=(r[8]<<8|r[9])&16383),e.msecs=t,e}function Be(e,t,r,o,n,s,i=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(!s)s=new Uint8Array(16),i=0;else if(i<0||i+16>s.length)throw new RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);t??=Date.now(),r??=0,o??=(e[8]<<8|e[9])&16383,n??=e.slice(10,16),t+=122192928e5;let c=((t&268435455)*1e4+r)%4294967296;s[i++]=c>>>24&255,s[i++]=c>>>16&255,s[i++]=c>>>8&255,s[i++]=c&255;let m=t/4294967296*1e4&268435455;s[i++]=m>>>8&255,s[i++]=m&255,s[i++]=m>>>24&15|16,s[i++]=m>>>16&255,s[i++]=o>>>8|128,s[i++]=o&255;for(let l=0;l<6;++l)s[i++]=n[l];return s}var $,X,me=h(()=>{H();L();$={};X=or});function U(e){let t=typeof e=="string"?A(e):e,r=ir(t);return typeof e=="string"?v(r):r}function ir(e){return Uint8Array.of((e[6]&15)<<4|e[7]>>4&15,(e[7]&15)<<4|(e[4]&240)>>4,(e[4]&15)<<4|(e[5]&240)>>4,(e[5]&15)<<4|(e[0]&240)>>4,(e[0]&15)<<4|(e[1]&240)>>4,(e[1]&15)<<4|(e[2]&240)>>4,96|e[2]&15,e[3],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}var de=h(()=>{M();L()});function ar(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),(0,Ge.createHash)("md5").update(e).digest()}var Ge,We,He=h(()=>{Ge=require("crypto");We=ar});function cr(e){e=unescape(encodeURIComponent(e));let t=new Uint8Array(e.length);for(let r=0;r<e.length;++r)t[r]=e.charCodeAt(r);return t}function F(e,t,r,o,n,s){let i=typeof r=="string"?cr(r):r,c=typeof o=="string"?A(o):o;if(typeof o=="string"&&(o=A(o)),o?.length!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let m=new Uint8Array(16+i.length);if(m.set(c),m.set(i,c.length),m=t(m),m[6]=m[6]&15|e,m[8]=m[8]&63|128,n){s=s||0;for(let l=0;l<16;++l)n[s+l]=m[l];return n}return v(m)}var z,Q,ge=h(()=>{M();L();z="6ba7b810-9dad-11d1-80b4-00c04fd430c8",Q="6ba7b811-9dad-11d1-80b4-00c04fd430c8"});function fe(e,t,r,o){return F(48,We,e,t,r,o)}var Xe,ze=h(()=>{He();ge();fe.DNS=z;fe.URL=Q;Xe=fe});var Qe,he,Ze=h(()=>{Qe=require("crypto"),he={randomUUID:Qe.randomUUID}});function ur(e,t,r){e=e||{};let o=e.random??e.rng?.()??N();if(o.length<16)throw new Error("Random bytes length must be >= 16");if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){if(r=r||0,r<0||r+16>t.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let n=0;n<16;++n)t[r+n]=o[n];return t}return v(o)}function lr(e,t,r){return he.randomUUID&&!t&&!e?he.randomUUID():ur(e,t,r)}var et,tt=h(()=>{Ze();H();L();et=lr});function pr(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),(0,rt.createHash)("sha1").update(e).digest()}var rt,nt,ot=h(()=>{rt=require("crypto");nt=pr});function ye(e,t,r,o){return F(80,nt,e,t,r,o)}var st,it=h(()=>{ot();ge();ye.DNS=z;ye.URL=Q;st=ye});function mr(e,t,r){e??={},r??=0;let o=X({...e,_v6:!0},new Uint8Array(16));if(o=U(o),t){for(let n=0;n<16;n++)t[r+n]=o[n];return t}return v(o)}var at,ct=h(()=>{L();me();de();at=mr});function Ee(e){let t=typeof e=="string"?A(e):e,r=dr(t);return typeof e=="string"?v(r):r}function dr(e){return Uint8Array.of((e[3]&15)<<4|e[4]>>4&15,(e[4]&15)<<4|(e[5]&240)>>4,(e[5]&15)<<4|e[6]&15,e[7],(e[1]&15)<<4|(e[2]&240)>>4,(e[2]&15)<<4|(e[3]&240)>>4,16|(e[0]&240)>>4,(e[0]&15)<<4|(e[1]&240)>>4,e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}var ut=h(()=>{M();L()});function gr(e,t,r){let o;if(e)o=lt(e.random??e.rng?.()??N(),e.msecs,e.seq,t,r);else{let n=Date.now(),s=N();fr(be,n,s),o=lt(s,be.msecs,be.seq,t,r)}return t??v(o)}function fr(e,t,r){return e.msecs??=-1/0,e.seq??=0,t>e.msecs?(e.seq=r[6]<<23|r[7]<<16|r[8]<<8|r[9],e.msecs=t):(e.seq=e.seq+1|0,e.seq===0&&e.msecs++),e}function lt(e,t,r,o,n=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(!o)o=new Uint8Array(16),n=0;else if(n<0||n+16>o.length)throw new RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);return t??=Date.now(),r??=e[6]*127<<24|e[7]<<16|e[8]<<8|e[9],o[n++]=t/1099511627776&255,o[n++]=t/4294967296&255,o[n++]=t/16777216&255,o[n++]=t/65536&255,o[n++]=t/256&255,o[n++]=t&255,o[n++]=112|r>>>28&15,o[n++]=r>>>20&255,o[n++]=128|r>>>14&63,o[n++]=r>>>6&255,o[n++]=r<<2&255|e[10]&3,o[n++]=e[11],o[n++]=e[12],o[n++]=e[13],o[n++]=e[14],o[n++]=e[15],o}var be,pt,mt=h(()=>{H();L();be={};pt=gr});function hr(e){if(!D(e))throw TypeError("Invalid UUID");return parseInt(e.slice(14,15),16)}var dt,gt=h(()=>{k();dt=hr});var ft={};J(ft,{MAX:()=>Ue,NIL:()=>Ve,parse:()=>A,stringify:()=>Je,v1:()=>X,v1ToV6:()=>U,v3:()=>Xe,v4:()=>et,v5:()=>st,v6:()=>at,v6ToV1:()=>Ee,v7:()=>pt,validate:()=>D,version:()=>dt});var ht=h(()=>{Fe();je();M();L();me();de();ze();tt();it();ct();ut();mt();k();gt()});var It={};J(It,{createAgent:()=>vr,createContent:()=>Ir,createJob:()=>yr,createTablesIfNotExist:()=>Sr,deleteAgent:()=>Tr,deleteContent:()=>Rr,deleteJob:()=>Er,getAgent:()=>wt,getContent:()=>Tt,getJob:()=>j,listAgents:()=>we,listJobs:()=>br,updateAgent:()=>wr,updateContent:()=>xr,updateJob:()=>q});function T(e,t){throw a.error(`DynamoDB ${t} failed`,{error:e.message}),new Error(`Database operation failed: ${t}`)}function yt(e){return{...e,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}}function Et(e){return{...e,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),stages:e.stages.map(t=>({...t,startedAt:t.startedAt?new Date(t.startedAt):void 0,completedAt:t.completedAt?new Date(t.completedAt):void 0}))}}async function yr(e){try{let t=yt(e);return await w.put({TableName:g.dynamodb.jobsTable,Item:t}).promise(),a.info("Job created",{jobId:e.jobId}),e}catch(t){T(t,"createJob")}}async function j(e){try{let t=await w.get({TableName:g.dynamodb.jobsTable,Key:{jobId:e}}).promise();return t.Item?Et(t.Item):null}catch(t){T(t,"getJob")}}async function q(e,t){try{let r=await j(e);if(!r)throw new Error(`Job not found: ${e}`);let o={...r,...t,jobId:e,updatedAt:new Date},n=yt(o);return await w.put({TableName:g.dynamodb.jobsTable,Item:n}).promise(),a.info("Job updated",{jobId:e}),o}catch(r){if(r instanceof Error&&r.message.includes("not found"))throw r;T(r,"updateJob")}}async function Er(e){try{await w.delete({TableName:g.dynamodb.jobsTable,Key:{jobId:e}}).promise(),a.info("Job deleted",{jobId:e})}catch(t){T(t,"deleteJob")}}async function br(){try{return((await w.scan({TableName:g.dynamodb.jobsTable}).promise()).Items||[]).map(t=>Et(t))}catch(e){T(e,"listJobs")}}function bt(e){return{...e,createdAt:e.createdAt.toISOString()}}function vt(e){return{...e,personality:{...e.personality,tone:e.personality.tone},createdAt:new Date(e.createdAt)}}async function vr(e){try{if((await we()).some(o=>o.name===e.name&&o.id!==e.id))throw new Error(`Agent with name "${e.name}" already exists`);let r=bt(e);return await w.put({TableName:g.dynamodb.agentsTable,Item:r}).promise(),a.info("Agent created",{agentId:e.id,name:e.name}),e}catch(t){if(t instanceof Error&&t.message.includes("already exists"))throw t;T(t,"createAgent")}}async function wt(e){try{let t=await w.get({TableName:g.dynamodb.agentsTable,Key:{id:e}}).promise();return t.Item?vt(t.Item):null}catch(t){T(t,"getAgent")}}async function wr(e,t){try{let r=await wt(e);if(!r)throw new Error(`Agent not found: ${e}`);if(t.name&&t.name!==r.name&&(await we()).some(i=>i.name===t.name&&i.id!==e))throw new Error(`Agent with name "${t.name}" already exists`);let o={...r,...t,id:e,personality:t.personality?{...r.personality,...t.personality}:r.personality,voice:t.voice?{...r.voice,...t.voice}:r.voice},n=bt(o);return await w.put({TableName:g.dynamodb.agentsTable,Item:n}).promise(),a.info("Agent updated",{agentId:e}),o}catch(r){if(r instanceof Error&&(r.message.includes("already exists")||r.message.includes("not found")))throw r;T(r,"updateAgent")}}async function Tr(e){try{await w.delete({TableName:g.dynamodb.agentsTable,Key:{id:e}}).promise(),a.info("Agent deleted",{agentId:e})}catch(t){T(t,"deleteAgent")}}async function we(){try{return((await w.scan({TableName:g.dynamodb.agentsTable}).promise()).Items||[]).map(t=>vt(t))}catch(e){T(e,"listAgents")}}async function Ir(e){try{let t={jobId:e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await w.put({TableName:g.dynamodb.contentTable,Item:t}).promise(),a.info("Content record created",{jobId:e}),t}catch(t){T(t,"createContent")}}async function Tt(e){try{let t=await w.get({TableName:g.dynamodb.contentTable,Key:{jobId:e}}).promise();return t.Item?t.Item:null}catch(t){T(t,"getContent")}}async function xr(e,t){try{let r=await Tt(e);if(!r)throw new Error(`Content not found for job: ${e}`);let o={...r,...t,jobId:e,updatedAt:new Date().toISOString()};return await w.put({TableName:g.dynamodb.contentTable,Item:o}).promise(),a.info("Content updated",{jobId:e}),o}catch(r){if(r instanceof Error&&r.message.includes("not found"))throw r;T(r,"updateContent")}}async function Rr(e){try{await w.delete({TableName:g.dynamodb.contentTable,Key:{jobId:e}}).promise(),a.info("Content deleted",{jobId:e})}catch(t){T(t,"deleteContent")}}async function Sr(){if(!g.localstack.useLocalStack){a.info("Skipping table creation in production mode");return}let e=new ve.default.DynamoDB(V),t=[{TableName:g.dynamodb.jobsTable,KeySchema:[{AttributeName:"jobId",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:"jobId",AttributeType:"S"}]},{TableName:g.dynamodb.agentsTable,KeySchema:[{AttributeName:"id",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:"id",AttributeType:"S"}]},{TableName:g.dynamodb.contentTable,KeySchema:[{AttributeName:"jobId",KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:"jobId",AttributeType:"S"}]}];for(let r of t)try{await e.describeTable({TableName:r.TableName}).promise(),a.info(`Table ${r.TableName} already exists`)}catch(o){if(o.code==="ResourceNotFoundException")try{await e.createTable({...r,BillingMode:"PAY_PER_REQUEST"}).promise(),a.info(`Table ${r.TableName} created`)}catch(n){a.error(`Failed to create table ${r.TableName}`,{error:n})}}}var ve,V,w,Te=h(()=>{"use strict";ve=Z(require("aws-sdk"));_();x();V={region:g.aws.region};g.localstack.useLocalStack&&(V.endpoint=g.localstack.endpoint,V.accessKeyId="test",V.secretAccessKey="test");w=new ve.default.DynamoDB.DocumentClient(V)});var Fr={};J(Fr,{segmenterHandler:()=>Ur});module.exports=ee(Fr);x();_();x();x();var Gt={maxAttempts:3,initialDelayMs:1e3,maxDelayMs:1e4,backoffMultiplier:2,retryableErrors:["ECONNRESET","ETIMEDOUT","ENOTFOUND","ECONNREFUSED"]};function Wt(e){return new Promise(t=>setTimeout(t,e))}function Ht(e,t){if(!e)return!1;if(typeof e.retryable=="boolean")return e.retryable;if(e.name&&t.includes(e.name)||e.code&&t.includes(e.code))return!0;let r=e.message?.toLowerCase()||"";return r.includes("timeout")||r.includes("connection")||r.includes("network")||r.includes("temporary")||r.includes("rate limit")||r.includes("429")||r.includes("too many requests")}async function oe(e,t={}){let r={...Gt,...t},o,n=r.initialDelayMs;for(let s=1;s<=r.maxAttempts;s++)try{let i=await e();return s>1&&a.info("Operation succeeded after retry",{attempt:s}),i}catch(i){o=i;let c=Ht(i,r.retryableErrors),m=s===r.maxAttempts;if(a.warn("Operation failed",{attempt:s,maxAttempts:r.maxAttempts,isRetryable:c,error:i instanceof Error?i.message:String(i)}),!c||m)throw i;a.info("Retrying operation",{attempt:s,delayMs:n}),await Wt(n),n=Math.min(n*r.backoffMultiplier,r.maxDelayMs)}throw o}x();x();var ie=class{metrics=[];activeTimers=new Map;recordCount(t,r=1,o){this.recordMetric(t,r,"Count",o)}recordDuration(t,r,o){this.recordMetric(t,r,"Milliseconds",o)}recordSize(t,r,o){this.recordMetric(t,r,"Bytes",o)}recordRate(t,r,o){this.recordMetric(t,r,"Percent",o)}startTimer(t,r){let o=`${t}-${Date.now()}-${Math.random()}`;return this.activeTimers.set(o,{name:t,startTime:Date.now(),dimensions:r}),o}stopTimer(t){let r=this.activeTimers.get(t);if(!r)return a.warn("Attempted to stop non-existent timer",{timerId:t}),null;let o=Date.now()-r.startTime;return this.recordDuration(r.name,o,r.dimensions),this.activeTimers.delete(t),o}recordMetric(t,r,o,n){let s={name:t,value:r,unit:o,timestamp:new Date,dimensions:n};this.metrics.push(s),a.info("Metric recorded",{metric:{name:s.name,value:s.value,unit:s.unit,dimensions:s.dimensions}}),process.env.NODE_ENV==="production"&&this.publishToCloudWatch(s)}async publishToCloudWatch(t){let{publishMetric:r}=await Promise.resolve().then(()=>(ke(),Pe));await r({name:t.name,value:t.value,unit:t.unit,dimensions:t.dimensions,timestamp:t.timestamp})}getMetrics(){return[...this.metrics]}clearMetrics(){this.metrics=[]}},O=new ie;var Me={"gpt-4-turbo-preview":{input:10,output:30},"gpt-4-vision-preview":{input:10,output:30},"gpt-3.5-turbo":{input:.5,output:1.5},"claude-3-opus-20240229":{input:15,output:75},"claude-3-sonnet-20240229":{input:3,output:15},"claude-3-haiku-20240307":{input:.25,output:1.25},"openai/gpt-4-turbo-preview":{input:10,output:30},"openai/gpt-4-vision-preview":{input:10,output:30},"openai/gpt-3.5-turbo":{input:.5,output:1.5},"anthropic/claude-3-opus":{input:15,output:75},"anthropic/claude-3-sonnet":{input:3,output:15},"anthropic/claude-3-5-sonnet":{input:3,output:15},"anthropic/claude-3-haiku":{input:.25,output:1.25},"google/gemini-2.0-flash-exp:free":{input:0,output:0},"google/gemini-pro-vision":{input:0,output:0},"x-ai/grok-4.1-fast:free":{input:0,output:0},"meta-llama/llama-3.3-70b-instruct:free":{input:0,output:0},"meta-llama/llama-3.1-405b-instruct:free":{input:0,output:0},"qwen/qwen-2.5-72b-instruct:free":{input:0,output:0},"mistralai/mistral-7b-instruct:free":{input:0,output:0},default:{input:5,output:15}};function Zt(e,t,r){let o=Me[e]||Me.default,n=t/1e6*o.input,s=r/1e6*o.output;return n+s}function I(e){let t={operation:e.operation,model:e.model,provider:e.provider,success:e.success.toString()};e.success?O.recordCount("LLMCallSuccess",1,t):O.recordCount("LLMCallFailure",1,{...t,errorType:e.errorType||"Unknown"}),O.recordDuration("LLMCallDuration",e.durationMs,t),O.recordCount("LLMPromptTokens",e.promptTokens,t),O.recordCount("LLMCompletionTokens",e.completionTokens,t),O.recordCount("LLMTotalTokens",e.totalTokens,t);let r=Zt(e.model,e.promptTokens,e.completionTokens);O.recordCount("LLMCallCostCents",Math.round(r*100),t),a.info("LLM call metrics recorded",{...e,estimatedCost:r,costFormatted:`$${r.toFixed(4)}`})}var ae=class extends Error{retryable=!0;retryAfter;constructor(t,r){super(t),this.name="RateLimitError",this.retryAfter=r}},ce=class{apiKey;baseUrl="https://openrouter.ai/api/v1";appName="PDF Lecture Service";lastRequestTime=0;minRequestInterval;constructor(t){this.apiKey=t,this.minRequestInterval=parseInt(process.env.OPENROUTER_MIN_REQUEST_INTERVAL_MS||"500",10)}async rateLimit(){let r=Date.now()-this.lastRequestTime;if(r<this.minRequestInterval){let o=this.minRequestInterval-r;a.debug("Rate limiting OpenRouter request",{waitTime:o}),await new Promise(n=>setTimeout(n,o))}this.lastRequestTime=Date.now()}parseErrorResponse(t,r){try{let o=JSON.parse(r);if(t===429||o.error?.code===429){let n=o.error?.message||"Rate limit exceeded",s=o.error?.metadata?.headers?.["X-RateLimit-Reset"];return a.warn("OpenRouter rate limit hit",{message:n,retryAfter:s,remaining:o.error?.metadata?.headers?.["X-RateLimit-Remaining"]}),new ae(n,s)}return new Error(`OpenRouter API error: ${t} - ${o.error?.message||r}`)}catch{return new Error(`OpenRouter API error: ${t} - ${r}`)}}async chat(t){let r=t.model||"openai/gpt-4-turbo-preview",o=Date.now();a.info("OpenRouter chat request",{model:r,messageCount:t.messages.length});try{await this.rateLimit();let n=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","HTTP-Referer":"https://github.com/pdf-lecture-service","X-Title":this.appName},body:JSON.stringify({model:r,messages:t.messages,temperature:t.temperature??.7,max_tokens:t.maxTokens??4096,stream:t.stream??!1})});if(!n.ok){let l=await n.text();throw a.error("OpenRouter API error",{status:n.status,error:l}),this.parseErrorResponse(n.status,l)}let s=await n.json(),i=Date.now()-o,c={limit:n.headers.get("X-RateLimit-Limit"),remaining:n.headers.get("X-RateLimit-Remaining"),reset:n.headers.get("X-RateLimit-Reset")};c.remaining&&a.debug("OpenRouter rate limit status",c);let m={content:s.choices[0].message.content,model:s.model,usage:{promptTokens:s.usage?.prompt_tokens||0,completionTokens:s.usage?.completion_tokens||0,totalTokens:s.usage?.total_tokens||0}};return I({operation:"chat",model:s.model,provider:"openrouter",promptTokens:m.usage.promptTokens,completionTokens:m.usage.completionTokens,totalTokens:m.usage.totalTokens,durationMs:i,success:!0}),m}catch(n){let s=Date.now()-o;throw I({operation:"chat",model:r,provider:"openrouter",promptTokens:0,completionTokens:0,totalTokens:0,durationMs:s,success:!1,errorType:n instanceof Error?n.message:"Unknown error"}),n}}async vision(t){let r=t.model||"openai/gpt-4-vision-preview",o=Date.now();a.info("OpenRouter vision request",{model:r});try{await this.rateLimit();let n=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","HTTP-Referer":"https://github.com/pdf-lecture-service","X-Title":this.appName},body:JSON.stringify({model:r,messages:[{role:"user",content:[{type:"text",text:t.prompt},{type:"image_url",image_url:{url:t.imageUrl}}]}],max_tokens:1024})});if(!n.ok){let m=await n.text();throw a.error("OpenRouter vision API error",{status:n.status,error:m}),this.parseErrorResponse(n.status,m)}let s=await n.json(),i=Date.now()-o,c={limit:n.headers.get("X-RateLimit-Limit"),remaining:n.headers.get("X-RateLimit-Remaining"),reset:n.headers.get("X-RateLimit-Reset")};return c.remaining&&a.debug("OpenRouter rate limit status",c),I({operation:"vision",model:s.model,provider:"openrouter",promptTokens:s.usage?.prompt_tokens||0,completionTokens:s.usage?.completion_tokens||0,totalTokens:s.usage?.total_tokens||0,durationMs:i,success:!0}),s.choices[0].message.content}catch(n){let s=Date.now()-o;throw I({operation:"vision",model:r,provider:"openrouter",promptTokens:0,completionTokens:0,totalTokens:0,durationMs:s,success:!1,errorType:n instanceof Error?n.message:"Unknown error"}),n}}},ue=class{apiKey;baseUrl="https://api.openai.com/v1";constructor(t){this.apiKey=t}async chat(t){let r=t.model||"gpt-4-turbo-preview",o=Date.now();a.info("OpenAI chat request",{model:r,messageCount:t.messages.length});try{let n=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:t.messages,temperature:t.temperature??.7,max_tokens:t.maxTokens??4096})});if(!n.ok){let m=await n.text();throw a.error("OpenAI API error",{status:n.status,error:m}),new Error(`OpenAI API error: ${n.status} - ${m}`)}let s=await n.json(),i=Date.now()-o,c={content:s.choices[0].message.content,model:s.model,usage:{promptTokens:s.usage.prompt_tokens,completionTokens:s.usage.completion_tokens,totalTokens:s.usage.total_tokens}};return I({operation:"chat",model:s.model,provider:"openai",promptTokens:c.usage.promptTokens,completionTokens:c.usage.completionTokens,totalTokens:c.usage.totalTokens,durationMs:i,success:!0}),c}catch(n){let s=Date.now()-o;throw I({operation:"chat",model:r,provider:"openai",promptTokens:0,completionTokens:0,totalTokens:0,durationMs:s,success:!1,errorType:n instanceof Error?n.message:"Unknown error"}),n}}async vision(t){let r=t.model||"gpt-4-vision-preview";a.info("OpenAI vision request",{model:r});let o=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:[{role:"user",content:[{type:"text",text:t.prompt},{type:"image_url",image_url:{url:t.imageUrl}}]}],max_tokens:1024})});if(!o.ok){let s=await o.text();throw a.error("OpenAI vision API error",{status:o.status,error:s}),new Error(`OpenAI vision API error: ${o.status} - ${s}`)}return(await o.json()).choices[0].message.content}},le=class{apiKey;baseUrl="https://api.anthropic.com/v1";constructor(t){this.apiKey=t}async chat(t){let r=t.model||"claude-3-opus-20240229",o=Date.now();a.info("Anthropic chat request",{model:r,messageCount:t.messages.length});try{let n=t.messages.find(u=>u.role==="system"),s=t.messages.filter(u=>u.role!=="system").map(u=>({role:u.role==="assistant"?"assistant":"user",content:u.content})),i=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"x-api-key":this.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify({model:r,messages:s,system:n?.content,temperature:t.temperature??.7,max_tokens:t.maxTokens??4096})});if(!i.ok){let u=await i.text();throw a.error("Anthropic API error",{status:i.status,error:u}),new Error(`Anthropic API error: ${i.status} - ${u}`)}let c=await i.json(),m=Date.now()-o,l={content:c.content[0].text,model:c.model,usage:{promptTokens:c.usage.input_tokens,completionTokens:c.usage.output_tokens,totalTokens:c.usage.input_tokens+c.usage.output_tokens}};return I({operation:"chat",model:c.model,provider:"anthropic",promptTokens:l.usage.promptTokens,completionTokens:l.usage.completionTokens,totalTokens:l.usage.totalTokens,durationMs:m,success:!0}),l}catch(n){let s=Date.now()-o;throw I({operation:"chat",model:r,provider:"anthropic",promptTokens:0,completionTokens:0,totalTokens:0,durationMs:s,success:!1,errorType:n instanceof Error?n.message:"Unknown error"}),n}}async vision(t){let r=t.model||"claude-3-opus-20240229";a.info("Anthropic vision request",{model:r});let o=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"x-api-key":this.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify({model:r,messages:[{role:"user",content:[{type:"image",source:{type:"url",url:t.imageUrl}},{type:"text",text:t.prompt}]}],max_tokens:1024})});if(!o.ok){let s=await o.text();throw a.error("Anthropic vision API error",{status:o.status,error:s}),new Error(`Anthropic vision API error: ${o.status} - ${s}`)}return(await o.json()).content[0].text}},pe=class{provider;client;constructor(t){this.provider=t||this.detectProvider(),this.client=this.createClient(),a.info("LLM Service initialized",{provider:this.provider})}detectProvider(){return process.env.OPENROUTER_API_KEY?"openrouter":process.env.OPENAI_API_KEY?"openai":process.env.ANTHROPIC_API_KEY?"anthropic":"openrouter"}createClient(){switch(this.provider){case"openrouter":let t=process.env.OPENROUTER_API_KEY||process.env.OPENAI_API_KEY;if(!t)throw new Error("OPENROUTER_API_KEY or OPENAI_API_KEY not set");return new ce(t);case"openai":let r=process.env.OPENAI_API_KEY;if(!r)throw new Error("OPENAI_API_KEY not set");return new ue(r);case"anthropic":let o=process.env.ANTHROPIC_API_KEY;if(!o)throw new Error("ANTHROPIC_API_KEY not set");return new le(o);default:throw new Error(`Unknown provider: ${this.provider}`)}}async chat(t){let r=parseInt(process.env.LLM_MAX_RETRY_ATTEMPTS||"5",10),o=parseInt(process.env.LLM_INITIAL_RETRY_DELAY_MS||"2000",10),n=parseInt(process.env.LLM_MAX_RETRY_DELAY_MS||"30000",10);return oe(async()=>this.client.chat(t),{maxAttempts:r,initialDelayMs:o,maxDelayMs:n,backoffMultiplier:2,retryableErrors:["ECONNRESET","ETIMEDOUT","ENOTFOUND","ECONNREFUSED","RateLimitError"]})}async vision(t){let r=parseInt(process.env.LLM_VISION_MAX_RETRY_ATTEMPTS||"5",10),o=parseInt(process.env.LLM_VISION_INITIAL_RETRY_DELAY_MS||"3000",10),n=parseInt(process.env.LLM_VISION_MAX_RETRY_DELAY_MS||"60000",10);return oe(async()=>this.client.vision(t),{maxAttempts:r,initialDelayMs:o,maxDelayMs:n,backoffMultiplier:2,retryableErrors:["ECONNRESET","ETIMEDOUT","ENOTFOUND","ECONNREFUSED","RateLimitError"]})}getProvider(){return this.provider}},C=new pe,er={analysis:{openrouter:"openai/gpt-4-turbo-preview",openai:"gpt-4-turbo-preview",anthropic:"claude-3-opus-20240229"},vision:{openrouter:"openai/gpt-4-vision-preview",openai:"gpt-4-vision-preview",anthropic:"claude-3-opus-20240229"},segmentation:{openrouter:"anthropic/claude-3-opus",openai:"gpt-4-turbo-preview",anthropic:"claude-3-opus-20240229"},script:{openrouter:"openai/gpt-4-turbo-preview",openai:"gpt-4-turbo-preview",anthropic:"claude-3-opus-20240229"},fast:{openrouter:"openai/gpt-3.5-turbo",openai:"gpt-3.5-turbo",anthropic:"claude-3-haiku-20240307"}};function $e(e,t){let r={analysis:process.env.LLM_MODEL_ANALYSIS||"",vision:process.env.LLM_MODEL_VISION||"",segmentation:process.env.LLM_MODEL_SEGMENTATION||"",script:process.env.LLM_MODEL_SCRIPT||"",fast:process.env.LLM_MODEL_FAST||""};if(r[e])return r[e];let o=t||(process.env.OPENROUTER_API_KEY?"openrouter":"openai");return er[e][o]}var{v4:Ie}=(ht(),ee(ft));function Ar(e){return`You are an expert at analyzing scientific documents and organizing them into logical learning segments.

I will provide you with the extracted content from a scientific PDF, including text, figures, tables, formulas, and citations.

Your task is to:
1. Identify distinct topics and concepts in the content
2. Group related concepts together into coherent segments
3. Create a logical narrative flow where concepts build upon each other
4. Identify prerequisite relationships (which concepts must be understood before others)
5. Provide a clear title for each segment

Content to analyze:
${Lr(e)}

Please respond with a JSON object in the following format:
{
  "segments": [
    {
      "title": "Clear, descriptive title for the segment",
      "contentIndices": {
        "pageRanges": [[startPage, endPage], ...],
        "figureIds": ["id1", "id2", ...],
        "tableIds": ["id1", "id2", ...],
        "formulaIds": ["id1", "id2", ...],
        "citationIds": ["id1", "id2", ...]
      },
      "prerequisites": [0, 1, ...] // Indices of segments that should come before this one
    },
    ...
  ]
}

Guidelines:
- Create as many segments as needed to organize the content into logical, cohesive topics
- Each segment should represent a distinct concept or theme that can be understood as a unit
- Segments should flow logically from foundational to advanced concepts
- Prerequisites should only reference earlier segments (lower indices)
- Include all relevant figures, tables, formulas for each segment
- Ensure all content is assigned to at least one segment
- Aim for segments that are substantial enough to be meaningful but focused enough to be digestible

Respond ONLY with the JSON object, no additional text.`}function Lr(e){let t=[];t.push("=== DOCUMENT OVERVIEW ==="),t.push(`Total Pages: ${e.pages.length}`),t.push(`Figures: ${e.figures.length}`),t.push(`Tables: ${e.tables.length}`),t.push(`Formulas: ${e.formulas.length}`),t.push(`Citations: ${e.citations.length}`);let r=e.figures.length+e.tables.length+e.formulas.length,o=r>15?"High":r>8?"Medium":"Low";if(t.push(`Estimated Complexity: ${o}`),e.figures.length>0&&(t.push(`
=== FIGURE INVENTORY ===`),e.figures.forEach(n=>{let s=n.caption||"No caption";t.push(`- Figure ${n.id} (Page ${n.pageNumber}): ${s}`)})),e.tables.length>0&&(t.push(`
=== TABLE INVENTORY ===`),e.tables.forEach(n=>{let s=n.headers.length>0?n.headers.slice(0,3).join(", ")+(n.headers.length>3?"...":""):"No headers";t.push(`- Table ${n.id} (Page ${n.pageNumber}): ${s} (${n.rows.length} rows)`)})),e.formulas.length>0&&(t.push(`
=== FORMULA INVENTORY ===`),e.formulas.forEach(n=>{let s=n.latex.length>50?n.latex.substring(0,50)+"...":n.latex;t.push(`- Formula ${n.id} (Page ${n.pageNumber}): ${s}`)})),e.citations.length>0){t.push(`
=== CITATION CONTEXT ===`),t.push(`Total Citations: ${e.citations.length}`);let n=Math.min(5,e.citations.length);t.push(`Key Citations (showing ${n} of ${e.citations.length}):`),e.citations.slice(0,n).forEach(s=>{if(s.authors&&s.year&&s.title){let i=s.authors.length>2?`${s.authors[0]} et al.`:s.authors.join(", ");t.push(`- [${s.id}] ${i} (${s.year}): ${s.title}`)}else t.push(`- [${s.id}] ${s.text}`)}),e.citations.length>n&&t.push(`... and ${e.citations.length-n} more citations`)}return t.push(`
=== PAGE SUMMARIES ===`),e.pages.forEach(n=>{t.push(`
--- Page ${n.pageNumber} ---`);let s=[],i=e.figures.filter(u=>u.pageNumber===n.pageNumber);i.length>0&&s.push(`Figures: ${i.map(u=>u.id).join(", ")}`);let c=e.tables.filter(u=>u.pageNumber===n.pageNumber);c.length>0&&s.push(`Tables: ${c.map(u=>u.id).join(", ")}`);let m=e.formulas.filter(u=>u.pageNumber===n.pageNumber);m.length>0&&s.push(`Formulas: ${m.map(u=>u.id).join(", ")}`),s.length>0&&t.push(`Elements: ${s.join(" | ")}`);let l=600;if(n.text.length>l){let u=n.text.substring(0,l),f=u.lastIndexOf("."),p=f>l*.7?u.substring(0,f+1):u;t.push(`Text: ${p}...[truncated, ${n.text.length-p.length} chars remaining]`)}else t.push(`Text: ${n.text}`)}),e.figures.length>0&&(t.push(`
=== DETAILED FIGURE DESCRIPTIONS ===`),e.figures.forEach(n=>{t.push(`
[${n.id}] Page ${n.pageNumber}`),n.caption&&t.push(`Caption: ${n.caption}`),t.push(`Description: ${n.description}`)})),e.tables.length>0&&(t.push(`
=== DETAILED TABLE DESCRIPTIONS ===`),e.tables.forEach(n=>{t.push(`
[${n.id}] Page ${n.pageNumber}`),t.push(`Headers: ${n.headers.join(" | ")}`),t.push(`Rows: ${n.rows.length}`),t.push(`Interpretation: ${n.interpretation}`)})),e.formulas.length>0&&(t.push(`
=== DETAILED FORMULA DESCRIPTIONS ===`),e.formulas.forEach(n=>{t.push(`
[${n.id}] Page ${n.pageNumber}`),t.push(`LaTeX: ${n.latex}`),t.push(`Explanation: ${n.explanation}`)})),t.join(`
`)}function Nr(e){let t=new Map;for(let r=0;r<e.length;r++)t.set(r,[]);return e.forEach((r,o)=>{r.prerequisites.forEach(n=>{if(n>=0&&n<e.length&&n!==o){let s=t.get(n)||[];s.push(o),t.set(n,s)}})}),t}function Or(e,t){let r=new Set,o=new Set;function n(s){r.add(s),o.add(s);let i=e.get(s)||[];for(let c of i)if(r.has(c)){if(o.has(c))return!0}else if(n(c))return!0;return o.delete(s),!1}for(let s=0;s<t;s++)if(!r.has(s)&&n(s))return!0;return!1}function Dr(e){let t=Nr(e);if(Or(t,e.length))return a.warn("Circular dependencies detected in segments, using fallback ordering"),e.map((s,i)=>i);let r=new Map;for(let s=0;s<e.length;s++)r.set(s,0);e.forEach((s,i)=>{s.prerequisites.forEach(c=>{c>=0&&c<e.length&&c!==i&&r.set(i,(r.get(i)||0)+1)})});let o=[];for(let s=0;s<e.length;s++)r.get(s)===0&&o.push(s);let n=[];for(;o.length>0;){let s=o.shift();n.push(s),(t.get(s)||[]).forEach(c=>{let m=(r.get(c)||0)-1;r.set(c,m),m===0&&o.push(c)})}return n.length!==e.length?(a.warn("Topological sort incomplete, using fallback ordering"),e.map((s,i)=>i)):n}function Cr(e,t){let r=[],o=Dr(e.segments);return o.forEach((n,s)=>{let i=e.segments[n],c=[];i.contentIndices.pageRanges.forEach(([u,f])=>{for(let p=u;p<=f;p++){let d=t.pages.find(y=>y.pageNumber===p);d&&d.text.trim()&&c.push({type:"text",content:d.text,pageReference:p})}}),i.contentIndices.figureIds.forEach(u=>{let f=t.figures.find(p=>p.id===u);f&&c.push({type:"figure",content:f,pageReference:f.pageNumber})}),i.contentIndices.tableIds.forEach(u=>{let f=t.tables.find(p=>p.id===u);f&&c.push({type:"table",content:f,pageReference:f.pageNumber})}),i.contentIndices.formulaIds.forEach(u=>{let f=t.formulas.find(p=>p.id===u);f&&c.push({type:"formula",content:f,pageReference:f.pageNumber})}),i.contentIndices.citationIds.forEach(u=>{let f=t.citations.find(p=>p.id===u);f&&c.push({type:"citation",content:f,pageReference:0})});let m=i.prerequisites.map(u=>o.indexOf(u)).filter(u=>u!==-1&&u<s),l={id:Ie(),title:i.title,order:s,contentBlocks:c,prerequisites:m.map(u=>r[u]?.id).filter(Boolean)};r.push(l)}),r}async function _r(e){return a.info("Using mock segmentation (feature flag disabled)"),await new Promise(t=>setTimeout(t,200)),{segments:[{title:"Introduction and Background",contentIndices:{pageRanges:[[1,2]],figureIds:[],tableIds:[],formulaIds:[],citationIds:[]},prerequisites:[]},{title:"Main Content",contentIndices:{pageRanges:[[3,5]],figureIds:[],tableIds:[],formulaIds:[],citationIds:[]},prerequisites:[0]},{title:"Conclusion",contentIndices:{pageRanges:[[6,6]],figureIds:[],tableIds:[],formulaIds:[],citationIds:[]},prerequisites:[1]}]}}async function Pr(e,t){if(!g.featureFlags.enableRealSegmentation)return a.info("Real segmentation disabled by feature flag, using mock implementation",{correlationId:t}),_r(e);let r=Date.now(),o=t||Ie(),n;try{n=$e("segmentation",C.getProvider()),a.info("Calling LLM for content segmentation",{correlationId:o,model:n,provider:C.getProvider(),promptLength:e.length});let s=await C.chat({messages:[{role:"system",content:`You are an expert at analyzing scientific documents and organizing content into logical segments.

Your task is to:
1. Identify distinct topics and concepts in the content
2. Group related concepts together
3. Determine prerequisite relationships between segments
4. Create a logical narrative flow

Return your response as JSON matching this exact structure:
{
  "segments": [
    {
      "title": "string",
      "contentIndices": {
        "pageRanges": [[startPage, endPage]],
        "figureIds": ["id1", "id2"],
        "tableIds": ["id1"],
        "formulaIds": ["id1"],
        "citationIds": ["id1"]
      },
      "prerequisites": [segmentIndex1, segmentIndex2]
    }
  ]
}

Respond ONLY with valid JSON, no additional text.`},{role:"user",content:e}],model:n,temperature:.7,maxTokens:2e3}),i=Date.now()-r;a.info("LLM API call completed",{correlationId:o,model:n,duration:i,responseLength:s.content.length,tokensUsed:s.usage?.totalTokens,promptTokens:s.usage?.promptTokens,completionTokens:s.usage?.completionTokens}),s.usage&&I({operation:"segmentation",model:s.model,provider:C.getProvider(),promptTokens:s.usage.promptTokens,completionTokens:s.usage.completionTokens,totalTokens:s.usage.totalTokens,durationMs:i,success:!0});let c;try{c=JSON.parse(s.content)}catch(l){let u=l instanceof Error?l.message:"Unknown parsing error",f=s.content.substring(0,500),p=s.content.length>500?`...[truncated, total length: ${s.content.length}]`:"";throw a.error("Failed to parse LLM response as JSON",{error:u,parseError:l,model:n,responsePreview:f+p,responseLength:s.content.length,tokensUsed:s.usage?.totalTokens}),new Error(`LLM returned invalid JSON response. Parse error: ${u}. Response preview: ${f.substring(0,100)}...`)}if(!c.segments||!Array.isArray(c.segments))throw a.error("Invalid segmentation response structure",{model:n,hasSegments:!!c.segments,segmentsType:typeof c.segments,responseKeys:Object.keys(c)}),new Error(`Invalid segmentation response: missing or invalid segments array. Expected array, got ${typeof c.segments}`);if(c.segments.length===0)throw a.error("Empty segments array in response",{model:n,response:c}),new Error("Invalid segmentation response: segments array is empty");for(let l=0;l<c.segments.length;l++){let u=c.segments[l];if(!u.title||typeof u.title!="string")throw a.error("Invalid segment title",{segmentIndex:l,hasTitle:!!u.title,titleType:typeof u.title,segment:u}),new Error(`Invalid segment ${l}: missing or invalid title. Expected string, got ${typeof u.title}`);if(u.title.trim().length===0)throw a.error("Empty segment title",{segmentIndex:l,title:u.title}),new Error(`Invalid segment ${l}: title cannot be empty`);if(!u.contentIndices)throw a.error("Missing contentIndices",{segmentIndex:l,segmentKeys:Object.keys(u)}),new Error(`Invalid segment ${l}: missing contentIndices`);if(!Array.isArray(u.contentIndices.pageRanges))throw a.error("Invalid pageRanges structure",{segmentIndex:l,pageRangesType:typeof u.contentIndices.pageRanges}),new Error(`Invalid segment ${l}: contentIndices.pageRanges must be an array. Got ${typeof u.contentIndices.pageRanges}`);for(let p=0;p<u.contentIndices.pageRanges.length;p++){let d=u.contentIndices.pageRanges[p];if(!Array.isArray(d)||d.length!==2)throw a.error("Invalid page range format",{segmentIndex:l,rangeIndex:p,range:d,isArray:Array.isArray(d),length:Array.isArray(d)?d.length:"N/A"}),new Error(`Invalid segment ${l}: pageRanges[${p}] must be an array of [startPage, endPage]. Got ${Array.isArray(d)?`array of length ${d.length}`:typeof d}`);let[y,R]=d;if(typeof y!="number"||typeof R!="number")throw a.error("Invalid page range types",{segmentIndex:l,rangeIndex:p,startPageType:typeof y,endPageType:typeof R,range:d}),new Error(`Invalid segment ${l}: pageRanges[${p}] must contain numbers. Got [${typeof y}, ${typeof R}]`);if(y<1||R<1)throw a.error("Invalid page numbers",{segmentIndex:l,rangeIndex:p,startPage:y,endPage:R}),new Error(`Invalid segment ${l}: pageRanges[${p}] page numbers must be >= 1. Got [${y}, ${R}]`);if(y>R)throw a.error("Invalid page range order",{segmentIndex:l,rangeIndex:p,startPage:y,endPage:R}),new Error(`Invalid segment ${l}: pageRanges[${p}] startPage cannot be greater than endPage. Got [${y}, ${R}]`)}u.contentIndices.figureIds=u.contentIndices.figureIds||[],u.contentIndices.tableIds=u.contentIndices.tableIds||[],u.contentIndices.formulaIds=u.contentIndices.formulaIds||[],u.contentIndices.citationIds=u.contentIndices.citationIds||[];let f=[{name:"figureIds",value:u.contentIndices.figureIds},{name:"tableIds",value:u.contentIndices.tableIds},{name:"formulaIds",value:u.contentIndices.formulaIds},{name:"citationIds",value:u.contentIndices.citationIds}];for(let{name:p,value:d}of f){if(!Array.isArray(d))throw a.error("Invalid ID array type",{segmentIndex:l,arrayName:p,actualType:typeof d}),new Error(`Invalid segment ${l}: contentIndices.${p} must be an array. Got ${typeof d}`);for(let y=0;y<d.length;y++)if(typeof d[y]!="string")throw a.error("Invalid ID type in array",{segmentIndex:l,arrayName:p,idIndex:y,idType:typeof d[y],idValue:d[y]}),new Error(`Invalid segment ${l}: contentIndices.${p}[${y}] must be a string. Got ${typeof d[y]}`)}if(!Array.isArray(u.prerequisites))throw a.error("Invalid prerequisites type",{segmentIndex:l,prerequisitesType:typeof u.prerequisites}),new Error(`Invalid segment ${l}: prerequisites must be an array. Got ${typeof u.prerequisites}`);for(let p=0;p<u.prerequisites.length;p++){let d=u.prerequisites[p];if(typeof d!="number")throw a.error("Invalid prerequisite type",{segmentIndex:l,prerequisiteIndex:p,prerequisiteType:typeof d,prerequisiteValue:d}),new Error(`Invalid segment ${l}: prerequisites[${p}] must be a number. Got ${typeof d}`);if(!Number.isInteger(d))throw a.error("Non-integer prerequisite index",{segmentIndex:l,prerequisiteIndex:p,prerequisiteValue:d}),new Error(`Invalid segment ${l}: prerequisite indices must be integers. Got ${d}`);if(d<0)throw a.error("Negative prerequisite index",{segmentIndex:l,prerequisiteIndex:p,prerequisiteValue:d}),new Error(`Invalid segment ${l}: prerequisite indices must be non-negative. Got ${d}`);if(d>=c.segments.length)throw a.error("Prerequisite index out of bounds",{segmentIndex:l,prerequisiteIndex:p,prerequisiteValue:d,maxValidIndex:c.segments.length-1,totalSegments:c.segments.length}),new Error(`Invalid segment ${l}: prerequisite index ${d} is out of bounds. Valid range: 0-${c.segments.length-1}`);if(d===l)throw a.error("Self-referential prerequisite",{segmentIndex:l,prerequisiteIndex:p,prerequisiteValue:d}),new Error(`Invalid segment ${l}: segment cannot be a prerequisite of itself`)}}let m=Date.now()-r;return a.info("Segmentation completed successfully",{correlationId:o,segmentCount:c.segments.length,model:n,totalDuration:m,tokensUsed:s.usage?.totalTokens}),c}catch(s){let i=Date.now()-r,c=kr(s),m=s instanceof Error?s.message:"Unknown error",l=s instanceof Error?s.stack:void 0;throw I({operation:"segmentation",model:n||"unknown",provider:C.getProvider(),promptTokens:0,completionTokens:0,totalTokens:0,durationMs:i,success:!1,errorType:c}),a.error("Segmentation LLM call failed",{correlationId:o,errorType:c,errorMessage:m,errorStack:l,model:n,provider:C.getProvider(),duration:i,promptLength:e.length,originalError:s}),c==="JSON_PARSE_ERROR"?new Error(`Segmentation failed: ${m}`):c==="VALIDATION_ERROR"?new Error(`Segmentation validation failed: ${m}`):c==="API_ERROR"?new Error(`LLM API error during segmentation: ${m}`):new Error(`Failed to segment content: ${m}`)}}function kr(e){if(!e)return"UNKNOWN_ERROR";let t=e.message?.toLowerCase()||"";return e instanceof SyntaxError||t.includes("json")||t.includes("parse")?"JSON_PARSE_ERROR":t.includes("invalid")||t.includes("missing")||t.includes("must be")?"VALIDATION_ERROR":t.includes("api error")||t.includes("status")||t.includes("rate limit")?"API_ERROR":t.includes("timeout")||t.includes("connection")||t.includes("network")?"NETWORK_ERROR":"UNKNOWN_ERROR"}async function xt(e){let t=Date.now(),r=`seg-${e}-${Ie()}`;try{a.info("Starting content segmentation",{jobId:e,correlationId:r});let{getContent:o,updateContent:n}=(Te(),ee(It)),s;try{s=await o(e)}catch(p){throw a.error("Failed to retrieve content from database",{jobId:e,error:p,errorMessage:p instanceof Error?p.message:"Unknown error"}),new Error(`Database error: Failed to retrieve content for job ${e}`)}if(!s)throw a.error("Content record not found",{jobId:e}),new Error(`No content record found for job: ${e}`);if(!s.extractedContent)throw a.error("Extracted content missing from record",{jobId:e,recordKeys:Object.keys(s)}),new Error(`No extracted content found for job: ${e}`);let i=s.extractedContent;a.info("Retrieved extracted content",{jobId:e,pageCount:i.pages.length,figureCount:i.figures.length,tableCount:i.tables.length,formulaCount:i.formulas.length,citationCount:i.citations.length});let c;try{c=Ar(i),a.info("Created segmentation prompt",{jobId:e,promptLength:c.length})}catch(p){throw a.error("Failed to create segmentation prompt",{jobId:e,error:p,errorMessage:p instanceof Error?p.message:"Unknown error"}),new Error(`Failed to create segmentation prompt: ${p instanceof Error?p.message:"Unknown error"}`)}let m;try{m=await Pr(c,r)}catch(p){throw a.error("LLM segmentation call failed after retries",{jobId:e,correlationId:r,error:p,errorMessage:p instanceof Error?p.message:"Unknown error"}),new Error(`LLM segmentation failed: ${p instanceof Error?p.message:"Unknown error"}`)}let l;try{l=Cr(m,i),a.info("Parsed segmentation response",{jobId:e,segmentCount:l.length})}catch(p){throw a.error("Failed to parse segmentation response",{jobId:e,error:p,errorMessage:p instanceof Error?p.message:"Unknown error",segmentCount:m.segments.length}),new Error(`Failed to parse segmentation response: ${p instanceof Error?p.message:"Unknown error"}`)}let u={segments:l};try{await n(e,{segmentedContent:u}),a.info("Stored segmented content in database",{jobId:e,segmentCount:l.length})}catch(p){throw a.error("Failed to store segmented content in database",{jobId:e,error:p,errorMessage:p instanceof Error?p.message:"Unknown error",segmentCount:l.length}),new Error(`Database error: Failed to store segmented content for job ${e}`)}let f=Date.now()-t;return a.info("Content segmentation completed successfully",{jobId:e,segmentCount:l.length,totalDuration:f}),u}catch(o){let n=Date.now()-t;throw a.error("Content segmentation failed",{jobId:e,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorStack:o instanceof Error?o.stack:void 0,duration:n}),o}}Te();var Rt=require("aws-sdk");_();x();var Mr=new Rt.EventBridge({endpoint:g.isLocal?"http://localhost:4566":void 0,region:g.awsRegion});async function $r(e,t){let r=g.eventBusName||"pdf-lecture-service-events";try{a.info("Publishing pipeline event",{detailType:e,jobId:t.jobId});let o={Entries:[{Source:"pdf-lecture-service",DetailType:e,Detail:JSON.stringify(t),EventBusName:r}]},n=await Mr.putEvents(o).promise();if(n.FailedEntryCount&&n.FailedEntryCount>0){let s=n.Entries?.filter(i=>i.ErrorCode).map(i=>({code:i.ErrorCode,message:i.ErrorMessage}));throw new Error(`Failed to publish event: ${JSON.stringify(s)}`)}a.info("Pipeline event published successfully",{detailType:e,jobId:t.jobId})}catch(o){throw a.error("Failed to publish pipeline event",{error:o,detailType:e,jobId:t.jobId}),o}}async function St(e,t){await $r("SegmentationCompleted",{jobId:e,agentId:t})}x();_();async function Ur(e){try{a.info("Segmenter function invoked");let t=e.jobId;if(!t)throw new Error("jobId is required");let r=await j(t);if(!r)throw new Error(`Job not found: ${t}`);await q(t,{status:"segmenting",stages:r.stages.map(n=>n.stage==="segmentation"?{...n,status:"in_progress",startedAt:new Date}:n)}),a.info("Starting content segmentation",{jobId:t});let o=await xt(t);return await q(t,{status:"generating_script",stages:r.stages.map(n=>n.stage==="segmentation"?{...n,status:"completed",completedAt:new Date}:n.stage==="script_generation"?{...n,status:"in_progress",startedAt:new Date}:n)}),a.info("Content segmentation completed successfully",{jobId:t}),g.nodeEnv==="production"&&(await St(t,r.agentId),a.info("Script generation triggered asynchronously",{jobId:t})),{statusCode:200,body:JSON.stringify({jobId:t,status:"generating_script",message:"Content segmentation completed",segmentedContent:{segments:o.segments.length}})}}catch(t){a.error("Segmenter handler error",{error:t});let r={error:t instanceof Error?t.message:"Unknown error",code:"SEGMENTATION_FAILED",retryable:!0};if(e.jobId)try{let o=await j(e.jobId);o&&await q(e.jobId,{status:"failed",error:r.error,stages:o.stages.map(n=>n.stage==="segmentation"?{...n,status:"failed",error:r.error}:n)})}catch(o){a.error("Failed to update job status",{error:o})}return{statusCode:500,body:JSON.stringify(r)}}}0&&(module.exports={segmenterHandler});
//# sourceMappingURL=segmenter.js.map
