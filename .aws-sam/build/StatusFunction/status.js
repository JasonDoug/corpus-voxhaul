"use strict";var k=Object.create;var v=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var I=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),F=(e,t)=>{for(var r in t)v(e,r,{get:t[r],enumerable:!0})},S=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of j(t))!$.call(e,s)&&s!==r&&v(e,s,{get:()=>t[s],enumerable:!(n=K(t,s))||n.enumerable});return e};var w=(e,t,r)=>(r=e!=null?k(B(e)):{},S(t||!e||!e.__esModule?v(r,"default",{value:e,enumerable:!0}):r,e)),U=e=>S(v({},"__esModule",{value:!0}),e);var _=I((ue,M)=>{M.exports={name:"dotenv",version:"16.6.1",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=text --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},homepage:"https://github.com/motdotla/dotenv#readme",funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var x=I((pe,p)=>{var A=require("fs"),E=require("path"),Y=require("os"),q=require("crypto"),W=_(),h=W.version,G=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Q(e){let t={},r=e.toString();r=r.replace(/\r\n?/mg,`
`);let n;for(;(n=G.exec(r))!=null;){let s=n[1],o=n[2]||"";o=o.trim();let a=o[0];o=o.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),a==='"'&&(o=o.replace(/\\n/g,`
`),o=o.replace(/\\r/g,"\r")),t[s]=o}return t}function H(e){e=e||{};let t=O(e);e.path=t;let r=c.configDotenv(e);if(!r.parsed){let a=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw a.code="MISSING_DATA",a}let n=L(e).split(","),s=n.length,o;for(let a=0;a<s;a++)try{let i=n[a].trim(),d=z(r,i);o=c.decrypt(d.ciphertext,d.key);break}catch(i){if(a+1>=s)throw i}return c.parse(o)}function X(e){console.log(`[dotenv@${h}][WARN] ${e}`)}function y(e){console.log(`[dotenv@${h}][DEBUG] ${e}`)}function R(e){console.log(`[dotenv@${h}] ${e}`)}function L(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function z(e,t){let r;try{r=new URL(t)}catch(i){if(i.code==="ERR_INVALID_URL"){let d=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw d.code="INVALID_DOTENV_KEY",d}throw i}let n=r.password;if(!n){let i=new Error("INVALID_DOTENV_KEY: Missing key part");throw i.code="INVALID_DOTENV_KEY",i}let s=r.searchParams.get("environment");if(!s){let i=new Error("INVALID_DOTENV_KEY: Missing environment part");throw i.code="INVALID_DOTENV_KEY",i}let o=`DOTENV_VAULT_${s.toUpperCase()}`,a=e.parsed[o];if(!a){let i=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${o} in your .env.vault file.`);throw i.code="NOT_FOUND_DOTENV_ENVIRONMENT",i}return{ciphertext:a,key:n}}function O(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let r of e.path)A.existsSync(r)&&(t=r.endsWith(".vault")?r:`${r}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=E.resolve(process.cwd(),".env.vault");return A.existsSync(t)?t:null}function D(e){return e[0]==="~"?E.join(Y.homedir(),e.slice(1)):e}function Z(e){let t=!!(e&&e.debug),r=e&&"quiet"in e?e.quiet:!0;(t||!r)&&R("Loading env from encrypted .env.vault");let n=c._parseVault(e),s=process.env;return e&&e.processEnv!=null&&(s=e.processEnv),c.populate(s,n,e),{parsed:n}}function ee(e){let t=E.resolve(process.cwd(),".env"),r="utf8",n=!!(e&&e.debug),s=e&&"quiet"in e?e.quiet:!0;e&&e.encoding?r=e.encoding:n&&y("No encoding is specified. UTF-8 is used by default");let o=[t];if(e&&e.path)if(!Array.isArray(e.path))o=[D(e.path)];else{o=[];for(let m of e.path)o.push(D(m))}let a,i={};for(let m of o)try{let l=c.parse(A.readFileSync(m,{encoding:r}));c.populate(i,l,e)}catch(l){n&&y(`Failed to load ${m} ${l.message}`),a=l}let d=process.env;if(e&&e.processEnv!=null&&(d=e.processEnv),c.populate(d,i,e),n||!s){let m=Object.keys(i).length,l=[];for(let T of o)try{let b=E.relative(process.cwd(),T);l.push(b)}catch(b){n&&y(`Failed to load ${T} ${b.message}`),a=b}R(`injecting env (${m}) from ${l.join(",")}`)}return a?{parsed:i,error:a}:{parsed:i}}function te(e){if(L(e).length===0)return c.configDotenv(e);let t=O(e);return t?c._configVault(e):(X(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),c.configDotenv(e))}function re(e,t){let r=Buffer.from(t.slice(-64),"hex"),n=Buffer.from(e,"base64"),s=n.subarray(0,12),o=n.subarray(-16);n=n.subarray(12,-16);try{let a=q.createDecipheriv("aes-256-gcm",r,s);return a.setAuthTag(o),`${a.update(n)}${a.final()}`}catch(a){let i=a instanceof RangeError,d=a.message==="Invalid key length",m=a.message==="Unsupported state or unable to authenticate data";if(i||d){let l=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw l.code="INVALID_DOTENV_KEY",l}else if(m){let l=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw l.code="DECRYPTION_FAILED",l}else throw a}}function ne(e,t,r={}){let n=!!(r&&r.debug),s=!!(r&&r.override);if(typeof t!="object"){let o=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw o.code="OBJECT_REQUIRED",o}for(let o of Object.keys(t))Object.prototype.hasOwnProperty.call(e,o)?(s===!0&&(e[o]=t[o]),n&&y(s===!0?`"${o}" is already defined and WAS overwritten`:`"${o}" is already defined and was NOT overwritten`)):e[o]=t[o]}var c={configDotenv:ee,_configVault:Z,_parseVault:H,config:te,decrypt:re,parse:Q,populate:ne};p.exports.configDotenv=c.configDotenv;p.exports._configVault=c._configVault;p.exports._parseVault=c._parseVault;p.exports.config=c.config;p.exports.decrypt=c.decrypt;p.exports.parse=c.parse;p.exports.populate=c.populate;p.exports=c});var le={};F(le,{statusHandler:()=>ce});module.exports=U(le);var P=w(require("aws-sdk"));var C=w(x());C.default.config();var g={nodeEnv:process.env.NODE_ENV||"development",port:parseInt(process.env.PORT||"3000",10),localMode:process.env.LOCAL_MODE==="true",isLocal:process.env.NODE_ENV!=="production",awsRegion:process.env.AWS_REGION||"us-east-1",eventBusName:process.env.EVENT_BUS_NAME||"pdf-lecture-service-events",aws:{region:process.env.AWS_REGION||"us-east-1",accessKeyId:process.env.AWS_ACCESS_KEY_ID,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY},localstack:{endpoint:process.env.LOCALSTACK_ENDPOINT||"http://localhost:4566",useLocalStack:process.env.USE_LOCALSTACK==="true"},s3:{bucketName:process.env.S3_BUCKET_NAME||"pdf-lecture-service",pdfPrefix:process.env.S3_PDF_PREFIX||"pdfs",audioPrefix:process.env.S3_AUDIO_PREFIX||"audio",cachePrefix:process.env.S3_CACHE_PREFIX||"cache"},dynamodb:{jobsTable:process.env.DYNAMODB_JOBS_TABLE||"pdf-lecture-jobs",agentsTable:process.env.DYNAMODB_AGENTS_TABLE||"pdf-lecture-agents",contentTable:process.env.DYNAMODB_CONTENT_TABLE||"pdf-lecture-content"},processing:{maxPdfSizeMB:parseInt(process.env.MAX_PDF_SIZE_MB||"100",10),analysisTimeoutMs:parseInt(process.env.ANALYSIS_TIMEOUT_MS||"300000",10),audioSynthesisTimeoutMs:parseInt(process.env.AUDIO_SYNTHESIS_TIMEOUT_MS||"600000",10)},featureFlags:{enableRealSegmentation:process.env.ENABLE_REAL_SEGMENTATION==="true",enableRealScriptGeneration:process.env.ENABLE_REAL_SCRIPT_GENERATION==="true",enableImageExtraction:process.env.ENABLE_IMAGE_EXTRACTION==="true",enableVisionFirstPipeline:process.env.ENABLE_VISION_FIRST_PIPELINE==="true"},vision:{model:process.env.VISION_MODEL||"google/gemini-2.0-flash-exp:free",temperature:parseFloat(process.env.VISION_LLM_TEMPERATURE||"0.3"),maxTokens:parseInt(process.env.VISION_LLM_MAX_TOKENS||"4000",10)}};var oe=[/password/i,/secret/i,/token/i,/apikey/i,/api[_-]?key/i,/authorization/i,/auth/i,/credential/i,/private[_-]?key/i,/access[_-]?key/i],N=class e{correlationId;serviceName;functionName;minLogLevel;constructor(){let t=process.env.LOG_LEVEL?.toUpperCase();this.minLogLevel=t||"INFO"}setCorrelationId(t){this.correlationId=t}getCorrelationId(){return this.correlationId}setServiceName(t){this.serviceName=t}setFunctionName(t){this.functionName=t}redactSensitiveData(t){if(t==null||typeof t=="string")return t;if(Array.isArray(t))return t.map(r=>this.redactSensitiveData(r));if(typeof t=="object"){let r={};for(let[n,s]of Object.entries(t))oe.some(a=>a.test(n))?r[n]="[REDACTED]":typeof s=="object"&&s!==null?r[n]=this.redactSensitiveData(s):r[n]=s;return r}return t}shouldLog(t){let r=["ERROR","WARN","INFO","DEBUG"],n=r.indexOf(t),s=r.indexOf(this.minLogLevel);return n<=s}log(t,r,n){if(!this.shouldLog(t))return;let s={level:t,message:r,timestamp:new Date().toISOString(),correlationId:this.correlationId,service:this.serviceName,function:this.functionName,metadata:n?this.redactSensitiveData(n):void 0};console.log(JSON.stringify(s))}error(t,r){this.log("ERROR",t,r)}warn(t,r){this.log("WARN",t,r)}info(t,r){this.log("INFO",t,r)}debug(t,r){this.log("DEBUG",t,r)}child(t){let r=new e;return r.setCorrelationId(t),r.setServiceName(this.serviceName||""),r.setFunctionName(this.functionName||""),r}},u=new N;var f={region:g.aws.region};g.localstack.useLocalStack?(f.endpoint=g.localstack.endpoint,f.accessKeyId="test",f.secretAccessKey="test"):g.aws.accessKeyId&&g.aws.secretAccessKey&&(f.accessKeyId=g.aws.accessKeyId,f.secretAccessKey=g.aws.secretAccessKey);var se=new P.default.DynamoDB.DocumentClient(f);function ae(e,t){throw u.error(`DynamoDB ${t} failed`,{error:e.message}),new Error(`Database operation failed: ${t}`)}function ie(e){return{...e,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),stages:e.stages.map(t=>({...t,startedAt:t.startedAt?new Date(t.startedAt):void 0,completedAt:t.completedAt?new Date(t.completedAt):void 0}))}}async function J(e){try{let t=await se.get({TableName:g.dynamodb.jobsTable,Key:{jobId:e}}).promise();return t.Item?ie(t.Item):null}catch(t){ae(t,"getJob")}}async function V(e){let{jobId:t}=e;u.info("Retrieving job status",{jobId:t});let r=await J(t);if(!r)throw u.warn("Job not found",{jobId:t}),new Error(`Job not found: ${t}`);let n={jobId:r.jobId,status:r.status,createdAt:r.createdAt,updatedAt:r.updatedAt,pdfFilename:r.pdfFilename,agentId:r.agentId,stages:r.stages,error:r.error};return u.info("Job status retrieved",{jobId:t,status:r.status}),n}async function ce(e){try{u.info("Status query function invoked");let t=e.jobId||e.pathParameters?.jobId;if(!t)throw new Error("jobId is required");let n=await V({jobId:t});return u.info("Status query completed successfully",{jobId:t}),{statusCode:200,body:JSON.stringify(n)}}catch(t){u.error("Status handler error",{error:t});let r=t instanceof Error&&t.message.includes("not found"),n={error:t instanceof Error?t.message:"Unknown error",code:r?"JOB_NOT_FOUND":"STATUS_QUERY_FAILED",jobId:e.jobId||e.pathParameters?.jobId,retryable:!r};return{statusCode:r?404:500,body:JSON.stringify(n)}}}0&&(module.exports={statusHandler});
//# sourceMappingURL=status.js.map
