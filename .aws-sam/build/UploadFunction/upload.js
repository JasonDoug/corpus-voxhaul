"use strict";var ge=Object.create;var D=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var he=Object.getOwnPropertyNames;var ye=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty;var O=(e,t)=>()=>(e&&(t=e(e=0)),t);var M=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),U=(e,t)=>{for(var r in t)D(e,r,{get:t[r],enumerable:!0})},K=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of he(t))!be.call(e,o)&&o!==r&&D(e,o,{get:()=>t[o],enumerable:!(n=fe(t,o))||n.enumerable});return e};var C=(e,t,r)=>(r=e!=null?ge(ye(e)):{},K(t||!e||!e.__esModule?D(r,"default",{value:e,enumerable:!0}):r,e)),Ee=e=>K(D({},"__esModule",{value:!0}),e);var V=M((Xe,ve)=>{ve.exports={name:"dotenv",version:"16.6.1",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=text --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},homepage:"https://github.com/motdotla/dotenv#readme",funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var Y=M((Qe,g)=>{var k=require("fs"),x=require("path"),we=require("os"),Se=require("crypto"),Ae=V(),I=Ae.version,Ne=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Te(e){let t={},r=e.toString();r=r.replace(/\r\n?/mg,`
`);let n;for(;(n=Ne.exec(r))!=null;){let o=n[1],i=n[2]||"";i=i.trim();let s=i[0];i=i.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),s==='"'&&(i=i.replace(/\\n/g,`
`),i=i.replace(/\\r/g,"\r")),t[o]=i}return t}function De(e){e=e||{};let t=W(e);e.path=t;let r=l.configDotenv(e);if(!r.parsed){let s=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw s.code="MISSING_DATA",s}let n=q(e).split(","),o=n.length,i;for(let s=0;s<o;s++)try{let u=n[s].trim(),m=xe(r,u);i=l.decrypt(m.ciphertext,m.key);break}catch(u){if(s+1>=o)throw u}return l.parse(i)}function Ce(e){console.log(`[dotenv@${I}][WARN] ${e}`)}function A(e){console.log(`[dotenv@${I}][DEBUG] ${e}`)}function j(e){console.log(`[dotenv@${I}] ${e}`)}function q(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function xe(e,t){let r;try{r=new URL(t)}catch(u){if(u.code==="ERR_INVALID_URL"){let m=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw m.code="INVALID_DOTENV_KEY",m}throw u}let n=r.password;if(!n){let u=new Error("INVALID_DOTENV_KEY: Missing key part");throw u.code="INVALID_DOTENV_KEY",u}let o=r.searchParams.get("environment");if(!o){let u=new Error("INVALID_DOTENV_KEY: Missing environment part");throw u.code="INVALID_DOTENV_KEY",u}let i=`DOTENV_VAULT_${o.toUpperCase()}`,s=e.parsed[i];if(!s){let u=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${i} in your .env.vault file.`);throw u.code="NOT_FOUND_DOTENV_ENVIRONMENT",u}return{ciphertext:s,key:n}}function W(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let r of e.path)k.existsSync(r)&&(t=r.endsWith(".vault")?r:`${r}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=x.resolve(process.cwd(),".env.vault");return k.existsSync(t)?t:null}function J(e){return e[0]==="~"?x.join(we.homedir(),e.slice(1)):e}function Re(e){let t=!!(e&&e.debug),r=e&&"quiet"in e?e.quiet:!0;(t||!r)&&j("Loading env from encrypted .env.vault");let n=l._parseVault(e),o=process.env;return e&&e.processEnv!=null&&(o=e.processEnv),l.populate(o,n,e),{parsed:n}}function Pe(e){let t=x.resolve(process.cwd(),".env"),r="utf8",n=!!(e&&e.debug),o=e&&"quiet"in e?e.quiet:!0;e&&e.encoding?r=e.encoding:n&&A("No encoding is specified. UTF-8 is used by default");let i=[t];if(e&&e.path)if(!Array.isArray(e.path))i=[J(e.path)];else{i=[];for(let y of e.path)i.push(J(y))}let s,u={};for(let y of i)try{let d=l.parse(k.readFileSync(y,{encoding:r}));l.populate(u,d,e)}catch(d){n&&A(`Failed to load ${y} ${d.message}`),s=d}let m=process.env;if(e&&e.processEnv!=null&&(m=e.processEnv),l.populate(m,u,e),n||!o){let y=Object.keys(u).length,d=[];for(let B of i)try{let T=x.relative(process.cwd(),B);d.push(T)}catch(T){n&&A(`Failed to load ${B} ${T.message}`),s=T}j(`injecting env (${y}) from ${d.join(",")}`)}return s?{parsed:u,error:s}:{parsed:u}}function Oe(e){if(q(e).length===0)return l.configDotenv(e);let t=W(e);return t?l._configVault(e):(Ce(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),l.configDotenv(e))}function ke(e,t){let r=Buffer.from(t.slice(-64),"hex"),n=Buffer.from(e,"base64"),o=n.subarray(0,12),i=n.subarray(-16);n=n.subarray(12,-16);try{let s=Se.createDecipheriv("aes-256-gcm",r,o);return s.setAuthTag(i),`${s.update(n)}${s.final()}`}catch(s){let u=s instanceof RangeError,m=s.message==="Invalid key length",y=s.message==="Unsupported state or unable to authenticate data";if(u||m){let d=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw d.code="INVALID_DOTENV_KEY",d}else if(y){let d=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw d.code="DECRYPTION_FAILED",d}else throw s}}function Ie(e,t,r={}){let n=!!(r&&r.debug),o=!!(r&&r.override);if(typeof t!="object"){let i=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw i.code="OBJECT_REQUIRED",i}for(let i of Object.keys(t))Object.prototype.hasOwnProperty.call(e,i)?(o===!0&&(e[i]=t[i]),n&&A(o===!0?`"${i}" is already defined and WAS overwritten`:`"${i}" is already defined and was NOT overwritten`)):e[i]=t[i]}var l={configDotenv:Pe,_configVault:Re,_parseVault:De,config:Oe,decrypt:ke,parse:Te,populate:Ie};g.exports.configDotenv=l.configDotenv;g.exports._configVault=l._configVault;g.exports._parseVault=l._parseVault;g.exports.config=l.config;g.exports.decrypt=l.decrypt;g.exports.parse=l.parse;g.exports.populate=l.populate;g.exports=l});var z,c,E=O(()=>{"use strict";z=C(Y());z.default.config();c={nodeEnv:process.env.NODE_ENV||"development",port:parseInt(process.env.PORT||"3000",10),localMode:process.env.LOCAL_MODE==="true",isLocal:process.env.NODE_ENV!=="production",awsRegion:process.env.AWS_REGION||"us-east-1",eventBusName:process.env.EVENT_BUS_NAME||"pdf-lecture-service-events",aws:{region:process.env.AWS_REGION||"us-east-1",accessKeyId:process.env.AWS_ACCESS_KEY_ID,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY},localstack:{endpoint:process.env.LOCALSTACK_ENDPOINT||"http://localhost:4566",useLocalStack:process.env.USE_LOCALSTACK==="true"},s3:{bucketName:process.env.S3_BUCKET_NAME||"pdf-lecture-service",pdfPrefix:process.env.S3_PDF_PREFIX||"pdfs",audioPrefix:process.env.S3_AUDIO_PREFIX||"audio",cachePrefix:process.env.S3_CACHE_PREFIX||"cache"},dynamodb:{jobsTable:process.env.DYNAMODB_JOBS_TABLE||"pdf-lecture-jobs",agentsTable:process.env.DYNAMODB_AGENTS_TABLE||"pdf-lecture-agents",contentTable:process.env.DYNAMODB_CONTENT_TABLE||"pdf-lecture-content"},processing:{maxPdfSizeMB:parseInt(process.env.MAX_PDF_SIZE_MB||"100",10),analysisTimeoutMs:parseInt(process.env.ANALYSIS_TIMEOUT_MS||"300000",10),audioSynthesisTimeoutMs:parseInt(process.env.AUDIO_SYNTHESIS_TIMEOUT_MS||"600000",10)},featureFlags:{enableRealSegmentation:process.env.ENABLE_REAL_SEGMENTATION==="true",enableRealScriptGeneration:process.env.ENABLE_REAL_SCRIPT_GENERATION==="true",enableImageExtraction:process.env.ENABLE_IMAGE_EXTRACTION==="true",enableVisionFirstPipeline:process.env.ENABLE_VISION_FIRST_PIPELINE==="true"},vision:{model:process.env.VISION_MODEL||"google/gemini-2.0-flash-exp:free",temperature:parseFloat(process.env.VISION_LLM_TEMPERATURE||"0.3"),maxTokens:parseInt(process.env.VISION_LLM_MAX_TOKENS||"4000",10)}}});var _e,_,a,f=O(()=>{"use strict";_e=[/password/i,/secret/i,/token/i,/apikey/i,/api[_-]?key/i,/authorization/i,/auth/i,/credential/i,/private[_-]?key/i,/access[_-]?key/i],_=class e{correlationId;serviceName;functionName;minLogLevel;constructor(){let t=process.env.LOG_LEVEL?.toUpperCase();this.minLogLevel=t||"INFO"}setCorrelationId(t){this.correlationId=t}getCorrelationId(){return this.correlationId}setServiceName(t){this.serviceName=t}setFunctionName(t){this.functionName=t}redactSensitiveData(t){if(t==null||typeof t=="string")return t;if(Array.isArray(t))return t.map(r=>this.redactSensitiveData(r));if(typeof t=="object"){let r={};for(let[n,o]of Object.entries(t))_e.some(s=>s.test(n))?r[n]="[REDACTED]":typeof o=="object"&&o!==null?r[n]=this.redactSensitiveData(o):r[n]=o;return r}return t}shouldLog(t){let r=["ERROR","WARN","INFO","DEBUG"],n=r.indexOf(t),o=r.indexOf(this.minLogLevel);return n<=o}log(t,r,n){if(!this.shouldLog(t))return;let o={level:t,message:r,timestamp:new Date().toISOString(),correlationId:this.correlationId,service:this.serviceName,function:this.functionName,metadata:n?this.redactSensitiveData(n):void 0};console.log(JSON.stringify(o))}error(t,r){this.log("ERROR",t,r)}warn(t,r){this.log("WARN",t,r)}info(t,r){this.log("INFO",t,r)}debug(t,r){this.log("DEBUG",t,r)}child(t){let r=new e;return r.setCorrelationId(t),r.setServiceName(this.serviceName||""),r.setFunctionName(this.functionName||""),r}},a=new _});var de={};U(de,{createAlarm:()=>R,createStandardAlarmsForFunction:()=>Ye,publishMetric:()=>qe,publishMetrics:()=>We});async function qe(e){if(c.isLocal&&!c.localstack.useLocalStack){a.debug("Skipping CloudWatch metric in local mode",{metric:e});return}try{let t=e.dimensions?Object.entries(e.dimensions).map(([r,n])=>({Name:r,Value:n})):[];await L.putMetricData({Namespace:"PDFLectureService",MetricData:[{MetricName:e.name,Value:e.value,Unit:e.unit,Timestamp:e.timestamp||new Date,Dimensions:t}]}).promise(),a.debug("Metric published to CloudWatch",{metric:e})}catch(t){a.error("Failed to publish metric to CloudWatch",{metric:e,error:t instanceof Error?t.message:String(t)})}}async function We(e){if(c.isLocal&&!c.localstack.useLocalStack){a.debug("Skipping CloudWatch metrics in local mode",{count:e.length});return}try{let t=e.map(n=>{let o=n.dimensions?Object.entries(n.dimensions).map(([i,s])=>({Name:i,Value:s})):[];return{MetricName:n.name,Value:n.value,Unit:n.unit,Timestamp:n.timestamp||new Date,Dimensions:o}}),r=20;for(let n=0;n<t.length;n+=r){let o=t.slice(n,n+r);await L.putMetricData({Namespace:"PDFLectureService",MetricData:o}).promise()}a.debug("Metrics published to CloudWatch",{count:e.length})}catch(t){a.error("Failed to publish metrics to CloudWatch",{count:e.length,error:t instanceof Error?t.message:String(t)})}}async function R(e){try{let t=e.dimensions?Object.entries(e.dimensions).map(([r,n])=>({Name:r,Value:n})):[];await L.putMetricAlarm({AlarmName:e.alarmName,MetricName:e.metricName,Namespace:"PDFLectureService",Statistic:e.statistic,Period:e.period,EvaluationPeriods:e.evaluationPeriods,Threshold:e.threshold,ComparisonOperator:e.comparisonOperator,Dimensions:t,TreatMissingData:"notBreaching"}).promise(),a.info("CloudWatch alarm created",{alarmName:e.alarmName})}catch(t){a.error("Failed to create CloudWatch alarm",{alarmName:e.alarmName,error:t instanceof Error?t.message:String(t)})}}async function Ye(e,t){await R({alarmName:`${e}-ErrorRate`,metricName:"Errors",threshold:5,comparisonOperator:"GreaterThanThreshold",evaluationPeriods:1,period:300,statistic:"Sum",dimensions:{FunctionName:e}}),await R({alarmName:`${e}-Timeout`,metricName:"Duration",threshold:t*.9,comparisonOperator:"GreaterThanThreshold",evaluationPeriods:1,period:300,statistic:"Maximum",dimensions:{FunctionName:e}}),await R({alarmName:`${e}-Throttles`,metricName:"Throttles",threshold:1,comparisonOperator:"GreaterThanThreshold",evaluationPeriods:1,period:300,statistic:"Sum",dimensions:{FunctionName:e}})}var le,L,me=O(()=>{"use strict";le=C(require("aws-sdk"));E();f();L=new le.CloudWatch({region:c.aws.region,...c.localstack.useLocalStack&&{endpoint:c.localstack.endpoint}})});var Ge={};U(Ge,{uploadHandler:()=>ze});module.exports=Ee(Ge);var ae=require("crypto");E();f();var h=class extends Error{constructor(r,n,o=500,i=!1,s){super(r);this.code=n;this.statusCode=o;this.retryable=i;this.details=s;this.name="AppError",Error.captureStackTrace(this,this.constructor)}toResponse(r){return{error:this.message,code:this.code,jobId:r,details:this.details,retryable:this.retryable}}},b=class extends h{constructor(t,r){super(t,"VALIDATION_ERROR",400,!1,r),this.name="ValidationError"}};var N=class extends h{constructor(t,r,n){super(t,"EXTERNAL_SERVICE_ERROR",502,!0,{service:r,...n}),this.name="ExternalServiceError"}},v=class extends h{constructor(t,r){super(t,"RESOURCE_ERROR",503,!0,r),this.name="ResourceError"}};function G(e,t){if(e>t)throw new b(`File size exceeds maximum allowed size of ${t} bytes`,{actualSize:e,maxSize:t})}function H(e){if(e.length<5)throw new b("File is too small to be a valid PDF");let t=e.slice(0,5).toString("ascii");if(t!=="%PDF-")throw new b("File is not a valid PDF (invalid magic bytes)",{actualHeader:t})}var Q=C(require("aws-sdk"));E();f();f();var Le={maxAttempts:3,initialDelayMs:1e3,maxDelayMs:1e4,backoffMultiplier:2,retryableErrors:["ECONNRESET","ETIMEDOUT","ENOTFOUND","ECONNREFUSED"]};function Fe(e){return new Promise(t=>setTimeout(t,e))}function $e(e,t){if(!e)return!1;if(typeof e.retryable=="boolean")return e.retryable;if(e.name&&t.includes(e.name)||e.code&&t.includes(e.code))return!0;let r=e.message?.toLowerCase()||"";return r.includes("timeout")||r.includes("connection")||r.includes("network")||r.includes("temporary")||r.includes("rate limit")||r.includes("429")||r.includes("too many requests")}async function X(e,t={}){let r={...Le,...t},n,o=r.initialDelayMs;for(let i=1;i<=r.maxAttempts;i++)try{let s=await e();return i>1&&a.info("Operation succeeded after retry",{attempt:i}),s}catch(s){n=s;let u=$e(s,r.retryableErrors),m=i===r.maxAttempts;if(a.warn("Operation failed",{attempt:i,maxAttempts:r.maxAttempts,isRetryable:u,error:s instanceof Error?s.message:String(s)}),!u||m)throw s;a.info("Retrying operation",{attempt:i,delayMs:o}),await Fe(o),o=Math.min(o*r.backoffMultiplier,r.maxDelayMs)}throw n}var w={region:c.aws.region,s3ForcePathStyle:!0,httpOptions:{timeout:3e4,connectTimeout:5e3},maxRetries:0};c.localstack.useLocalStack?(w.endpoint=c.localstack.endpoint,w.accessKeyId="test",w.secretAccessKey="test"):c.aws.accessKeyId&&c.aws.secretAccessKey&&(w.accessKeyId=c.aws.accessKeyId,w.secretAccessKey=c.aws.secretAccessKey);var Be=new Q.default.S3(w);function Me(e,t){throw a.error(`S3 ${t} failed`,{error:e.message,code:e.code}),e.code==="RequestTimeout"||e.code==="TimeoutError"?new v(`Storage operation timed out: ${t}`,{error:e.message}):e.code==="NoSuchBucket"||e.code==="NoSuchKey"?new v(`Storage resource not found: ${t}`,{error:e.message}):new N(`Storage operation failed: ${t}`,"s3",{error:e.message})}async function Z(e,t,r){return X(async()=>{try{let n=`${c.s3.pdfPrefix}/${e}/original.pdf`;return await Be.putObject({Bucket:c.s3.bucketName,Key:n,Body:t,ContentType:"application/pdf",Metadata:{originalFilename:r,jobId:e}}).promise(),a.info("PDF uploaded",{jobId:e,key:n}),c.localstack.useLocalStack?`${c.localstack.endpoint}/${c.s3.bucketName}/${n}`:`https://${c.s3.bucketName}.s3.${c.aws.region}.amazonaws.com/${n}`}catch(n){Me(n,"uploadPDF")}},{maxAttempts:3,initialDelayMs:1e3})}var ee=C(require("aws-sdk"));E();f();var S={region:c.aws.region};c.localstack.useLocalStack?(S.endpoint=c.localstack.endpoint,S.accessKeyId="test",S.secretAccessKey="test"):c.aws.accessKeyId&&c.aws.secretAccessKey&&(S.accessKeyId=c.aws.accessKeyId,S.secretAccessKey=c.aws.secretAccessKey);var te=new ee.default.DynamoDB.DocumentClient(S);function re(e,t){throw a.error(`DynamoDB ${t} failed`,{error:e.message}),new Error(`Database operation failed: ${t}`)}function Ue(e){return{...e,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}}async function ne(e){try{let t=Ue(e);return await te.put({TableName:c.dynamodb.jobsTable,Item:t}).promise(),a.info("Job created",{jobId:e.jobId}),e}catch(t){re(t,"createJob")}}async function oe(e){try{let t={jobId:e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await te.put({TableName:c.dynamodb.contentTable,Item:t}).promise(),a.info("Content record created",{jobId:e}),t}catch(t){re(t,"createContent")}}var ie=require("aws-sdk");E();f();var Ke=new ie.EventBridge({endpoint:c.isLocal?"http://localhost:4566":void 0,region:c.awsRegion});async function Ve(e,t){let r=c.eventBusName||"pdf-lecture-service-events";try{a.info("Publishing pipeline event",{detailType:e,jobId:t.jobId});let n={Entries:[{Source:"pdf-lecture-service",DetailType:e,Detail:JSON.stringify(t),EventBusName:r}]},o=await Ke.putEvents(n).promise();if(o.FailedEntryCount&&o.FailedEntryCount>0){let i=o.Entries?.filter(s=>s.ErrorCode).map(s=>({code:s.ErrorCode,message:s.ErrorMessage}));throw new Error(`Failed to publish event: ${JSON.stringify(i)}`)}a.info("Pipeline event published successfully",{detailType:e,jobId:t.jobId})}catch(n){throw a.error("Failed to publish pipeline event",{error:n,detailType:e,jobId:t.jobId}),n}}async function se(e){await Ve("JobCreated",{jobId:e})}function Je(e,t){let r=c.processing.maxPdfSizeMB*1024*1024;try{G(e.length,r)}catch(n){throw n instanceof b&&a.warn("File size validation failed",{fileSize:e.length,maxSize:r,filename:t}),n}try{H(e)}catch(n){throw n instanceof b&&a.warn("PDF format validation failed",{filename:t}),n}a.info("Upload validation passed",{filename:t,size:e.length})}function ce(e,t){if(e instanceof h)return e.toResponse(t);if("code"in e&&typeof e.code=="string"){let r=e;return{error:r.error||e.message,code:r.code,jobId:t,retryable:r.code==="UPLOAD_FAILED"}}return{error:e.message||"An unexpected error occurred",code:"UPLOAD_FAILED",jobId:t,retryable:!0}}async function ue(e){let{file:t,filename:r,agentId:n}=e;Je(t,r);let o=(0,ae.randomUUID)();a.info("Starting upload process",{jobId:o,filename:r,agentId:n});try{let i=await Z(o,t,r);a.info("PDF uploaded to storage",{jobId:o,pdfUrl:i});let s={jobId:o,status:"queued",createdAt:new Date,updatedAt:new Date,pdfFilename:r,pdfUrl:i,agentId:n,stages:je()};return await ne(s),a.info("Job record created",{jobId:o}),await oe(o),a.info("Content record created",{jobId:o}),c.nodeEnv==="production"?(await se(o),a.info("Analysis triggered asynchronously",{jobId:o})):a.info("Job queued for analysis (local mode)",{jobId:o}),{jobId:o,status:"queued",message:"PDF uploaded successfully and queued for processing"}}catch(i){throw a.error("Upload failed",{jobId:o,error:i}),i instanceof h?i:new h(i instanceof Error?i.message:"Upload failed","UPLOAD_FAILED",500,!0)}}function je(){return["upload","analysis","segmentation","script_generation","audio_synthesis"].map((t,r)=>({stage:t,status:r===0?"completed":"pending"}))}f();f();var F=class{metrics=[];activeTimers=new Map;recordCount(t,r=1,n){this.recordMetric(t,r,"Count",n)}recordDuration(t,r,n){this.recordMetric(t,r,"Milliseconds",n)}recordSize(t,r,n){this.recordMetric(t,r,"Bytes",n)}recordRate(t,r,n){this.recordMetric(t,r,"Percent",n)}startTimer(t,r){let n=`${t}-${Date.now()}-${Math.random()}`;return this.activeTimers.set(n,{name:t,startTime:Date.now(),dimensions:r}),n}stopTimer(t){let r=this.activeTimers.get(t);if(!r)return a.warn("Attempted to stop non-existent timer",{timerId:t}),null;let n=Date.now()-r.startTime;return this.recordDuration(r.name,n,r.dimensions),this.activeTimers.delete(t),n}recordMetric(t,r,n,o){let i={name:t,value:r,unit:n,timestamp:new Date,dimensions:o};this.metrics.push(i),a.info("Metric recorded",{metric:{name:i.name,value:i.value,unit:i.unit,dimensions:i.dimensions}}),process.env.NODE_ENV==="production"&&this.publishToCloudWatch(i)}async publishToCloudWatch(t){let{publishMetric:r}=await Promise.resolve().then(()=>(me(),de));await r({name:t.name,value:t.value,unit:t.unit,dimensions:t.dimensions,timestamp:t.timestamp})}getMetrics(){return[...this.metrics]}clearMetrics(){this.metrics=[]}},p=new F;var P=class{requestCount=0;errorCount=0;successCount=0;incrementRequest(t){this.requestCount++,p.recordCount("RequestCount",1,{endpoint:t})}incrementError(t,r){this.errorCount++,p.recordCount("ErrorCount",1,{endpoint:t,errorType:r||"Unknown"})}incrementSuccess(t){this.successCount++,p.recordCount("SuccessCount",1,{endpoint:t})}getErrorRate(){return this.requestCount===0?0:this.errorCount/this.requestCount*100}recordErrorRate(t){let r=this.getErrorRate();p.recordRate("ErrorRate",r,{endpoint:t})}};var pe=require("crypto"),$=new P;async function ze(e){let t=e.requestContext?.requestId||(0,pe.randomUUID)();a.setCorrelationId(t),a.setFunctionName("UploadFunction");let r=p.startTimer("UploadFunctionDuration",{function:"upload"});try{a.info("Upload function invoked",{correlationId:t}),$.incrementRequest("upload");let n={file:e.file,filename:e.filename,agentId:e.agentId};n.file&&p.recordSize("UploadFileSize",n.file.length,{function:"upload"});let o=await ue(n);return a.info("Upload completed successfully",{jobId:o.jobId,correlationId:t}),$.incrementSuccess("upload"),p.stopTimer(r),{statusCode:200,body:JSON.stringify(o)}}catch(n){a.error("Upload handler error",{error:n,correlationId:t});let o=n.code||"UnknownError";$.incrementError("upload",o),p.recordCount("UploadError",1,{function:"upload",errorType:o}),p.stopTimer(r);let i=ce(n),s=500;if("code"in n){let u=n.code;(u==="FILE_TOO_LARGE"||u==="INVALID_PDF")&&(s=400)}return{statusCode:s,body:JSON.stringify(i)}}}0&&(module.exports={uploadHandler});
//# sourceMappingURL=upload.js.map
